<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
      <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LegendCalc">
    <meta name="theme-color" content="#0b1a12" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#f6f5ef" media="(prefers-color-scheme: light)">
<title>LegendCalc Suite (Math + Time Clock) — Unzipped</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.cdnfonts.com/css/ringbearer" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1115;--card:#161a22;--screen:#0b0e13;--ink:#f3f6ff;--muted:#97a3b6;--accent:#5bd38e;--accent-2:#2b78e4;
      --key:#222836;--key-op:#2b3144;--key-fn:#1e2433;--key-eq:#2b78e4;--ring:#fbe62c;--error:#ff6b6b;--ok:#5bd38e;
      --radius:16px;--shadow:0 20px 60px #0005;
      --tab-bg:#1a2030; --tab-fg:#9db0d0; --tab-active-bg:#2b78e4; --tab-active-fg:#fff;
      --control-bg:#0e131c; --control-bd:#263046;
    
      --panel:var(--card);
      --border:var(--control-bd);
      --toast-bg:#0b1410;
      --toast-fg:#eafff3;
    }
    /* Light theme: higher contrast fixes */
    .theme-light{
      --bg:#f7f9ff; --card:#ffffff; --screen:#eef3ff; --ink:#0b1020; --muted:#49556c;
      --accent:#205fbe; --accent-2:#205fbe;

      --key:#f0f4ff;
      --key-op:#e8eefc;
      --key-fn:#e6f0ff;
      --key-eq:#205fbe;

      --tab-bg:#e7eefc; --tab-fg:#1a3358; --tab-active-bg:#205fbe; --tab-active-fg:#ffffff;
      --control-bg:#ffffff; --control-bd:#c9d7ef;
    
      --toast-bg:var(--card);
      --toast-fg:var(--ink);
    }
    /* TI-Nspire themed (tighter contrast + LCD vibe) */
    .theme-inspire{
      --bg:#14171b; --card:#0c0f12; --screen:#081017; --ink:#e8f2ff; --muted:#a7bad1;
      --accent:#00e38f; --accent-2:#00a2ff;
      --key:#0e141b; --key-op:#141b23; --key-fn:#0b1218; --key-eq:#00a2ff;
      --tab-bg:#0d1622; --tab-fg:#c1d2e6; --tab-active-bg:#00a2ff; --tab-active-fg:#ffffff;
      --control-bg:#0f141a; --control-bd:#2c3c4c;
    
      --toast-bg:var(--card);
      --toast-fg:var(--ink);
    }

    *{box-sizing:border-box}
    html,html,body{height:auto;min-height:100%;overflow-x:hidden}
    body{min-height:100vh}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#0e121a);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:14px;gap:12px;flex-wrap:wrap}
    h1{font-family:Ringbearer,Inter,serif;letter-spacing:1px;font-size:1.8rem;margin:0;color:var(--accent)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:0;background:var(--tab-bg);color:var(--tab-fg);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800}
    .tab.active{background:var(--tab-active-bg);color:var(--tab-active-fg)}
    .surface{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px}

    .theme-picker{display:flex;align-items:center;gap:8px;margin-left:auto;padding-top:4px}
    .theme-select{background:var(--control-bg);border:1.5px solid var(--control-bd);border-radius:12px;color:var(--ink);padding:10px;font-size:0.95rem;min-height:44px}

    .calc-grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media (max-width:900px){.calc-grid{grid-template-columns:1fr}}
    .screen{background:linear-gradient(180deg,var(--screen),#0a0d12);border:1px solid #1e2533;border-radius:16px;padding:14px;min-height:130px;position:relative;overflow:hidden}
    .expr{color:#9db0d0;min-height:24px}
    .result{font-size:2.2rem;font-weight:800;word-break:break-all}
    .keys{display:grid;grid-template-columns:repeat(6,minmax(60px,1fr));gap:8px;margin-top:12px}
    .key{border:1px solid transparent;border-radius:14px;padding:14px 10px;background:var(--key);color:#eaf0ff;font-weight:800;cursor:pointer;box-shadow:inset 0 -2px 0 #0008}
    .key.op{background:var(--key-op)}
    .key.fn{background:var(--key-fn)}
    .key.eq{background:var(--key-eq)}
    .key:active{transform:translateY(1px)}
    .span2{grid-column:span 2}
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    .input, select, textarea{background:var(--control-bg);border:1.5px solid var(--control-bd);border-radius:12px;color:var(--ink);padding:10px;font-size:1rem}
    .btn{border:1px solid var(--control-bd);background:#22304a;color:#cfe0ff;font-weight:800;border-radius:12px;padding:10px 14px;cursor:pointer;min-height:44px}
    .btn.primary{background:var(--accent-2);color:#fff;border-color:#0b5fb8}

    /* Light theme button label contrast fix */
    .theme-light .key{ color:#0b1020; border-color:#d6e3fb; box-shadow:inset 0 -2px 0 #c9d7ef; }
    .theme-light .btn{ background:#eaf1ff; color:#0b1020; border-color:#c9d7ef; }
    .theme-light .result{ color:#0b1020; }
    .theme-light .expr{ color:#2f4466; }

    .tape{min-height:240px;max-height:60vh;overflow:auto;resize:vertical;padding-right:4px}
    .trow{display:flex;justify-content:space-between;gap:10px;padding:8px;border-bottom:1px dashed #25304a;font-size:.95rem}
    .theme-light .trow{ border-bottom-color:#d6e3fb; }
    .trow .l{color:#9db0d0}
    .theme-light .trow .l{ color:#5574a6; }

    .section-title{margin:8px 0 10px;color:#9bd3ff}
    .theme-light .section-title{ color:#205fbe; }
    .note{color:var(--muted);font-size:.9rem}

    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.two-col{grid-template-columns:1fr}}

    .chart{width:100%;height:380px;min-height:320px;height:380px;width:100%;}

    .ok{color:var(--ok)} .err{color:var(--error)}
    .tests{margin-top:12px;font-size:.9rem}
    .tests .pass{color:#5bd38e}
    .tests .fail{color:#ff6b6b}

    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #223046;text-align:left}
    th{color:#9bd3ff}
    .theme-light th{ color:#205fbe; }
    .theme-light td{ border-bottom-color:#d6e3fb; }

    
    #diag.ok{display:block;background:#0f2a1c;color:#c6ffdf;border:1px solid #31c27c}
    #diag.warn{display:block;background:#2a2a0f;color:#f8ffb3;border:1px solid #f5e160}
    #diag.err{display:block;background:#3b1116;color:#ffd5d5;border:1px solid #ff6b6b}

    /* TI-Nspire vibe: LCD grid and beveled keys (stronger contrast) */
    .theme-inspire .screen{
      background:linear-gradient(180deg,#0b1016,#090e14);
      border:1px solid #23303b;
      box-shadow:inset 0 1px 0 #2b3f50, inset 0 -1px 0 #070a0e;
    }
    .theme-inspire .screen::before{
      content:"";
      position:absolute; inset:0;
      background-image:
        linear-gradient(#1f2a34 1px, transparent 1px),
        linear-gradient(90deg,#1f2a34 1px, transparent 1px);
      background-size: 22px 22px, 22px 22px;
      opacity:.22; pointer-events:none;
    }
    .theme-inspire .key{
      background:#0f141a; border:1px solid #253342; border-radius:10px; color:#e7f5ff;
      box-shadow:inset 0 -2px 0 #0008, 0 1px 0 #0a0d10;
    }
    .theme-inspire .key.op{ background:#121923; }
    .theme-inspire .key.fn{ background:#0d141c; }
    .theme-inspire .key.eq{
      background:#00a2ff; border-color:#0b5fb8; color:#fff;
      box-shadow:inset 0 -2px 0 #064b91, 0 1px 0 #0a0d10;
    }
    .theme-inspire .key:active{ transform:none; box-shadow:inset 0 2px 0 #0006; }

    /* Focus rings per theme */
    .theme-light :is(.btn,.key,.input,select,textarea,.tab):focus-visible{ outline:2px solid #205fbe; outline-offset:2px; }
    .theme-inspire :is(.btn,.key,.input,select,textarea,.tab):focus-visible{ outline:2px solid #00e38f; outline-offset:2px; }
    :root :is(.btn,.key,.input,select,textarea,.tab):focus-visible{ outline:2px solid #5bd38e; outline-offset:2px; }
  
/* ---------- Mobile + touch improvements (safe for desktop) ---------- */
:root{
  --safe-top: env(safe-area-inset-top);
  --safe-right: env(safe-area-inset-right);
  --safe-bottom: env(safe-area-inset-bottom);
  --safe-left: env(safe-area-inset-left);
}

*{
  -webkit-tap-highlight-color: transparent;
}

button{
  touch-action: manipulation;
}

@media (max-width: 520px){
  /* keep content inside safe areas */
  body{
    padding: calc(10px + var(--safe-top)) calc(10px + var(--safe-right))
             calc(12px + var(--safe-bottom)) calc(10px + var(--safe-left));
    font-size: 16px;
  }

  /* header stacks cleanly */
  header{
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }

  /* tabs: big tap targets + horizontal scroll (prevents overlap) */
  .tabs{
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 2px;
    display: flex;
    flex-wrap: nowrap;
    gap: 10px;
  }
  .tab{
    flex: 0 0 auto;
    text-align: center;
    padding: 12px 14px;
    border-radius: 14px;
    min-height: 48px;
    font-size: 0.95rem;
    letter-spacing: 0.01em;
    white-space: nowrap;
  }

  .theme-picker{
    width: 100%;
    justify-content: space-between;
  }
  .theme-select{
    width: min(220px, 55vw);
  }

  /* general tap targets */
  button{
    min-height: 52px;
    font-size: 1.05rem;
    border-radius: 14px;
  }

  /* single-column forms (prevents squeezed/overlapping rows) */
  .row{
    grid-template-columns: 1fr;
  }

  /* button bars stack cleanly */
  .btnbar{
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .btnbar > button{
    flex: 1 1 calc(50% - 10px);
    min-width: 0;
  }
  @media (max-width: 360px){
    .btnbar > button{ flex-basis: 100%; }
  }

  /* graph canvas height fits phone */
  .chart{ height: 320px; }
}



@supports (height: 100dvh){
  body{ min-height: 100dvh; }
}



/* ---------- iPhone polish pack (safe for desktop) ---------- */
/* Auto light/dark */
@media (prefers-color-scheme: dark){
  :root{
    --bg: #0b1a12;
    --fg: #e9f0ea;
    --card: rgba(255,255,255,0.06);
    --card2: rgba(255,255,255,0.10);
    --shadow: rgba(0,0,0,0.35);
  }
  body{ background: var(--bg); color: var(--fg); }
  .panel, .card, .calc, #app, .container{
    background: var(--card);
    box-shadow: 0 10px 30px var(--shadow);
  }
}

@media (prefers-color-scheme: light){
  :root{
    --bg: #f6f5ef;
    --fg: #0b1a12;
    --card: rgba(0,0,0,0.05);
    --card2: rgba(0,0,0,0.08);
    --shadow: rgba(0,0,0,0.12);
  }
  body{ background: var(--bg); color: var(--fg); }
  .panel, .card, .calc, #app, .container{
    background: rgba(255,255,255,0.75);
    box-shadow: 0 10px 30px var(--shadow);
  }
}

/* Thumb-friendly spacing (right-hand bias) */
@media (max-width: 520px){
  /* If you're using a grid wrapper for keys, widen the right side slightly */
  .keys, .grid, .pad{
    padding-right: 10px;
    padding-left: 4px;
  }

  /* Make operator keys stand out slightly without forcing colors */
  .op, .operator, [data-op="true"]{
    font-weight: 700;
  }

  /* Prevent text selection while tapping */
  body, button{
    -webkit-user-select: none;
    user-select: none;
  }
}

/* Standalone (Add to Home Screen) better spacing */
@media (display-mode: standalone){
  body{ padding-top: calc(14px + var(--safe-top)); }
}


/* ---------- v1.3.5 Mobile layout upgrade (keeps desktop the same) ---------- */
.titleline{display:flex;align-items:baseline;gap:10px;flex-wrap:wrap}
.ver{font-size:.85rem;font-weight:800;opacity:1;color:var(--muted);white-space:nowrap}
@media (max-width: 900px){
  .wrap{margin:0 auto; padding: 0 12px}
}
@media (max-width: 520px){
  .wrap{max-width:100%; margin:0; padding:0 10px}
  header{flex-direction:column; align-items:stretch; gap:10px}
  .titleline{justify-content:center}
  h1{font-size:1.45rem; text-align:center}
  .ver{justify-self:center}

  /* Tabs become a horizontal scroll strip so they don't squash */
  .tabs{overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:2px; justify-content:flex-start; flex-wrap:nowrap}
  .tab{white-space:nowrap}

  /* Calculator card uses screen space better */
  .calc{grid-template-columns:1fr !important}
  .screen{min-height:120px}
  .result{font-size:clamp(1.6rem, 7vw, 2.4rem)}

  /* Keypad: 4 columns on phones (fits Pro Max nicely) */
  .keys{grid-template-columns:repeat(4, minmax(0,1fr)); gap:10px}
  .key{padding:16px 10px; border-radius:16px; min-height:54px}

  /* Reduce wasted vertical space */
  main{margin-top:8px}
}

/* Slightly wider phones (e.g., Pro Max landscape) */
@media (max-width: 820px) and (orientation: landscape){
  .wrap{padding:0 12px}
  .keys{grid-template-columns:repeat(6, minmax(0,1fr))}
}

/* v1.3.1: full-width equals on phones */
.span4{grid-column: span 4;}

    .dbg-mini{border:1px solid var(--border);background:transparent;color:var(--muted);padding:8px 10px;border-radius:12px;font-weight:900;cursor:pointer;min-height:44px}
    .dbg-mini:hover{background:rgba(255,255,255,.05)}
    .dbg-panel{position:fixed;inset:0;display:none;background:rgba(0,0,0,.55);z-index:9999}
    .dbg-panel .card{position:absolute;left:12px;right:12px;bottom:12px;max-height:60vh;background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:12px;box-shadow:0 20px 60px rgba(0,0,0,.5);display:flex;flex-direction:column;gap:10px}
    .gear-mini{border:0;background:transparent;color:var(--muted);font-weight:900;cursor:pointer;padding:8px 10px;border-radius:12px;min-height:44px}
    .gear-mini:hover{background:rgba(255,255,255,.06)}
    .dbg-mini{border:0;background:transparent;color:var(--muted);font-weight:900;cursor:pointer;padding:8px 10px;border-radius:12px}
    .dbg-mini:hover{background:rgba(255,255,255,.06)}

    /* Debug log readability */
    #dbgLog{background:var(--screen);border:1px solid var(--border);border-radius:14px;padding:10px;white-space:pre-wrap;overflow:auto;color:var(--ink);font-size:.9rem;line-height:1.25;max-height:48vh}

    /* Settings drawer */
    .settings-drawer{position:fixed;inset:0;display:none;background:rgba(0,0,0,.55);z-index:9998}
    .settings-drawer .sheet{position:absolute;right:12px;top:12px;bottom:12px;width:min(420px, calc(100vw - 24px));background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:12px;box-shadow:0 20px 60px rgba(0,0,0,.5);display:flex;flex-direction:column;gap:12px}
    .sheet-top{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .sheet-title{font-weight:900;font-size:1.05rem}
    .set-row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.03)}
    .set-label{font-weight:900}
    .set-sub{font-size:.85rem;color:var(--muted);margin-top:2px}
    .switch{position:relative;display:inline-block;width:46px;height:26px}
    .switch input{display:none}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#2a3346;border-radius:999px;opacity:1;transition:background .18s ease}
    .slider:before{content:"";position:absolute;height:20px;width:20px;left:3px;top:3px;background:white;border-radius:999px;opacity:.8}
    .switch input:checked + .slider{background:var(--accent)}
    .switch input:checked + .slider:before{transform:translateX(20px)}


    /* Diagnostics pill */
    #diag{pointer-events:none;display:none;margin:10px 0;padding:8px 10px;border-radius:999px;font-weight:800;font-size:.9rem;line-height:1.1;align-items:center;gap:10px}
    #diag.ok{background:rgba(91,211,142,.14);border:1px solid rgba(91,211,142,.35);color:var(--ink)}
    #diag.err{background:rgba(255,107,107,.12);border:1px solid rgba(255,107,107,.35);color:var(--ink)}
    #diag .diag-msg{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer}
    #diag .diag-x{border:0;background:transparent;color:var(--muted);font-size:1.1rem;font-weight:900;cursor:pointer;padding:2px 6px;border-radius:10px}
    #diag .diag-x:hover{background:rgba(255,255,255,.08)}
    #diag.expanded{border-radius:16px}
    #diag.expanded .diag-msg{white-space:normal;overflow:visible}

    /* Toast colors */
    
    @media (max-width:520px){
      #diag{pointer-events:none;position:fixed;left:10px;right:10px;bottom:64px;margin:0;z-index:2000}
      .settings-drawer .sheet{left:12px;right:12px;width:auto}
    }

    .dbg-panel .top{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .dbg-panel pre{margin:0;white-space:pre-wrap;word-break:break-word;overflow:auto;background:rgba(0,0,0,.18);border:1px solid var(--border);border-radius:14px;padding:10px;flex:1}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;z-index:9998;display:none;background:rgba(10,20,15,.92);border:1px solid var(--border);padding:10px 12px;border-radius:14px;color:var(--fg);font-weight:800;max-width:min(92vw,520px)}


    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:rgba(255,255,255,.03);padding:10px 12px;border-radius:999px;font-weight:900;cursor:pointer}
    .pill input{accent-color: var(--accent);}

    /* Big UI + One-hand mode (mobile-first only; desktop untouched) */
    @media (max-width:520px){
      .bigui .tab-btn{padding:14px 16px;font-size:1.02rem}
      .bigui .btn{padding:14px 16px;font-size:1.02rem}
      .bigui input,.bigui select,.bigui textarea{font-size:1.05rem}
      .bigui .key{padding:16px 12px}
      .onehand-left .keys{padding-right:24px}
      .onehand-right .keys{padding-left:24px}
    }

/* v1.4.36 mobile polish: keep tab strip fully visible */
@media (max-width: 520px){
  .tabs{gap:6px;padding-right:calc(12px + env(safe-area-inset-right));}
  .tab{padding:9px 10px;font-size:.86rem;min-width:unset}
  .titleline{gap:8px}
}


/* v1.4.36 mobile spacing system + tab scroll hint */
:root{ --m-pad:12px; --m-gap:10px; }
@media (max-width: 520px){
  /* tighten general vertical rhythm */
  .wrap{padding:var(--m-pad);}
  .card{padding:12px;}
  .grid{gap:var(--m-gap);}
  .row{gap:8px;}
  .btnbar{gap:8px;}
  /* keep sections from double-padding */
  .card .card{padding:10px;}
  /* tab strip hint */
  .tabswrap{position:relative;}
  .tabswrap::after{
    content:"";
    position:absolute; top:0; right:0; height:100%; width:26px;
    pointer-events:none;
    background:linear-gradient(to right, rgba(0,0,0,0), var(--bg, #0b0f12));
    opacity:.9;
  }
  .tabs{padding-right:calc(30px + env(safe-area-inset-right));}
}


@media (max-width: 520px){
  #historyBox, .historyBox, .tape{
    min-height: 180px;
    max-height: 60vh;
    height: auto;
    resize: vertical;
    overflow: auto;
  }
}


/* v1.4.36 mobile tap-target normalization */
@media (max-width: 520px){
  /* minimum Apple-friendly tap size */
  button, .btn, .key, .tab, a.btnlike,
  input[type="button"], input[type="submit"]{
    min-height:44px;
    padding:10px 12px;
    line-height:1.1;
  }
  /* form controls */
  input, select, textarea{
    min-height:44px;
    padding:10px 12px;
    font-size:16px; /* prevent iOS zoom */
  }
  /* small icon buttons (DBG, Gear, etc.) keep 44px hitbox but smaller visual */
  .iconbtn{
    min-width:44px;
    min-height:44px;
    padding:8px;
  }
  /* button rows wrap cleanly */
  .btnbar, .rowbtns{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .btnbar > *, .rowbtns > *{
    flex:1 1 auto;
  }
  /* tighter but readable small labels */
  .muted, .subtle, .hint{font-size:.9rem;}
}


/* v1.4.36 TI-Nspire theme readability tweak */
body.theme-ti, body.ti, .theme-ti{
  --muted: rgba(255,255,255,.78);
  --hint: rgba(255,255,255,.72);
}
body.theme-ti .muted, body.ti .muted, .theme-ti .muted{color:var(--muted) !important;}
body.theme-ti .note, body.ti .note, .theme-ti .note{color:rgba(255,255,255,.86);}
body.theme-ti .ver, body.ti .ver, .theme-ti .ver{color:rgba(255,255,255,.88) !important;}


/* v1.4.36 TI theme: make GraphLab overlay pills readable (ice-blue) */
body.theme-ti .pill, body.ti .pill, .theme-ti .pill{
  color: rgba(140,200,255,0.95) !important;
}
body.theme-ti .pill input, body.ti .pill input, .theme-ti .pill input{
  accent-color: rgba(140,200,255,0.95);
}


/* v1.4.36 TI-Nspire theme: make GraphLab overlay pills readable (ice-blue) */
.theme-inspire .pill, body.theme-inspire .pill{
  color: rgba(140,200,255,0.95) !important;
}
.theme-inspire .pill input, body.theme-inspire .pill input{
  accent-color: rgba(140,200,255,0.95);
}


/* v1.4.36 mobile scroll sanity */
main{padding-bottom:calc(18px + env(safe-area-inset-bottom));}
@media (max-width:520px){
  body{overscroll-behavior-y:none;}
}


.diag{pointer-events:none;position:fixed;left:12px;right:12px;bottom:12px;z-index:9999;max-height:42px;overflow:hidden;}

/* GraphLab Function List */
.fxlist{display:flex;flex-direction:column;gap:8px;margin:10px 0;}
.fxrow{display:grid;grid-template-columns:28px 1fr 34px;gap:8px;align-items:center;padding:8px;border:1px solid rgba(255,255,255,.12);border-radius:12px;}
.fxrow input[type="text"]{width:100%;padding:10px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);color:inherit;}
.fxswatch{width:18px;height:18px;border-radius:6px;box-shadow:0 0 0 1px rgba(255,255,255,.18) inset;}
.fxdel{width:34px;height:34px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.12);color:inherit;;min-height:44px}
.fxhdr{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:8px;}
.fxhdr .btn{padding:8px 10px;}


/* GraphLab layout grid */
.glgrid{display:grid;grid-template-columns:1fr;gap:14px;}
@media (min-width: 980px){
  .glgrid{grid-template-columns:420px 1fr;align-items:start;}
}
.gll{min-width:0;}
.glr{min-width:0;}
.glr .chart{height:520px;min-height:520px;}
@media (max-width: 520px){
  .glr .chart{height:340px;min-height:340px;}
}


/* GraphLab legend overlay */
.chartwrap{position:relative;}
.glegend{position:absolute;top:10px;left:10px;max-width:70%;
  padding:8px 10px;border-radius:12px;
  background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.14);
  backdrop-filter: blur(6px);
  font-size:12px;line-height:1.2;
  display:flex;flex-direction:column;gap:6px;
  pointer-events:none;
}
.glegend .li{display:flex;align-items:center;gap:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.glegend .dot{width:10px;height:10px;border-radius:4px;flex:0 0 auto;box-shadow:0 0 0 1px rgba(255,255,255,.25) inset;}


/* GraphLab eye toggle */
.eyeBtn{
  cursor:pointer;
  font-size:16px;
  padding:4px 6px;
  border-radius:8px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
}
.eyeBtn.off{opacity:.35;}


/* Force-hide fxrow checkbox */
.fxrow input[type="checkbox"]{display:none !important;}


/* GraphLab controls drawer */
.graphlab-grid{display:grid;gap:14px;}
.graphlab-controls{min-width:0;}
.graphlab-plot{min-width:0;}
@media (min-width: 980px){
  .graphlab-grid{grid-template-columns: 360px 1fr; align-items:start;}
  body.gl-hide-controls .graphlab-grid{grid-template-columns: 0 1fr;}
  body.gl-hide-controls .graphlab-controls{display:none;}
}
.glCtlBtn{
  padding:8px 10px;border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.12);
  color:inherit;
}
.glCtlBtn:active{transform:scale(.98);}


.hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0;}
</style>
    <link rel="manifest" href="data:application/manifest+json,{"name":"LegendCalc","short_name":"LegendCalc","start_url":".","display":"standalone","background_color":"#0b1a12","theme_color":"#0b1a12","icons":[]}">
</head>
<body>
  <div class="wrap">
    <header>
      <div class="titleline"><h1>LegendCalc Suite</h1><span class="ver" id="verTag">v1.4.47 • 2026-02-20</span></div>
      <div class="tabswrap"><div class="tabs">
        <button class="tab active" data-tab="calc">Calc</button>
        <button class="tab" data-tab="graphlab">GraphLab</button>
        <button class="tab" data-tab="units">Units</button>
        <button class="tab" data-tab="time">Time</button>
        <button class="tab" data-tab="sound">Sound</button>
        <button class="tab" data-tab="torque">Torque</button>
</div>
      <div class="theme-picker">
        <span class="note">Theme</span>
        <select id="themeSel" class="theme-select">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
          <option value="inspire">TI-Inspire</option>
        </select>
        <button class="dbg-mini" id="dbgBtn" title="Debug">DBG</button>
        <button class="gear-mini" id="gearBtn" title="Settings" aria-label="Settings">⚙</button>
      </div>
    </header>
    <div id="diag" class="ok">Loading…</div>
    <main id="view"></main>

    

    <div class="settings-drawer" id="settingsDrawer" aria-hidden="true">
      <div class="sheet" role="dialog" aria-label="Settings">
        <div class="sheet-top">
          <div class="sheet-title">Settings</div>
          <button class="btn" id="setClose">Close</button>
        </div>

        <div class="set-row">
          <div>
            <div class="set-label">Sound</div>
            <div class="set-sub">Applies across all tabs</div>
          </div>
          <select id="setSound" class="theme-select">
            <option value="off">Off</option>
            <option value="clicks">Clicks</option>
            <option value="fanfare">Fanfare</option>
          </select>
        </div>

        <div class="set-row">
          <div>
            <div class="set-label">Big UI</div>
            <div class="set-sub">Larger tap targets</div>
          </div>
          <label class="switch"><input type="checkbox" id="setBigUI"><span class="slider"></span></label>
        </div>

        <div class="set-row">
          <div>
            <div class="set-label">One-hand mode</div>
            <div class="set-sub">Left/right reach</div>
          </div>
          <select id="setOneHand" class="theme-select">
            <option value="right">Right</option>
            <option value="left">Left</option>
          </select>
        </div>

        <div class="set-row" style="justify-content:flex-end">
          <button class="btn" id="setTestClick">Test Click</button>
          <button class="btn" id="setTestFanfare">Test Fanfare</button>
        </div>
      </div>
    </div>

<div class="dbg-panel" id="dbgPanel" aria-hidden="true">
      <div class="card" role="dialog" aria-label="Debug panel">
        <div class="top">
          <div style="font-weight:900">Debug</div>
          <div style="display:flex;gap:8px">
            <button class="btn" id="dbgCopy">Copy</button>
            <button class="btn" id="dbgClose">Close</button>
          </div>
        </div>
        <pre id="dbgLog">(no errors yet)</pre>
      </div>
    </div>
    <div class="toast" id="toast"></div>

    <div id="selfTests" class="tests"></div>
  </div>

  <script>
  // Prefer local libs in ./libs, fallback to CDN, then start app
  (function(){
    const DI = document.getElementById('diag');
    const note=(cls,msg,full)=>{
        DI.className=cls;
        DI.dataset.full = full || msg;
        DI.classList.remove('expanded');
        DI.innerHTML = `<span class="diag-msg">${msg}</span><button class="diag-x" aria-label="Close">×</button>`;
        DI.style.display='flex';
        if(cls==='ok'){ clearTimeout(note._t); note._t=setTimeout(()=>{ if(!DI.classList.contains('expanded')) DI.style.display='none'; }, 2500); }
      };

    DI.addEventListener('click',(e)=>{
        if(e.target && e.target.classList.contains('diag-x')){ DI.style.display='none'; return; }
        if(e.target && e.target.classList.contains('diag-msg')){ DI.classList.toggle('expanded'); // expansion disabled
        if(false && DI.classList.contains('expanded')) DI.querySelector('.diag-msg').textContent = DI.dataset.full; else DI.querySelector('.diag-msg').textContent = DI.dataset.full.length>42 ? (DI.dataset.full.slice(0,42)+'…') : DI.dataset.full; }
      });

    const libs=[
      {global:'math', local:'./libs/math.min.js', cdn:'https://cdn.jsdelivr.net/npm/mathjs@12.4.2/lib/browser/math.js', name:'math.js'},
      {global:'Plotly', local:'./libs/plotly.min.js', cdn:'https://cdn.plot.ly/plotly-2.35.2.min.js', name:'Plotly'}
    ];
    function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=()=>rej(new Error('load failed: '+src)); document.head.appendChild(s); }); }

    (async function ensureLibs(){
      try{
        for(const L of libs){
          if(!(L.global in window)){
            try{ await loadScript(L.local); if(!(L.global in window)) throw new Error('local missing'); }
            catch(eLocal){ await loadScript(L.cdn); }
          }
        }
        // libs loaded — keep the loader banner hidden (show only on error)
        try{ DI.style.display='none'; }catch(_){ }

        startApp();
      }catch(e){
        console.error(e);
        note('err','Libs failed','Could not load libraries. If offline, put math.min.js and plotly.min.js in ./libs, or allow CDN.');
      }
    })();

    function startApp(){
    window.window.GL_PALETTE = window.window.GL_PALETTE || ['#7fd6ff','#38d996','#ffd166','#ff5c5c','#b98bff'];

    window.onerror = function(msg, src, line, col, err){
      try{ dbgAdd('ERROR', String(msg||'Error') + (line?(' @'+line+':'+col):'')); }catch(_){ }
      return false;
    };

    try{
      const sd=document.getElementById('settingsDrawer'); if(sd){ sd.style.display='none'; sd.setAttribute('aria-hidden','true'); }
      const dp=document.getElementById('dbgPanel'); if(dp){ dp.style.display='none'; dp.setAttribute('aria-hidden','true'); }
    }catch(_){ }

      /* ---------- Utils & persistence ---------- */
      const $ = (s, r=document)=> r.querySelector(s);
      const $$ = (s, r=document)=> [...r.querySelectorAll(s)];


      // Utility: generate n points from a..b (used by GraphLab)
      function linspace(a,b,n){
        n = Math.max(2, (n|0)||2);
        const out = new Array(n);
        const step = (b-a)/(n-1);
        for(let i=0;i<n;i++) out[i]=a + step*i;
        return out;
      }
      window.linspace = linspace;

      // GraphLab deps helpers (scoped) — used by GraphLab event handlers
      function graphLibsReady(){
        return (window.math && typeof window.math.parse==='function' && window.Plotly && typeof window.Plotly.newPlot==='function');
      }
      let glPlotTimer=null;
function schedulePlot(ms=220){
  try{ if(glPlotTimer) clearTimeout(glPlotTimer); }catch(_){ }
  glPlotTimer=setTimeout(()=>{ try{ doPlot(); }catch(e){ try{ logErr(e); }catch(_){ } } }, ms);
}

function waitForGraphLibs(cb, tries=40){
        if(graphLibsReady()) return cb();
        let n=0;
        const iv=setInterval(()=>{
          n++;
          if(graphLibsReady()){ clearInterval(iv); cb(); }
          else if(n>=tries){ clearInterval(iv); toast('GraphLab: libs not ready'); dbgAdd('ERROR','GraphLab libs not ready (math/Plotly)'); }
        }, 125);
      }
      window.waitForGraphLibs = waitForGraphLibs;
      window.graphLibsReady = graphLibsReady;


      const esc = s=>String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
      const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));

      function saveTab(name, obj){ try{ localStorage.setItem('legendcalc_'+name, JSON.stringify(obj)); }catch(e){} }
      function loadTab(name, def){ try{ const v=localStorage.getItem('legendcalc_'+name); return v? JSON.parse(v): def; }catch(e){ return def; } }
      function clearTab(name){ try{ localStorage.removeItem('legendcalc_'+name); }catch(e){} }

      const PREFS_KEY='legendcalc_prefs';
      function loadPrefs(){ try{ return JSON.parse(localStorage.getItem(PREFS_KEY)||'{}'); }catch(e){ return {}; } }
      function savePrefs(p){ localStorage.setItem(PREFS_KEY, JSON.stringify(p)); }

      /* ---------- Toast ---------- */
      function toast(msg){
        const el=$('#toast');
        if(!el) return;
        el.textContent=msg;
        el.style.display='block';
        clearTimeout(toast._t);
        toast._t=setTimeout(()=>{el.style.display='none';}, 1600);
      }

      /* ---------- Debug capture ---------- */
      const DBG=[];
      function dbgLine(level, msg){
        const t=new Date();
        const stamp=t.toLocaleTimeString();
        DBG.push(`[${stamp}] ${level}: ${msg}`);
        if(DBG.length>200) DBG.shift();
        const pre=$('#dbgLog');
        if(pre) pre.textContent = DBG.join('\n') || '(no errors yet)';
      }
      
      // v1.4.36: helper so plotting code can report errors without crashing
      function logErr(err){
        try{
          const msg = (err && (err.stack || err.message)) ? String(err.stack || err.message) : String(err);
          dbgLine('ERROR', msg);
        }catch(_){
          dbgLine('ERROR', 'Unknown error');
        }
      }

window.addEventListener('error', (e)=>{ dbgLine('ERROR', (e.message||'') + (e.filename?` @ ${e.filename}:${e.lineno}`:'')); });
      window.addEventListener('unhandledrejection', (e)=>{ dbgLine('PROMISE', (e.reason && (e.reason.message||String(e.reason))) || 'unhandled rejection'); });

      function initDebugUI(){
        const btn=$('#dbgBtn'), panel=$('#dbgPanel'), close=$('#dbgClose'), copy=$('#dbgCopy');
        if(!btn || !panel) return;
        const open=()=>{ panel.style.display='block'; panel.setAttribute('aria-hidden','false'); dbgLine('INFO','Debug opened'); };
        const shut=()=>{ panel.style.display='none'; panel.setAttribute('aria-hidden','true'); };
        btn.addEventListener('click', open);
        panel.addEventListener('click', (e)=>{ if(e.target===panel) shut(); });
        close && close.addEventListener('click', shut);
        copy && copy.addEventListener('click', async ()=>{
          const text = (DBG && DBG.length) ? DBG.join('\n') : '(no errors yet)';
          try{ await navigator.clipboard.writeText(text); toast('Debug log copied'); }
          catch(_){
            try{
              const ta=document.createElement('textarea');
              ta.value=text; document.body.appendChild(ta);
              ta.select(); document.execCommand('copy');
              document.body.removeChild(ta);
              toast('Debug log copied');
            }catch(__){ toast('Copy failed'); }
          }
          // visually select the log so it feels like a real copy
          const pre=$('#dbgLog');
          if(pre){
            const r=document.createRange(); r.selectNodeContents(pre);
            const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(r);
            setTimeout(()=>{ try{ sel.removeAllRanges(); }catch(_){} }, 900);
          }
        });
      }

      
      function initSettingsUI(){
        const gear=$('#gearBtn'), drawer=$('#settingsDrawer'), close=$('#setClose');
        if(!gear || !drawer) return;
        const open=()=>{ drawer.style.display='block'; drawer.setAttribute('aria-hidden','false'); syncSettingsUI(); };
        const shut=()=>{ drawer.style.display='none'; drawer.setAttribute('aria-hidden','true'); };
        gear.addEventListener('click', open);
        drawer.addEventListener('click',(e)=>{ if(e.target===drawer) shut(); });
        close && close.addEventListener('click', shut);

        const sel=$('#setSound');
        sel && sel.addEventListener('change', ()=>{ setSoundMode(sel.value); syncSettingsUI(); });

        const big=$('#setBigUI');
        big && big.addEventListener('change', ()=>{ setBigUI(big.checked); });

        const oh=$('#setOneHand');
        oh && oh.addEventListener('change', ()=>{ setOneHand(oh.value); });

        const tClick=$('#setTestClick');
        tClick && tClick.addEventListener('click', ()=>{
          try{ ensureAudio(); beep(220, 0.05, 'square', 0.02, 0); toast('Test: Click'); }catch(_){}
        });
        const tFan=$('#setTestFanfare');
        tFan && tFan.addEventListener('click', ()=>{
          try{ ensureAudio(); beep(392,0.12,'triangle',0.03,0.00); beep(494,0.12,'triangle',0.03,0.10); beep(587,0.16,'triangle',0.035,0.20); toast('Test: Fanfare'); }catch(_){}
        });
      }

      /* ---------- Sound engine (original chimes) ---------- */
      let audioCtx=null;
      function getSoundMode(){ return (loadPrefs().soundMode||'off'); }
      function setSoundMode(mode){
        const p=loadPrefs(); p.soundMode=mode; savePrefs(p);
        toast(`Sound: ${mode==='off'?'Off':(mode==='clicks'?'Clicks':'Fanfare')}`);
        syncSoundUI();
      }
      function ensureAudio(){
        try{
          audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
          if(audioCtx.state==='suspended') audioCtx.resume().catch(()=>{});
        }catch(_){}
      }
      // iOS/Safari: resume AudioContext on first user gesture
      function armAudioUnlock(){
        const once=()=>{ ensureAudio(); window.removeEventListener('pointerdown', once, true); window.removeEventListener('touchstart', once, true); };
        window.addEventListener('pointerdown', once, true);
        window.addEventListener('touchstart', once, true);
      }
      function beep(freq, dur, type='sine', gain=0.03, when=0){
        if(!audioCtx) return;
        const o=audioCtx.createOscillator();
        const g=audioCtx.createGain();
        o.type=type; o.frequency.value=freq;
        const t=audioCtx.currentTime + when;
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(gain, t+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(t); o.stop(t+dur+0.02);
      }
      function clickSound(){
        const mode=getSoundMode();
        if(mode!=='clicks') return;
        try{
          const reduce = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
          if (reduce) return;
          ensureAudio();
          beep(220, 0.05, 'square', 0.02, 0);
        }catch(_){}
      }
      // Expose for global pointer handlers
      window.__LC_clickSound = clickSound;

      function fanfareSound(){
        const mode=getSoundMode();
        if(mode!=='fanfare') return;
        try{
          ensureAudio();
          // a small “Zelda-ish” ascending triad (original)
          beep(392, 0.12, 'triangle', 0.03, 0.00); // G4
          beep(494, 0.12, 'triangle', 0.03, 0.10); // B4
          beep(587, 0.16, 'triangle', 0.035,0.20); // D5
        }catch(_){}
      }
      function syncSoundUI(){
        const mode=getSoundMode();
        const radios=$$('input[name="soundMode"]');
        radios.forEach(r=>{ r.checked = (r.value===mode); });
      }

      /* ---------- UI prefs (Big UI + One-hand) ---------- */
      function getBigUI(){ return !!loadPrefs().bigUI; }
      function setBigUI(on){
        const p=loadPrefs(); p.bigUI=!!on; savePrefs(p);
        applyBigUI();
        toast(`Big UI: ${on?'On':'Off'}`);
        syncSettingsUI();
      }
      function applyBigUI(){
        const on=getBigUI();
        document.documentElement.classList.toggle('bigui', on);
      }

      function getOneHand(){ return (loadPrefs().oneHand||'right'); }
      function setOneHand(mode){
        const p=loadPrefs(); p.oneHand=(mode==='left'?'left':'right'); savePrefs(p);
        applyOneHand();
        toast(`One-hand: ${p.oneHand==='left'?'Left':'Right'}`);
        syncSettingsUI();
      }
      function applyOneHand(){
        const mode=getOneHand();
        document.documentElement.classList.toggle('onehand-left', mode==='left');
        document.documentElement.classList.toggle('onehand-right', mode!=='left');
      }

      function syncSettingsUI(){
        const b=$('#setBigUI'); if(b) b.checked = getBigUI();
        const o=$('#setOneHand'); if(o) o.value = getOneHand();
        const s=$('#setSound'); if(s) s.value = getSoundMode();
      }
      function applyTheme(name){
        document.body.classList.remove('theme-light','theme-inspire');
        if(name==='light') document.body.classList.add('theme-light');
        if(name==='inspire') document.body.classList.add('theme-inspire');
      }

      /* ---------- Router & theme ---------- */
      const tabs=$$('.tab');
      tabs.forEach(t=>t.addEventListener('click',()=>{tabs.forEach(b=>b.classList.remove('active'));t.classList.add('active');render(t.dataset.tab);}));

      function render(which){
        if(which==='graphlab') return renderGraphLab();
                if(which==='units') return renderUnits();
        if(which==='time') return renderTime();
        if(which==='sound') return renderSound();
        if(which==='torque') return renderTorque();
        return renderCalc();
      }

      (function initTheme(){
        const prefs=loadPrefs();
        const theme=prefs.theme||'dark';
        applyTheme(theme);
        $('#themeSel').value=theme;
        $('#themeSel').addEventListener('change',()=>{
          const next=$('#themeSel').value; applyTheme(next); savePrefs({...loadPrefs(), theme:next});
          document.querySelector('h1').style.color = getComputedStyle(document.body).getPropertyValue('--accent').trim();
        });
        document.querySelector('h1').style.color = getComputedStyle(document.body).getPropertyValue('--accent').trim();
      })();

      /* ---------- Calculator ---------- */
      function renderCalc(){
        const view=$('#view');
        view.innerHTML=`
          <section class="surface calc-grid">
            <div>
              <div class="screen">
                <div class="expr" id="expr"></div>
                <div class="result" id="res">0</div>
              </div>
              <div class="keys" id="keys"></div>
            </div>
            <div>
              <div class="section-title">History</div>
              <div class="surface" style="padding:10px">
                <div class="tape" id="tape"></div>
                <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
                  <button class="btn" id="copyTape">Copy</button>
                  <button class="btn" id="clearTape">Clear</button>
                  <button class="btn" id="clearSavedCalc" title="Forget saved history">Clear Saved</button>
                </div>
              </div>
            </div>
              </div>
            </div>
          </section>`;

        const K = (window.matchMedia && window.matchMedia('(max-width: 520px)').matches)
          ? ['C','⌫','%','/','7','8','9','*','4','5','6','-','1','2','3','+','0','.','(',')','sin','cos','tan','^','√','π','e','ANS','=']
          : ['7','8','9','/','sin','cos','4','5','6','*','tan','√','1','2','3','-','^','π','0','.','(',')','e','ANS','C','⌫','%','+','='];
        const keysEl=$('#keys');
        K.forEach(k=>{ const b=document.createElement('button'); b.className='key'; b.textContent=k; if('/*-+^%'.includes(k)) b.classList.add('op'); if(['sin','cos','tan','√','π','e','ANS'].includes(k)) b.classList.add('fn'); if(k==='='){ b.classList.add('eq');
            if (window.matchMedia && window.matchMedia('(max-width: 520px)').matches) b.classList.add('span4');
            else b.classList.add('span2'); } b.onclick=()=>press(k); keysEl.appendChild(b); });

        const saved = loadTab('calc', {tape:[], ans:0});
        let expr=''; let ans=saved.ans||0; const tape=[...(saved.tape||[])]; const exprEl=$('#expr'); const resEl=$('#res');
        function persist(){ saveTab('calc', {tape, ans}); }

        function setRes(v){ resEl.textContent=v; }
        function renderExpr(){ exprEl.textContent=expr||'\u00A0'; }
        function renderTape(){ $('#tape').innerHTML=tape.map(t=>`<div class='trow'><div class='l'>${esc(t.e)}</div><div class='r'>${t.v}</div></div>`).join(''); }

        function evalExpr(){ if(!expr) return; try{ const sanitized=expr.replace(/√/g,'sqrt'); const scope={sin:Math.sin,cos:Math.cos,tan:Math.tan,sqrt:Math.sqrt}; let val=math.evaluate(sanitized,scope); if(typeof val==='number'&&!Number.isFinite(val)) throw 0; ans=round(val); setRes(ans); tape.unshift({e:expr,v:ans}); if(tape.length>300) tape.pop(); expr=''; renderExpr(); renderTape(); persist(); }catch(e){ setRes('Error'); } }
        function press(k){ switch(k){ case 'C': expr=''; setRes(0); break; case '⌫': expr=expr.slice(0,-1); break; case '=': evalExpr(); break; case '√': expr+='sqrt('; break; case 'π': expr+=Math.PI.toString(); break; case 'e': expr+=Math.E.toString(); break; case 'ANS': expr+=String(ans); break; case 'sin': case 'cos': case 'tan': expr+=k+'('; break; default: expr+=k; } renderExpr(); }
        window.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); evalExpr(); } else if(e.key==='Backspace'){ press('⌫'); } else if(e.key==='Escape'){ press('C'); } else if(/[0-9.()+\-/*^%]/.test(e.key)){ press(e.key); } });
        $('#copyTape').onclick=()=>navigator.clipboard.writeText(tape.map(t=>`${t.e} = ${t.v}`).reverse().join('\n'));
        $('#clearTape').onclick=()=>{ tape.length=0; renderTape(); persist(); };
        $('#clearSavedCalc').onclick=()=>{ clearTab('calc'); tape.length=0; ans=0; renderTape(); setRes(0); };

        function round(x){ return +(+x).toPrecision(12); }
        renderExpr(); renderTape(); setRes(ans||0);
      }

      /* ---------- Calculus ---------- */
      function renderCalculus(){
        const view=$('#view');
        view.innerHTML=`
          <section class="surface two-col">
            <div>
              <div class="section-title">Symbolic</div>
              <div class="row">
                <label><div class="note">f(x)</div><input id="fx" class="input" placeholder="e.g. x^3 - 4x + 1"></label>
                <label><div class="note">Point (x = …) for f'(x)</div><input id="x0" class="input" type="number" placeholder="optional"></label>
              </div>
              <div class="btnbar" style="display:flex;gap:8px;margin:10px 0">
                <button class="btn primary" id="diffBtn">Differentiate</button>
                <button class="btn" id="integrateBtn">Definite Integral</button>
                <button class="btn" id="clearSavedCalcus" title="Forget saved inputs">Clear Saved</button>
              </div>
              <div class="note">Integration supports numeric definite integrals (Simpson) — enter bounds below.</div>
              <div class="row" style="margin-top:8px">
                <label><div class="note">Lower bound a</div><input id="a" class="input" type="number" placeholder="e.g. 0"></label>
                <label><div class="note">Upper bound b</div><input id="b" class="input" type="number" placeholder="e.g. 2"></label>
                <label><div class="note">Subdivisions (even)</div><input id="n" class="input" type="number" value="200"></label>
              </div>
              <div id="calcOut" style="margin-top:12px"></div>
            </div>
            <div>
              <div class="section-title">Quick Checks</div>
              <div class="row">
                <label><div class="note">Limit x → a</div><input id="limExpr" class="input" placeholder="e.g. (sin(x))/x"></label>
                <label><div class="note">a</div><input id="limA" class="input" type="number" placeholder="0"></label>
              </div>
              <div class="btnbar" style="display:flex;gap:8px;margin:10px 0"><button class="btn" id="limitBtn">Compute Limit (numeric)</button></div>
              <div id="limitOut"></div>
            </div>
          </section>`;

        const saved = loadTab('calculus', {fx:'', x0:'', a:'', b:'', n:200, limExpr:'', limA:''});
        $('#fx').value = saved.fx||''; $('#x0').value = saved.x0||''; $('#a').value = saved.a||''; $('#b').value = saved.b||''; $('#n').value = saved.n||200; $('#limExpr').value = saved.limExpr||''; $('#limA').value = saved.limA||'';
        function persist(){ saveTab('calculus', {fx:$('#fx').value, x0:$('#x0').value, a:$('#a').value, b:$('#b').value, n:$('#n').value, limExpr:$('#limExpr').value, limA:$('#limA').value}); }
        $$('.input').forEach(el=> el.addEventListener('input', ()=>{ persist(); schedulePlot(); }));
        $('#clearSavedCalcus').onclick=()=>{ clearTab('calculus'); ['fx','x0','a','b','n','limExpr','limA'].forEach(id=>{ const e=$('#'+id); if(e) e.value=''; }); };

        $('#diffBtn').onclick=()=>{
          const fx=$('#fx').value.trim(); if(!fx){ return setCalcOut("<div class='err'>Enter f(x)</div>"); }
          try{
            const d = window.math.derivative(fx,'x').toString();
            const x0 = parseFloat($('#x0').value);
            let evalAt='';
            if(!Number.isNaN(x0)){
              const f = window.math.parse(d).compile();
              const val = f.evaluate({x:x0});
              evalAt = `<div>f'( ${x0} ) = <b>${round(val)}</b></div>`;
            }
            setCalcOut(`<div>f'(x) = <b>${esc(d)}</b></div>${evalAt}`);
          }catch(e){ setCalcOut("<div class='err'>Bad function</div>"); }
        };

        $('#integrateBtn').onclick=()=>{
          const fx=$('#fx').value.trim(); const a=parseFloat($('#a').value); const b=parseFloat($('#b').value); let n=parseInt($('#n').value||200,10);
          if(!fx||Number.isNaN(a)||Number.isNaN(b)) return setCalcOut("<div class='err'>Enter f(x), a, b</div>");
          if(n%2===1) n+=1; // Simpson needs even
          try{
            const f = window.math.parse(fx).compile();
            const F = x=>{ const v=f.evaluate({x}); if(!Number.isFinite(v)) throw 0; return v; };
            const h=(b-a)/n; let s=F(a)+F(b);
            for(let i=1;i<n;i++){ const x=a+i*h; s += (i%2? 4:2)*F(x); }
            const I = (h/3)*s;
            setCalcOut(`<div>∫<sub>${a}</sub><sup>${b}</sup> f(x) dx ≈ <b>${round(I)}</b> (n=${n})</div>`);
          }catch(e){ setCalcOut("<div class='err'>Numerical integration failed</div>"); }
        };

        $('#limitBtn').onclick=()=>{
          const ex=$('#limExpr').value.trim(); const a=parseFloat($('#limA').value);
          if(!ex||Number.isNaN(a)) return setLimitOut("<div class='err'>Enter expression and a</div>");
          try{
            const f = window.math.parse(ex).compile();
            const lim = numericLimit(x=>f.evaluate({x}), a);
            setLimitOut(`<div>lim<sub>x→${a}</sub> ${esc(ex)} = <b>${round(lim)}</b></div>`);
          }catch(e){ setLimitOut("<div class='err'>Limit failed</div>"); }
        };

        function numericLimit(F,a){ const eps=1e-6; const left=F(a-eps); const right=F(a+eps); return (left+right)/2; }
        function setCalcOut(html){ $('#calcOut').innerHTML=html; }
        function setLimitOut(html){ $('#limitOut').innerHTML=html; }
        function round(x){ return +(+x).toPrecision(12); }
      }

      /* ---------- Graphing (with hotkeys) ---------- */
      
      function renderGraphLab(){
        const view=$('#view');
        view.innerHTML=`
          <section class="surface">
            <div class="glgrid">
              <div class="gll">
            <div class="row">
              <label style="grid-column:1/-1">
                <div class="note">Expression(s) (one per line)</div>
                <textarea id="gx" class="input" rows="4" placeholder="e.g.\nsin(x)\nx^2 - 3x + 2\nexp(-x^2)"></textarea>
              </label>

              <label><div class="note">x-min</div><input id="xmin" class="input" type="number" value="-10"></label>
              <label><div class="note">x-max</div><input id="xmax" class="input" type="number" value="10"></label>
              <label><div class="note">Samples</div><input id="samples" class="input" type="number" value="400"></label>

              <label style="grid-column:1/-1">
                <div class="note">Overlays</div>
                <div class="row" style="gap:10px;align-items:center;flex-wrap:wrap">
                  <label class="pill"><input type="checkbox" id="d1"> Show f'(x) (first line)</label>
                  <label class="pill"><input type="checkbox" id="tanOn"> Tangent @ x₀</label>
                  <label class="pill"><input type="checkbox" id="intOn"> ∫ area a..b</label>
                  <label class="pill"><input type="checkbox" id="absOn"> Abs area</label>
                  <label class="pill"><input type="checkbox" id="betweenOn"> Between f1−f2 a..b</label>
                  <label class="pill">a <input id="a" class="input" type="number" step="0.1" value="-1" style="width:110px;display:inline-block;margin-left:6px"></label>
                  <label class="pill">b <input id="b" class="input" type="number" step="0.1" value="1" style="width:110px;display:inline-block;margin-left:6px"></label>
                  <label class="pill"><input type="checkbox" id="rootsOn"> Roots (zeros)</label>
                  <label class="pill"><input type="checkbox" id="ixOn"> Intersections f1=f2</label>
                  <label class="pill"><input type="checkbox" id="traceOn"> Trace cursor</label>
                  <label class="pill">x <input id="xT" class="input" type="number" step="0.1" value="0" style="width:110px;display:inline-block;margin-left:6px"></label>
                  <input id="xTr" type="range" min="-10" max="10" step="0.1" value="0" style="flex:1;min-width:160px">
                  <label class="pill">x₀ <input id="x0" class="input" type="number" step="0.1" value="0" style="width:110px;display:inline-block;margin-left:6px"></label>
                  <input id="x0r" type="range" min="-10" max="10" step="0.1" value="0" style="flex:1;min-width:160px">
                </div>
              </label>
            </div>

            <div class="btnbar" style="display:flex;gap:8px;margin:10px 0">
              <button class="btn primary" id="plotBtn">Plot</button>
              <label class="pill" style="align-self:center"><input type="checkbox" id="autoPlot"> Auto</label>
              <label class="pill" style="align-self:center"><input type="checkbox" id="liveTyping"> Live</label>
              <label class="pill" style="align-self:center"><input type="checkbox" id="forgiving"> Forgiving</label>
              <button class="btn" id="clearBtn">Clear</button>
              <button class="btn" id="exportBtn">Export PNG</button>
              <button class="btn" id="clearSavedGL" title="Forget saved inputs">Clear Saved</button>
            </div>
              </div>
              <div class="glr">

            <div class="chartwrap"><div id="glLegend" class="glegend" style="display:none"></div><div id="chart" class="chart"></div></div>
            <div id="glReadout" class="note" style="margin-top:8px"></div>

            <div class="note">
              GraphLab: multi-line plot + overlays. Tip: enable <b>Auto</b> to re-plot while typing. Prefix a line with <b>#</b> or <b>//</b> to disable it (hide). Functions are lowercase: <b>sin(x)</b>, <b>cos(x)</b>.
              Hotkeys: <b>Enter</b> plot, <b>Shift+Enter</b> newline, <b>Ctrl/Cmd+Enter</b> plot only, <b>Ctrl+L</b> clear.
            </div>
          </section>`;

        const GL_CTL_KEY = 'legendcalc.graphlab.hideControls';
        function applyCtlState(){
          const hide = (localStorage.getItem(GL_CTL_KEY) === '1');
          document.body.classList.toggle('gl-hide-controls', hide);
          const b = $('#glCtlToggle');
          if(b) b.textContent = hide ? 'Show controls' : 'Controls';
        }
        $('#glCtlToggle')?.addEventListener('click', ()=>{
          const cur = (localStorage.getItem(GL_CTL_KEY) === '1');
          localStorage.setItem(GL_CTL_KEY, cur ? '0' : '1');
          applyCtlState();
        });
        applyCtlState();


        const saved = loadTab('graphlab', {gx:'', xmin:'-10', xmax:'10', samples:'400', d1:'0', tanOn:'0', x0:'0', intOn:'0', a:'-1', b:'1', rootsOn:'0', ixOn:'0', traceOn:'0', xT:'0', absOn:'0', betweenOn:'0', autoPlot:'0', liveTyping:'1', forgiving:'1'});
        $('#gx').value=saved.gx||'';
        if(!$('#gx').value.trim()) $('#gx').value='sin(x)'; $('#xmin').value=saved.xmin||'-10'; $('#xmax').value=saved.xmax||'10'; $('#samples').value=saved.samples||'400';
        $('#d1').checked = (saved.d1==='1');
        $('#tanOn').checked = (saved.tanOn==='1');
        $('#x0').value = (saved.x0 ?? '0');
        $('#x0r').value = $('#x0').value;
        $('#intOn').checked = (saved.intOn==='1');
        $('#absOn').checked = (saved.absOn==='1');
        $('#betweenOn').checked = (saved.betweenOn==='1');
        $('#autoPlot').checked = (saved.autoPlot!=='0');
        $('#liveTyping').checked = (saved.liveTyping!=='0');
        $('#forgiving').checked = (saved.forgiving!=='0');
        $('#a').value = (saved.a ?? '-1');
        $('#b').value = (saved.b ?? '1');
        $('#rootsOn').checked = (saved.rootsOn==='1');
        $('#ixOn').checked = (saved.ixOn==='1');
        $('#traceOn').checked = (saved.traceOn==='1');
        $('#xT').value = (saved.xT ?? '0');
        $('#xTr').value = $('#xT').value;
        function syncX0Bounds(){
          const a = parseFloat($('#xmin').value)||-10;
          const b = parseFloat($('#xmax').value)||10;
          const lo = Math.min(a,b), hi = Math.max(a,b);
          $('#x0r').min = String(lo);
          $('#x0r').max = String(hi);
          const v = Math.min(hi, Math.max(lo, parseFloat($('#x0').value)||0));
          $('#x0').value = String(v);
          $('#x0r').value = String(v);
        }
        function syncTraceBounds(){
          const a = parseFloat($('#xmin').value)||-10;
          const b = parseFloat($('#xmax').value)||10;
          const lo = Math.min(a,b), hi = Math.max(a,b);
          $('#xTr').min = String(lo);
          $('#xTr').max = String(hi);
          const v = Math.min(hi, Math.max(lo, parseFloat($('#xT').value)||0));
          $('#xT').value = String(v);
          $('#xTr').value = String(v);
        }
        syncX0Bounds();
        syncTraceBounds();

        function persist(){
          saveTab('graphlab', {gx:$('#gx').value, xmin:$('#xmin').value, xmax:$('#xmax').value, samples:$('#samples').value, d1:($('#d1').checked?'1':'0'), tanOn:($('#tanOn').checked?'1':'0'), x0:$('#x0').value, intOn:($('#intOn').checked?'1':'0'), a:$('#a').value, b:$('#b').value, rootsOn:($('#rootsOn').checked?'1':'0'), ixOn:($('#ixOn').checked?'1':'0'), traceOn:($('#traceOn').checked?'1':'0'), xT:$('#xT').value, absOn:($('#absOn').checked?'1':'0'), betweenOn:($('#betweenOn').checked?'1':'0'), autoPlot:($('#autoPlot').checked?'1':'0'), liveTyping:($('#liveTyping').checked?'1':'0'), forgiving:($('#forgiving').checked?'1':'0')});
        }
        $$('.input').forEach(el=> el.addEventListener('input', ()=>{ persist(); schedulePlot(); }));
        $('#d1').addEventListener('change', ()=>{ persist(); waitForGraphLibs(doPlot); });
        $('#tanOn').addEventListener('change', ()=>{ persist(); waitForGraphLibs(doPlot); });
        $('#intOn').addEventListener('change', ()=>{ persist(); waitForGraphLibs(doPlot); });
        $('#absOn').addEventListener('change', ()=>{ persist(); waitForGraphLibs(doPlot); });
        $('#betweenOn').addEventListener('change', ()=>{ persist(); waitForGraphLibs(doPlot); });
        $('#autoPlot').addEventListener('change', ()=>{ persist(); if($('#autoPlot').checked) schedulePlot(); });
        $('#forgiving').addEventListener('change', ()=>{ persist(); if($('#autoPlot').checked) schedulePlot(); });
        $('#liveTyping').addEventListener('change', ()=>{ persist(); if($('#autoPlot').checked) schedulePlot(); });
        $('#a').addEventListener('input', ()=>{ persist(); if($('#intOn').checked) waitForGraphLibs(doPlot); else updateReadout(); });
        $('#b').addEventListener('input', ()=>{ persist(); if($('#intOn').checked) waitForGraphLibs(doPlot); else updateReadout(); });
        $('#rootsOn').addEventListener('change', ()=>{ persist(); waitForGraphLibs(doPlot); });
        $('#ixOn').addEventListener('change', ()=>{ persist(); waitForGraphLibs(doPlot); });
        $('#traceOn').addEventListener('change', ()=>{ persist(); waitForGraphLibs(doPlot); });
        $('#xT').addEventListener('input', ()=>{ $('#xTr').value=$('#xT').value; persist(); if($('#traceOn').checked) waitForGraphLibs(doPlot); });
        $('#xTr').addEventListener('input', ()=>{ $('#xT').value=$('#xTr').value; persist(); if($('#traceOn').checked) waitForGraphLibs(doPlot); });
        $('#x0').addEventListener('input', ()=>{ $('#x0r').value=$('#x0').value; persist(); if($('#tanOn').checked) waitForGraphLibs(doPlot); else updateReadout(); });
        $('#x0r').addEventListener('input', ()=>{ $('#x0').value=$('#x0r').value; persist(); if($('#tanOn').checked) waitForGraphLibs(doPlot); else updateReadout(); });
        $('#xmin').addEventListener('input', ()=>{ syncX0Bounds(); syncTraceBounds(); persist(); waitForGraphLibs(doPlot); });
        $('#xmax').addEventListener('input', ()=>{ syncX0Bounds(); syncTraceBounds(); persist(); waitForGraphLibs(doPlot); });

        $('#clearSavedGL').onclick=()=>{
          clearTab('graphlab');
          ['gx','xmin','xmax','samples'].forEach(id=>$('#'+id).value='');
          $('#x0').value='0'; $('#x0r').value='0';
          $('#tanOn').checked=false;
          $('#intOn').checked=false; $('#absOn').checked=false; $('#a').value='-1'; $('#b').value='1';
          $('#rootsOn').checked=false;
          $('#ixOn').checked=false;
          $('#traceOn').checked=false; $('#xT').value='0'; $('#xTr').value='0';
          $('#d1').checked=false;
          window.Plotly.purge('chart');
          $('#autoPlot').checked=true;
          toast('GraphLab: cleared');
        };

        function updateReadout(info){
          const el = $('#glReadout');
          if(!el) return;
          el.innerHTML = info ? info : '';
        }

function doPlot(){
          if(!graphLibsReady()){ toast('GraphLab: loading…'); return; }
          const lines=$('#gx').value.split(/\n+/).map(s=>s.trim()).filter(Boolean).slice(0,6);
          const xmin=parseFloat($('#xmin').value), xmax=parseFloat($('#xmax').value);
          const nRaw=parseInt($('#samples').value,10)||400;
          const isMobile = window.matchMedia && window.matchMedia('(max-width: 820px)').matches;
          const MAX_SAMPLES = isMobile ? 2000 : 5000;
          const n = Math.max(50, Math.min(MAX_SAMPLES, nRaw));
          if(n !== nRaw){
            $('#samples').value = String(n);
            toast(`Samples clamped to ${n} for performance`);
          }
          let fx0=null, fx1=null;
          if(lines[0]){ try{ fx0 = window.math.parse(lines[0]).compile(); }catch(_){ fx0=null; } }
          if(lines[1]){ try{ fx1 = window.math.parse(lines[1]).compile(); }catch(_){ fx1=null; } }

          if(!lines.length){ try{ window.Plotly.purge('chart'); }catch(_){ } return; }

          try{
            const xs = window.linspace(xmin,xmax,n);
            const traces = [];

            function safeEval(compiled, scope){
              try{
                const v = compiled.evaluate(scope);
                if(typeof v === 'number') return (Number.isFinite(v)? v : NaN);
                // mathjs can return Complex/BigNumber/Fraction/Unit; we only graph real numbers
                if(v && typeof v === 'object'){
                  if('re' in v && 'im' in v) return (Number.isFinite(v.re) ? v.re : NaN);
                }
                return NaN;
              }catch(_e){
                return NaN;
              }
            }


            let readoutParts = [];

            // base functions
            lines.forEach((ex,i)=>{
              let f;
              try{ f = window.math.parse(ex).compile(); }
              catch(err){ readoutParts.push(`<span class="muted">Line ${i+1}: ${(err&&err.message)?err.message:'parse error'}</span>`); return; }
              let bad=0; const ys = xs.map(x=>{ const y=safeEval(f,{x}); if(!Number.isFinite(y)) bad++; return y; });
              if(bad===xs.length){ readoutParts.push(`<span class="muted">Line ${i+1}: eval failed (check syntax like sin(x), use lowercase)</span>`); }
              traces.push({x:xs, y:ys, type:'scatter', mode:'lines', name: ex.length>22 ? (ex.slice(0,22)+'…') : ex, line:{color: window.GL_PALETTE[i % window.GL_PALETTE.length]}});
            });

            // derivative overlay for first line only
            if($('#d1').checked && lines[0]){
              try{
                const dex = window.math.derivative(lines[0], 'x').toString();
                const df = window.math.parse(dex).compile();
                const dys = xs.map(x=> safeEval(df,{x}));
                traces.push({x:xs, y:dys, type:'scatter', mode:'lines', name:`d/dx (${lines[0].length>18?lines[0].slice(0,18)+'…':lines[0]})`, line:{dash:'dot', width:2}, opacity:0.85});
              }catch(_){
                toast("Derivative overlay couldn't parse");
              }
            }

            
            // tangent line at x0 for first line
            let tangentHTML = "";
            if($('#tanOn')?.checked && lines[0]){
              const x0 = parseFloat($('#x0').value);
              try{
                const fx = fx0 || window.math.parse(lines[0]).compile();
                const y0 = safeEval(fx,{x:x0});
                let mval = NaN;
                try{
                  const dex = window.math.derivative(lines[0], 'x').toString();
                  const df = window.math.parse(dex).compile();
                  mval = safeEval(df,{x:x0});
                }catch(_){
                  // numeric fallback
                  const h = 1e-4 * Math.max(1, Math.abs(x0));
                  const yph = safeEval(fx,{x:x0+h});
                  const ymh = safeEval(fx,{x:x0-h});
                  mval = (yph-ymh)/(2*h);
                }

                if(Number.isFinite(y0) && Number.isFinite(mval)){
                  const ytan = xs.map(x => (mval*(x-x0) + y0));
                  traces.push({x:xs, y:ytan, type:'scatter', mode:'lines', name:`tangent @ ${x0}`, line:{dash:'dash', width:2}, opacity:0.85});
                  traces.push({x:[x0], y:[y0], type:'scatter', mode:'markers', name:'x₀', marker:{size:8}});
                  const eq = `y = ${mval.toFixed(6)}(x − ${x0}) + ${y0.toFixed(6)}`;
                  tangentHTML = `<b>Tangent</b> at x₀=${x0}: f(x₀)=${Number(y0).toFixed(6)}, slope=${Number(mval).toFixed(6)}<br><span class="muted">${eq}</span>`;
                }else{
                  tangentHTML = `<span class="muted">Tangent: function not finite at x₀</span>`;
                }
              }catch(err){
                logErr(err);
                tangentHTML = `<span class="muted">Tangent: parse/eval error</span>`;
              }
            }
            // readout continues below
            if(tangentHTML) readoutParts.push(tangentHTML);

            
            // numeric integral shading a..b for first line
            if($('#intOn')?.checked && lines[0]){
              const aa = parseFloat($('#a').value);
              const bb = parseFloat($('#b').value);
              const lo = Math.min(aa,bb), hi = Math.max(aa,bb);
              const useAbs = !!$('#absOn')?.checked;
              try{
                const fx = fx0 || window.math.parse(lines[0]).compile();
                const xs_ab = xs.filter(x => x>=lo && x<=hi);
                if(xs_ab.length>=2){
                  const ys_ab_raw = xs_ab.map(x=> safeEval(fx,{x}));
                  const ys_ab = useAbs ? ys_ab_raw.map(y=> (Number.isFinite(y)? Math.abs(y): NaN)) : ys_ab_raw;

                  // shading (to x-axis); if Abs area is on we shade |f(x)|
                  traces.push({x:xs_ab, y:ys_ab, type:'scatter', mode:'lines', name: useAbs ? `|f(x)| area` : `∫ a..b`, fill:'tozeroy', opacity:0.25});

                  // trapezoid numeric integral
                  let area = 0;
                  for(let i=1;i<xs_ab.length;i++){
                    const dx = xs_ab[i]-xs_ab[i-1];
                    const y1 = ys_ab[i-1], y2 = ys_ab[i];
                    if(Number.isFinite(y1) && Number.isFinite(y2)) area += (y1+y2)*0.5*dx;
                  }
                  readoutParts.push(`<b>Integral</b> from a=${lo} to b=${hi}: ${useAbs?'abs area':'signed area'} ≈ ${area.toFixed(6)}`);
                }else{
                  readoutParts.push(`<span class="muted">Integral: increase samples or widen [a,b]</span>`);
                }
              }catch(err){
                logErr(err);
                readoutParts.push(`<span class="muted">Integral: parse/eval error</span>`);
              }
            }


            // Root markers (zeros) for first line
            if($('#rootsOn')?.checked && lines[0]){
              try{
                const fx = fx0 || window.math.parse(lines[0]).compile();
                const roots = [];
                const tol = 1e-6;
                const maxIter = 30;

                function fval(x){
                  const y = safeEval(fx,{x});
                  return (Number.isFinite(y) ? y : NaN);
                }
                function bisect(a,b){
                  let fa=fval(a), fb=fval(b);
                  if(!Number.isFinite(fa) || !Number.isFinite(fb)) return NaN;
                  if(fa===0) return a;
                  if(fb===0) return b;
                  if(fa*fb>0) return NaN;
                  let lo=a, hi=b, flo=fa, fhi=fb;
                  for(let i=0;i<maxIter;i++){
                    const mid=(lo+hi)/2;
                    const fm=fval(mid);
                    if(!Number.isFinite(fm)) break;
                    if(Math.abs(fm) < tol) return mid;
                    if(flo*fm<=0){ hi=mid; fhi=fm; }
                    else { lo=mid; flo=fm; }
                  }
                  return (lo+hi)/2;
                }

                let prevX = xs[0];
                let prevY = fval(prevX);
                for(let i=1;i<xs.length;i++){
                  const x = xs[i];
                  const y = fval(x);
                  if(Number.isFinite(prevY) && Number.isFinite(y)){
                    if(prevY===0){
                      roots.push(prevX);
                    }else if(y===0){
                      roots.push(x);
                    }else if(prevY*y < 0){
                      const r = bisect(prevX, x);
                      if(Number.isFinite(r)) roots.push(r);
                    }
                  }
                  prevX=x; prevY=y;
                }

                // de-dup close roots
                roots.sort((a,b)=>a-b);
                const uniq=[];
                for(const r of roots){
                  if(!uniq.length || Math.abs(r-uniq[uniq.length-1])>1e-3) uniq.push(r);
                }

                if(uniq.length){
                  const yroots = uniq.map(x=>fval(x));
                  traces.push({x:uniq, y:yroots, type:'scatter', mode:'markers', name:'roots', marker:{size:9, symbol:'circle-open'}, opacity:0.9});
                  const list = uniq.slice(0,8).map(r=>r.toFixed(6)).join(', ');
                  readoutParts.push(`<b>Roots</b> (${uniq.length}): ${list}${uniq.length>8?' …':''}`);
                }else{
                  readoutParts.push(`<span class="muted">Roots: none detected in [x-min, x-max]</span>`);
                }
              }catch(err){
                logErr(err);
                readoutParts.push(`<span class="muted">Roots: parse/eval error</span>`);
              }
            }

            updateReadout(readoutParts.join('<br>'));

            
            // Trace cursor for first line (and derivative if enabled)
            if($('#traceOn')?.checked && lines[0]){
              try{
                const x = parseFloat($('#xT').value);
                const fx = fx0 || window.math.parse(lines[0]).compile();
                const y = safeEval(fx,{x});
                if(Number.isFinite(y)){
                  traces.push({x:[x], y:[y], type:'scatter', mode:'markers+text', name:'trace', text:[`(${x.toFixed(4)}, ${Number(y).toFixed(6)})`], textposition:'top center', marker:{size:9}});
                  // vertical line via shapes
                  // We'll add shape in layout below.
                  readoutParts.push(`<b>Trace</b> x=${x.toFixed(6)} → f(x)=${Number(y).toFixed(6)}`);
                  if($('#d1')?.checked){
                    try{
                      const dex = window.math.derivative(lines[0],'x').toString();
                      const df = window.math.parse(dex).compile();
                      const m = safeEval(df,{x});
                      if(Number.isFinite(m)) readoutParts.push(`<span class="muted">f'(x)=${Number(m).toFixed(6)}</span>`);
                    }catch(_){}
                  }
                }else{
                  readoutParts.push(`<span class="muted">Trace: f(x) not finite</span>`);
                }
              }catch(err){
                logErr(err);
                readoutParts.push(`<span class="muted">Trace: parse/eval error</span>`);
              }
            }

            const layout = {
              margin:{l:40,r:15,t:10,b:35},
              xaxis:{title:'x', zeroline:true},
              yaxis:{title:'y', zeroline:true},
              paper_bgcolor:'rgba(0,0,0,0)',
              plot_bgcolor:'rgba(0,0,0,0)',
              showlegend:true,
              legend:{orientation:'h', itemwidth:110}
            };
            // add trace vertical line
            if($('#traceOn')?.checked){
              const x = parseFloat($('#xT').value);
              if(Number.isFinite(x)){
                layout.shapes = (layout.shapes||[]).concat([{type:'line', x0:x, x1:x, y0:0, y1:1, xref:'x', yref:'paper', line:{dash:'dot', width:1}}]);
              }
            }

            try{
              window.Plotly.newPlot('chart', traces, layout, {responsive:true, displaylogo:false});
            }catch(err){
              logErr(err);
              toast('Plot render error');
              return;
            }
            persist();
          }catch(err){
            logErr(err);
            toast('Plot error: ' + (err?.message||'unknown'));
          }
        }

        $('#plotBtn').onclick=()=>waitForGraphLibs(doPlot);
        $('#clearBtn').onclick=()=>{ try{ window.Plotly.purge('chart'); }catch(_){ } };
        $('#exportBtn').onclick=()=>{ try{ window.Plotly.downloadImage('chart',{format:'png',filename:'legendcalc-graphlab'}); }catch(e){ toast('Export blocked'); } };

        // hotkeys
        $('#gx').addEventListener('keydown',(e)=>{
          if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='l'){ e.preventDefault(); $('#gx').value=''; doPlot(); }
          if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ e.preventDefault(); doPlot(); }
          if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); doPlot(); }
        });

        // initial plot if saved content exists
        // initial plot only when user requests, to avoid lockups on some devices
        // (enable Auto if you want live plotting)
        // if($('#gx').value.trim()) waitForGraphLibs(doPlot);
        // if Auto is enabled, keep the plot fresh while typing

        function parseRawLines(){
          const raw = ($('#gx')?.value || '').split('\n');
          const rows = [];
          raw.forEach((line, i)=>{
            const s = String(line||'');
            const trimmed = s.trim();
            if(!trimmed){ return; }
            const disabled = trimmed.startsWith('#') || trimmed.startsWith('//');
            const clean = disabled ? trimmed.replace(/^#\s*/,'').replace(/^\/\/\s*/,'') : trimmed;
            rows.push({text: clean, enabled: !disabled, srcIndex: i+1});
          });
          return rows;
        }

        function buildRawLines(rows){
          return rows.map(r=>{
            const ex = (r.text||'').trim();
            if(!ex) return '';
            return r.enabled ? ex : ('# ' + ex);
          }).filter(Boolean).join('\n');
        }

        function renderFxList(){
          const host = $('#fxList');
          if(!host) return;
          const rows = parseRawLines();
          // If empty, seed one row
          const seed = rows.length ? rows : [{text:'sin(x)', enabled:true, srcIndex:1}];
          host.innerHTML = '';
          seed.forEach((r, i)=>{
            const row = document.createElement('div');
            row.className = 'fxrow';
            const sw = document.createElement('div');
            sw.className = 'fxswatch';
            sw.style.background = window.GL_PALETTE[i % window.GL_PALETTE.length];

            const chk = document.createElement('input');
            chk.type = 'checkbox';
            chk.checked = !!r.enabled;
            chk.title = 'Show/hide';

            
            const eye = document.createElement('span');
            eye.className = 'eyeBtn' + (r.enabled ? '' : ' off');
            eye.textContent = '👁';
            eye.title = 'Show/hide';
const inp = document.createElement('input');
            inp.type = 'text';
            inp.value = r.text;
            inp.placeholder = i===0 ? 'sin(x)' : 'x^2 - 3x + 2';

            const del = document.createElement('button');
            del.type = 'button';
            del.className = 'fxdel';
            del.textContent = '×';
            del.title = 'Remove';

            // layout: checkbox + input + delete, with swatch inside checkbox area
            const leftWrap = document.createElement('div');
            leftWrap.style.display='flex';
            leftWrap.style.alignItems='center';
            leftWrap.style.gap='8px';
            leftWrap.appendChild(sw);
            leftWrap.appendChild(chk);
            leftWrap.appendChild(eye);

            row.appendChild(leftWrap);
            eye.addEventListener('click', ()=>{
              chk.checked = !chk.checked;
              eye.classList.toggle('off', !chk.checked);
              apply();
            });
            row.appendChild(inp);
            row.appendChild(del);
            host.appendChild(row);

            const apply = ()=>{
              const next = parseRawLines();
              // if list length differs (seed case), rebuild from DOM instead
              const domRows = Array.from(host.querySelectorAll('.fxrow')).map((rr, j)=>({
                text: rr.querySelector('input[type="text"]').value,
                enabled: rr.querySelector('input[type="checkbox"]').checked
              }));
              $('#gx').value = buildRawLines(domRows);
              persist();
              const live = !!$('#liveTyping')?.checked;
              if($('#autoPlot')?.checked) schedulePlot(false);
              else if(live && glHasPlotted) schedulePlot(true);
            };

            chk.addEventListener('change', apply);
            inp.addEventListener('input', ()=>{
              const live = !!$('#liveTyping')?.checked;
              if($('#autoPlot')?.checked) apply();
              else if(live && glHasPlotted) apply();
              else { persist(); }
            });
            inp.addEventListener('change', apply);
            del.addEventListener('click', ()=>{
              row.remove();
              apply();
              renderFxList();
            });
          });
        }

        // Live plotting (debounced) when Auto is enabled
        let _plotTimer=null;
        function schedulePlot(force=false){
          if(!force && !$('#autoPlot')?.checked) return;
          clearTimeout(_plotTimer);
          _plotTimer=setTimeout(()=>waitForGraphLibs(doPlot), 250);
        }

        // no auto plot on first render unless user toggles Auto
        // if($('#autoPlot')?.checked) schedulePlot();
      }


function renderGraph(){
        const view=$('#view');
        view.innerHTML=`
          <section class="surface">
            <div class="row">
              <label style="grid-column:1/-1"><div class="note">Functions (one per line)</div>
                <textarea id="gx" class="input" rows="4" placeholder="e.g.\nsin(x)\nx^2 - 3x + 2\nexp(-x^2)"></textarea>
              </label>
              <label><div class="note">x-min</div><input id="xmin" class="input" type="number" value="-10"></label>
              <label><div class="note">x-max</div><input id="xmax" class="input" type="number" value="10"></label>
              <label><div class="note">Samples</div><input id="samples" class="input" type="number" value="400"></label>
            </div>
            <div class="btnbar" style="display:flex;gap:8px;margin:10px 0">
              <button class="btn primary" id="plotBtn">Plot</button>
              <label class="pill" style="align-self:center"><input type="checkbox" id="autoPlot"> Auto</label>
              <label class="pill" style="align-self:center"><input type="checkbox" id="liveTyping"> Live</label>
              <label class="pill" style="align-self:center"><input type="checkbox" id="forgiving"> Forgiving</label>
              <button class="btn" id="clearBtn">Clear</button>
              <button class="btn" id="exportBtn">Export PNG</button>
              <button class="btn" id="clearSavedGraph" title="Forget saved inputs">Clear Saved</button>
            </div>
            <div id="chart" class="chart"></div>
            <div id="glReadout" class="note" style="margin-top:8px"></div>
            <div class="note">Hotkeys: <b>Enter</b> new line + plot, <b>Shift+Enter</b> new line (no plot), <b>Ctrl/Cmd+Enter</b> plot only, <b>Ctrl+L</b> clear.</div>
          </section>`;

        const saved = loadTab('graph', {gx:'', xmin:'-10', xmax:'10', samples:'400'});
        $('#gx').value=saved.gx||'';
        if(!$('#gx').value.trim()) $('#gx').value='sin(x)'; $('#xmin').value=saved.xmin||'-10'; $('#xmax').value=saved.xmax||'10'; $('#samples').value=saved.samples||'400';
        function persist(){ saveTab('graph', {gx:$('#gx').value, xmin:$('#xmin').value, xmax:$('#xmax').value, samples:$('#samples').value}); }
        $$('.input').forEach(el=> el.addEventListener('input', ()=>{ persist(); schedulePlot(); }));
        $('#clearSavedGraph').onclick=()=>{ clearTab('graph'); ['gx','xmin','xmax','samples'].forEach(id=>$('#'+id).value='');
          $('#x0').value='0'; $('#x0r').value='0';
          $('#tanOn').checked=false;
          $('#intOn').checked=false; $('#absOn').checked=false; $('#a').value='-1'; $('#b').value='1';
          $('#rootsOn').checked=false;
          $('#ixOn').checked=false;
          $('#traceOn').checked=false; $('#xT').value='0'; $('#xTr').value='0'; window.Plotly.purge('chart'); };

        function updateReadout(info){
          const el = $('#glReadout');
          if(!el) return;
          el.innerHTML = info ? info : '';
        }

function doPlot(){
          if(!graphLibsReady()){ toast('GraphLab: loading…'); return; }
          const lines=$('#gx').value.split(/\n+/).map(s=>s.trim()).filter(Boolean).slice(0,6);
          const xmin=parseFloat($('#xmin').value), xmax=parseFloat($('#xmax').value), n=parseInt($('#samples').value,10)||400;
          let fx0=null, fx1=null;
          if(lines[0]){ try{ fx0 = window.math.parse(lines[0]).compile(); }catch(_){ fx0=null; } }
          if(lines[1]){ try{ fx1 = window.math.parse(lines[1]).compile(); }catch(_){ fx1=null; } }

          if(!lines.length){ try{ window.Plotly.purge('chart'); }catch(_){ } return; }
          try{
            const xs = window.linspace(xmin,xmax,n);
            const traces = lines.map((ex,i)=>{
              const f = window.math.parse(ex).compile();
              let bad=0; const ys = xs.map(x=>{ const y=safeEval(f,{x}); if(!Number.isFinite(y)) bad++; return y; });
              if(bad===xs.length){ readoutParts.push(`<span class="muted">Line ${i+1}: eval failed (check syntax like sin(x), use lowercase)</span>`); }
              return {x:xs,y:ys,mode:'lines',name:ex};
            });
            window.Plotly.newPlot('chart',traces,{paper_bgcolor:'transparent',plot_bgcolor:'#0b0e13',margin:{l:45,r:10,b:35,t:10},xaxis:{gridcolor:'#1f2735',zeroline:false},yaxis:{gridcolor:'#1f2735',zeroline:false}});
            persist();
          }catch(e){ alert('Parse error in one of the functions'); }
        }

        $('#plotBtn').onclick=()=>waitForGraphLibs(doPlot);
        $('#clearBtn').onclick=()=>{ try{ window.Plotly.purge('chart'); }catch(_){ } };
        $('#exportBtn').onclick=async ()=>{
          try{ const url = await Plotly.toImage('chart',{format:'png',height:600,width:900,scale:2}); const a=document.createElement('a'); a.href=url; a.download='legendcalc-graph.png'; a.click(); }catch(e){ alert('Export failed'); }
        };
        function linspace(a,b,n){ const arr=new Array(n); const h=(b-a)/(n-1); for(let i=0;i<n;i++) arr[i]=a+i*h; return arr; }


        // Responsive resize (helps iPhone rotation / address-bar collapse)
        let _rzT=null;
        window.addEventListener('resize', ()=>{
          if(!_rzT) _rzT=setTimeout(()=>{
            _rzT=null;
            try{ Plotly.Plots.resize('chart'); }catch(_){}
          }, 120);
        }, {passive:true});

        // Hotkeys on textarea
        const gx = $('#gx');
        gx.addEventListener('keydown', (e)=>{
          const meta = e.ctrlKey || e.metaKey;
          if(meta && e.key.toLowerCase()==='l'){ // Ctrl/Cmd+L: clear
            e.preventDefault();
            window.Plotly.purge('chart');
          $('#autoPlot').checked=true;
            return;
          }
          if(meta && e.key==='Enter'){ // plot only
            e.preventDefault();
            doPlot();
            return;
          }
          if(e.key==='Enter' && e.shiftKey){ // newline, no plot
            // allow default newline insertion
            setTimeout(()=>{ persist(); },0);
            return;
          }
          if(e.key==='Enter' && !e.shiftKey && !meta){ // newline + plot
            e.preventDefault();
            const start = gx.selectionStart, end = gx.selectionEnd;
            const val = gx.value;
            gx.value = val.slice(0, start) + '\n' + val.slice(end);
            gx.selectionStart = gx.selectionEnd = start + 1;
            persist();
            doPlot();
          }
        });

        if(($('#gx').value||'').trim()) doPlot();
      }

            /* ---------- Torque Intelligence ---------- */
      function renderTorque(){
        const view=$('#view');
        view.innerHTML = `
          <section class="surface">
            <div class="section-title">Torque Intelligence</div>

            <div class="graphlab-grid">
              <div class="panel graphlab-controls">
                <div class="section-title">Converter</div>
                <div class="row">
                  <label style="flex:1">
                    <div class="note">Input</div>
                    <input id="tInVal" class="input" type="number" inputmode="decimal" value="100">
                  </label>
                  <label style="min-width:140px">
                    <div class="note">Unit</div>
                    <select id="tInUnit" class="input">
                      <option value="nm">N·m</option>
                      <option value="ftlb">ft·lb</option>
                      <option value="inlb">in·lb</option>
                    </select>
                  </label>
                </div>

                <div class="row" style="margin-top:10px">
                  <div class="card" style="flex:1">
                    <div class="note">N·m</div>
                    <div class="big" id="tOutNm">—</div>
                  </div>
                  <div class="card" style="flex:1">
                    <div class="note">ft·lb</div>
                    <div class="big" id="tOutFt">—</div>
                  </div>
                  <div class="card" style="flex:1">
                    <div class="note">in·lb</div>
                    <div class="big" id="tOutIn">—</div>
                  </div>
                </div>

                <div class="note" style="margin-top:10px">
                  Tip: use decimals freely. Example: <span class="kbd">74</span> ft·lb → N·m.
                </div>
              </div>

              <div class="panel graphlab-plot">
                <div class="section-title">Fast guidance</div>

                <div class="row" style="gap:12px;flex-wrap:wrap">
                  <label class="pill"><input type="radio" name="tCond" value="dry" checked> Dry</label>
                  <label class="pill"><input type="radio" name="tCond" value="lube"> Lubed</label>
                  <label class="pill"><input type="radio" name="tCond" value="tl"> Threadlocker</label>
                </div>

                <div class="card" style="margin-top:10px">
                  <div class="note">Rule of thumb (not a spec)</div>
                  <div id="tGuidance" style="margin-top:6px;line-height:1.35"></div>
                </div>

                <div class="note" style="margin-top:10px">
                  Always follow the service manual torque spec when you have it. These notes help you avoid the classic “dry vs lubed” mistake.
                </div>
              </div>
            </div>


            <div class="panel" style="margin-top:14px">
              <div class="section-title">Spec note + copy</div>
              <div class="row" style="gap:10px;flex-wrap:wrap">
                <label style="flex:1;min-width:220px">
                  <div class="note">Spec note (saved)</div>
                  <input id="tSpecNote" class="input" type="text" placeholder="Example: wheel lugs, dry, per service manual">
                </label>
                <button class="btn" id="tCopyPlan" type="button">Copy plan</button>
              </div>
              <div class="note" style="margin-top:8px" id="tCopyMsg"></div>
            </div>

            <div class="panel" style="margin-top:14px">
              <div class="section-title">Stage tracker (optional)</div>
              <div class="row" style="justify-content:space-between;align-items:center;flex-wrap:wrap">
                <div class="note">Add stages like 30 → 60 → 90. Tap a stage to mark it done.</div>
                <button class="btn" id="tAddStage" type="button">+ Stage</button>
              </div>

              <div id="tStages" class="stack" style="margin-top:10px"></div>
            </div>
          </section>
        `;

        const NM_PER_FTLB = 1.3558179483314004;
        const NM_PER_INLB = 0.1129848290276167;

        const TORQUE_STORE_KEY = 'legendcalc.torque.v1';
        function loadTorqueState(){
          try{ return JSON.parse(localStorage.getItem(TORQUE_STORE_KEY)||'{}') || {}; }catch(_){ return {}; }
        }
        function saveTorqueState(patch){
          const cur = loadTorqueState();
          const next = Object.assign({}, cur, patch);
          try{ localStorage.setItem(TORQUE_STORE_KEY, JSON.stringify(next)); }catch(_){}
          return next;
        }
        function setCopyMsg(msg){
          const el = $('#tCopyMsg');
          if(!el) return;
          el.textContent = msg || '';
          if(msg){
            setTimeout(()=>{ try{ if(el.textContent===msg) el.textContent=''; }catch(_){ } }, 1600);
          }
        }


        function toNm(val, unit){
          const v = Number(val);
          if(!Number.isFinite(v)) return NaN;
          if(unit==='nm') return v;
          if(unit==='ftlb') return v*NM_PER_FTLB;
          if(unit==='inlb') return v*NM_PER_INLB;
          return NaN;
        }
        function fmt(x){
          if(!Number.isFinite(x)) return '—';
          const a=Math.abs(x);
          const d = a>=100 ? 1 : (a>=10 ? 2 : 3);
          return x.toFixed(d);
        }
        function update(){
          const nm = toNm($('#tInVal').value, $('#tInUnit').value);
          $('#tOutNm').textContent = fmt(nm);
          $('#tOutFt').textContent = fmt(nm / NM_PER_FTLB);
          $('#tOutIn').textContent = fmt(nm / NM_PER_INLB);
        }

        function updateGuidance(){
          const cond = $$('input[name="tCond"]:checked')[0]?.value || 'dry';
          const box = $('#tGuidance');
          if(cond==='dry'){
            box.innerHTML = `Dry threads: use the published torque spec as-is. If you cleaned threads with brake-clean, you're likely in this category.`;
          }else if(cond==='lube'){
            box.innerHTML = `Lubed threads: torque can land higher clamp-load for the same torque. Many manuals call out a different spec when oiled. If no spec is given, be cautious — typical reductions can be ~10–25% depending on fastener and lube.`;
          }else{
            box.innerHTML = `Threadlocker: treat it like a lubricant during tightening (it reduces friction while wet). If a spec calls out threadlocker, follow it. If not, don't “add extra torque” as compensation.`;
          }
        }

        
        // restore saved spec note
        const savedT = loadTorqueState();
        const noteEl = $('#tSpecNote');
        if(noteEl){
          noteEl.value = savedT.specNote || '';
          noteEl.addEventListener('input', ()=> saveTorqueState({specNote: noteEl.value}));
        }

function stageRow(nmValue='30', unit='nm'){
          const row=document.createElement('div');
          row.className='card';
          row.style.display='flex';
          row.style.gap='10px';
          row.style.alignItems='center';
          row.style.flexWrap='wrap';

          const done=document.createElement('button');
          done.type='button';
          done.className='btn';
          done.textContent='○';
          done.title='Toggle done';

          const name=document.createElement('input');
          name.className='input';
          name.placeholder='Stage name (optional)';
          name.style.flex='1';
          name.style.minWidth='160px';

          const val=document.createElement('input');
          val.className='input';
          val.type='number';
          val.inputMode='decimal';
          val.value=nmValue;
          val.style.width='120px';

          const sel=document.createElement('select');
          sel.className='input';
          sel.style.width='120px';
          sel.innerHTML = `<option value="nm">N·m</option><option value="ftlb">ft·lb</option><option value="inlb">in·lb</option>`;
          sel.value=unit;

          const out=document.createElement('div');
          out.className='note';
          out.style.flex='1';
          out.style.minWidth='180px';

          const del=document.createElement('button');
          del.type='button';
          del.className='fxdel';
          del.textContent='×';
          del.title='Remove stage';

          function recompute(){
            const nm = toNm(val.value, sel.value);
            if(!Number.isFinite(nm)) { out.textContent='—'; return; }
            out.textContent = `${fmt(nm)} N·m  •  ${fmt(nm/NM_PER_FTLB)} ft·lb  •  ${fmt(nm/NM_PER_INLB)} in·lb`;
          }

          done.addEventListener('click', ()=>{
            const on = row.dataset.done==='1';
            row.dataset.done = on ? '0' : '1';
            done.textContent = on ? '○' : '✓';
            row.style.opacity = on ? '1' : '.55';
          });
          del.addEventListener('click', ()=> row.remove());
          val.addEventListener('input', recompute);
          sel.addEventListener('change', recompute);

          row.appendChild(done);
          row.appendChild(name);
          row.appendChild(val);
          row.appendChild(sel);
          row.appendChild(out);
          row.appendChild(del);
          recompute();
          return row;
        }

        $('#tInVal').addEventListener('input', update);
        $('#tInUnit').addEventListener('change', update);
        $$('input[name="tCond"]').forEach(r=>r.addEventListener('change', updateGuidance));


        $('#tCopyPlan').addEventListener('click', async ()=>{
          try{
            const cond = $$('input[name="tCond"]:checked')[0]?.value || 'dry';
            const condLabel = (cond==='dry'?'Dry':(cond==='lube'?'Lubed':'Threadlocker'));
            const inVal = $('#tInVal').value;
            const inUnit = $('#tInUnit').value;
            const nm = toNm(inVal, inUnit);
            const line1 = `Torque plan (${condLabel})`;
            const line2 = `Input: ${inVal} ${inUnit==='nm'?'N·m':(inUnit==='ftlb'?'ft·lb':'in·lb')}  →  ${fmt(nm)} N·m`;
            const note = ($('#tSpecNote')?.value||'').trim();
            const stages = Array.from($('#tStages')?.children||[]).map((row,idx)=>{
              const done = row.dataset.done==='1';
              const btn = row.querySelector('button.btn');
              const mark = done ? '✓' : '○';
              const val = row.querySelector('input[type="number"]')?.value || '';
              const sel = row.querySelector('select')?.value || 'nm';
              const u = sel==='nm'?'N·m':(sel==='ftlb'?'ft·lb':'in·lb');
              const nmv = toNm(val, sel);
              return `${mark} Stage ${idx+1}: ${val} ${u}  (${fmt(nmv)} N·m)`;
            });
            const out = [line1, line2, '', 'Stages:', ...stages];
            if(note) out.push('', `Note: ${note}`);
            const text = out.join('\n');

            if(navigator.clipboard && navigator.clipboard.writeText){
              await navigator.clipboard.writeText(text);
              setCopyMsg('Copied.');
            }else{
              // fallback: prompt
              window.prompt('Copy this:', text);
            }
          }catch(e){
            setCopyMsg('Copy failed.');
            try{ logErr(e); }catch(_){}
          }
        });

        $('#tAddStage').addEventListener('click', ()=>{
          $('#tStages').appendChild(stageRow());
        });

        // seed with 3 common stages
        const stageBox = $('#tStages');
        stageBox.appendChild(stageRow('30','nm'));
        stageBox.appendChild(stageRow('60','nm'));
        stageBox.appendChild(stageRow('90','nm'));

        update();
        updateGuidance();
      }




      /* ---------- Unit Converter ---------- */
      function renderUnits(){
        const view=$('#view');
        view.innerHTML=`
          <section class="surface">
            <div class="row">
              <label><div class="note">Value</div><input id="uVal" class="input" type="number" value="1"></label>
              <label><div class="note">From</div>
                <select id="uFromSel" class="input"></select>
              </label>
              <label><div class="note">To</div>
                <select id="uTo" class="input"></select>
              </label>
            </div>
            <div class="row">
              <label><div class="note">Search units</div><input id="uSearch" class="input" placeholder="type to filter (e.g., psi, km, kWh)"></label>
              <div class="btnbar" style="display:flex;align-items:end;gap:8px">
                <button class="btn" id="uSwap">⇄ Swap</button>
                <button class="btn primary" id="uConvert">Convert</button>
                <button class="btn" id="uSmart">Smart Suggest</button>
                <button class="btn" id="clearSavedUnits" title="Forget saved inputs">Clear Saved</button>
              </div>
            </div>
            <div id="uOut" class="section-title"></div>
            <div class="note">Dropdown uses categories; only compatible targets are shown. Search filters both lists. "Smart Suggest" picks a human-friendly unit. No miles → cups.</div>
          </section>`;

        const toSel=$('#uTo');
        const fromSel=$('#uFromSel');
        const searchEl=$('#uSearch');
        const setOut = (html)=>{ $('#uOut').innerHTML = html; };

        const catalogByGroup = unitGroups();
        const catalogByDim = unitCatalogByDim(catalogByGroup);
        let currentFromList=[];

        function populateFrom(filter=''){
          const q=filter.trim().toLowerCase();
          fromSel.innerHTML = Object.entries(catalogByGroup)
            .map(([group, units])=>{
              const items=units.filter(u=>u.toLowerCase().includes(q));
              if(!items.length) return '';
              return `<optgroup label="${group}">${items.map(u=>`<option value="${u}">${u}</option>`).join('')}</optgroup>`;
            }).join('');
        }

        const saved = loadTab('units', {val:'1', from:'m', to:'km', out:'', search:''});
        populateFrom(saved.search||'');
        fromSel.value = saved.from || 'm';
        $('#uVal').value = saved.val || '1';
        searchEl.value = saved.search || '';

        function persist(){ const state={ val:$('#uVal').value, from:fromSel.value, to:$('#uTo').value, out:$('#uOut').innerHTML, search:searchEl.value }; saveTab('units', state); }

        function refreshTargets(){
          const from = fromSel.value.trim();
          try{
            const u = math.unit(1, from);
            const dimKey = JSON.stringify(u.dimensions);
            currentFromList = (catalogByDim[dimKey]||[]).sort();
            toSel.innerHTML = currentFromList.map(x=>`<option value="${x}">${x}</option>`).join('');
            if(!currentFromList.length){ toSel.innerHTML='<option>(no compatible units)</option>'; }
          }catch(e){ toSel.innerHTML='<option>(invalid unit)</option>'; currentFromList=[]; }
        }

        function smartSuggest(){
          const v = parseFloat($('#uVal').value); const from = fromSel.value.trim();
          try{
            const q=math.unit(v,from);
            const dimKey = JSON.stringify(q.dimensions);
            const list = (catalogByDim[dimKey]||[]);
            if(!list.length) return setOut('(no match)');
            let best = from; let bestDelta = 1e9;
            for(const cand of list){ const conv = q.to(cand).toNumber(cand); const d = score(conv); if(d<bestDelta){ best=cand; bestDelta=d; } }
            toSel.value = best; convert();
          }catch(e){ setOut('Invalid'); }
        }

        function convert(){
          const v=parseFloat($('#uVal').value); const from=fromSel.value.trim(); const to=toSel.value;
          try{ const out = math.unit(v,from).to(to); const num = out.toNumber(to); const txt = `${v} ${from} = <b>${format(num)}</b> ${to}`; setOut(txt); return txt; }
          catch(e){ setOut('<span class="err">Incompatible or invalid units</span>'); }
        }

        function score(x){ const ax=Math.abs(x); if(ax===0) return 0; const k=Math.log10(ax); return Math.abs(k-1.5); }
        function format(x){ const a=Math.abs(x); if(a>=1e6||a<1e-3) return x.toExponential(6); return (+x.toPrecision(12)).toString(); }

        function unitGroups(){
          return {
            Length:['mm','cm','m','km','in','ft','yd','mi','nmi'],
            Mass:['mg','g','kg','lb','oz'],
            Time:['ms','s','min','hour','day'],
            Area:['mm^2','cm^2','m^2','km^2','in^2','ft^2','yd^2','acre','ha'],
            Volume:['mL','L','cm^3','m^3','in^3','ft^3','gal','qt','pt','cup','tbsp','tsp'],
            Speed:['m/s','km/h','mph','ft/s','kt'],
            Acceleration:['m/s^2','ft/s^2','g'],
            Force:['N','lbf','kip'],
            Energy:['J','kJ','cal','kcal','Wh','kWh','BTU'],
            Power:['W','kW','hp','BTU/h'],
            Pressure:['Pa','kPa','bar','psi','inHg','mmHg','atm'],
            Temperature:['degC','degF','K','degR'],
            Density:['kg/m^3','g/cm^3','lb/ft^3'],
            Torque:['N m','lbf ft']
          };
        }
        function unitCatalogByDim(groups){ const map={}; for(const arr of Object.values(groups)){ for(const u of arr){ try{ const dim = JSON.stringify(math.unit(1,u).dimensions); if(!map[dim]) map[dim]=new Set(); arr.forEach(x=>map[dim].add(x)); }catch(e){} } } for(const d in map){ map[d]=[...map[d]]; } return map; }

        fromSel.addEventListener('change', ()=>{ refreshTargets(); smartSuggest(); persist(); });
        $('#uVal').addEventListener('input', ()=> { smartSuggest(); persist(); });
        $('#uSmart').onclick = ()=>{ smartSuggest(); persist(); };
        $('#uConvert').onclick = ()=>{ convert(); persist(); };
        $('#clearSavedUnits').onclick = ()=>{ clearTab('units'); $('#uVal').value='1'; searchEl.value=''; populateFrom(''); fromSel.value='m'; refreshTargets(); smartSuggest(); };
        $('#uSwap').onclick = ()=>{ const f=fromSel.value; const t=toSel.value;
          if(currentFromList.includes(f) && currentFromList.includes(t)) { fromSel.value=t; refreshTargets(); toSel.value=f; smartSuggest(); persist(); } else {
            const temp=f; fromSel.value=t; refreshTargets(); toSel.value=temp; smartSuggest(); persist(); }
        };
        searchEl.addEventListener('input', ()=>{ populateFrom(searchEl.value);
          if(![...fromSel.options].some(o=>o.value===saved.from)) fromSel.selectedIndex=0; refreshTargets(); smartSuggest(); persist(); });

        refreshTargets();
        if(saved.to){ try{ const u = math.unit(1, fromSel.value); const dimKey=JSON.stringify(u.dimensions); const list=(catalogByDim[dimKey]||[]); if(list.includes(saved.to)) $('#uTo').value=saved.to; }catch(e){} }
        if(saved.out){ setOut(saved.out); } else { smartSuggest(); }
      }

     function renderTime(){
        const view=$('#view');
        const PREFS = loadPrefs();
        const time12 = !!PREFS.time12;
        const ocuPref = (typeof PREFS.ocuMode === 'boolean') ? (PREFS.ocuMode ? '7a7p' : 'off') : (PREFS.ocuMode || 'off');

        view.innerHTML=`
          <section class="surface">
            <div class="row">
              <label><div class="note">Goal hours today</div><input id="goalH" class="input" type="number" step="0.25" value="8"></label>
              <label><div class="note">Paid lunch</div>
                <select id="paidL" class="input">
                  <option value="0">Unpaid</option>
                  <option value="0.3333333">20 min paid</option>
                  <option value="0.5">30 min paid</option>
                  <option value="1">1 hour paid</option>
                </select>
              </label>
              <label><div class="note">🕒 Time format</div>
                <select id="timeFmt" class="input">
                  <option value="24">24-hour</option>
                  <option value="12">12-hour (AM/PM)</option>
                </select>
              </label>
              <label><div class="note">🏷️ OCU rounding</div>
                <select id="ocuMode" class="input"></select>
              </label>
            </div>

            <div class="section-title">Custom OCU preset</div>
            <div class="row">
              <label><div class="note">Name</div><input id="ocuName" class="input" placeholder="e.g., My 5a–1p"></label>
              <label><div class="note">IN time</div><input id="ocuIn" class="input" type="time" value="07:00"></label>
              <label><div class="note">OUT time</div><input id="ocuOut" class="input" type="time" value="19:00"></label>
              <label><div class="note">Window ± (min)</div><input id="ocuWin" class="input" type="number" value="10"></label>
              <div style="display:flex;align-items:end"><button class="btn" id="saveOcu">Save preset</button></div>
            </div>

            <div class="section-title">Shifts</div>
            <div id="rows"></div>
            <div class="btnbar" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"><button class="btn primary" id="addRow">+ Add Interval</button><button class="btn" id="nowIn">Clock In Now</button><button class="btn" id="nowOut">Clock Out Now</button><button class="btn" id="clearSavedTime" title="Forget saved inputs">Clear Saved</button></div>

            <div class="two-col" style="margin-top:16px">
              <div class="surface">
                <div class="section-title">Today Summary</div>
                <div id="todayOut"></div>
                 <div class="hr"></div>
                 <div class="section-title">Make the total</div>
                 <div class="row" style="gap:10px;flex-wrap:wrap">
                   <label><div class="note">Total goal (h)</div><input id="totalGoal" class="input" type="number" step="0.25" value="40"></label>
                   <label><div class="note">So far (h)</div><input id="totalSoFar" class="input" type="number" step="0.01" value="0"></label>
                   <label><div class="note">Next IN</div><input id="nextIn" class="input" type="time"></label>
                   <label><div class="note">Unpaid break (min)</div><input id="breakUnpaid" class="input" type="number" value="0"></label>
                 </div>
                 <div id="totalNeedOut" class="note" style="margin-top:6px"></div>
              </div>
              <div class="surface">
                <div class="section-title">Guidance</div>
                <div id="guide"></div>
              </div>
            </div>

            <div class="surface" style="margin-top:16px">
              <div class="section-title">Week Summary (by date)</div>
              <div id="week"></div>
            </div>
          </section>`;

        const rowsEl=$('#rows');
        const fmtSel=$('#timeFmt');
        const ocuSel=$('#ocuMode');

        const builtIns=[
          {id:'off', label:'Off'},
          {id:'7a7p', label:'7a/7p ±10m', inTarget:7*60, outTarget:19*60, win:10},
          {id:'6a4p', label:'6a/4p ±10m', inTarget:6*60, outTarget:16*60, win:10},
          {id:'7a3p', label:'7a/3p ±10m', inTarget:7*60, outTarget:15*60, win:10},
        ];
        function renderOcuOptions(){
          const PREFS=loadPrefs();
          const customs = Array.isArray(PREFS.ocuCustoms)? PREFS.ocuCustoms : [];
          const customOpts = customs.map((c,i)=>`<option value="custom:${i}">${esc(c.name)} (${minutesToClock(c.inTarget)}–${minutesToClock(c.outTarget)} ±${c.win}m)</option>`).join('');
          ocuSel.innerHTML = builtIns.map(b=>`<option value="${b.id}">${b.label}</option>`).join('') + (customOpts? `<optgroup label="Custom">${customOpts}</optgroup>`:'');
          ocuSel.value = (PREFS.ocuMode ?? 'off');
        }
        renderOcuOptions();

        fmtSel.value = time12 ? '12' : '24';

        const todayStr = toLocalDate(new Date());
        const saved = loadTab('time', {goalH:'8', paidL:'0', totalGoal:'40', totalSoFar:'0', nextIn:'', breakUnpaid:'0', rows:[{date:todayStr,in:'',out:''}]});
        $('#goalH').value = saved.goalH || '8';
        $('#paidL').value = saved.paidL || '0';
        $('#totalGoal').value = saved.totalGoal || '40';
        $('#totalSoFar').value = saved.totalSoFar || '0';
        $('#nextIn').value = saved.nextIn || '';
        $('#breakUnpaid').value = saved.breakUnpaid || '0';


        rowsEl.addEventListener('input', ()=>{ recompute(); persist(); });
        rowsEl.addEventListener('click', e=>{
          const id=e.target.getAttribute('data-del');
          if(id){ const row=e.target.closest('.row'); if(row) row.remove(); recompute(); persist(); }
        });

        fmtSel.addEventListener('change',()=>{ savePrefs({...loadPrefs(), time12: ($('#timeFmt').value==='12')}); recompute(); });
        ocuSel.addEventListener('change',()=>{ savePrefs({...loadPrefs(), ocuMode: ($('#ocuMode').value)}); recompute(); });

        $('#saveOcu').onclick=()=>{
          const name=$('#ocuName').value.trim()||'Custom'; const i=$('#ocuIn').value, o=$('#ocuOut').value, w=parseInt($('#ocuWin').value||'10',10);
          if(!i||!o||Number.isNaN(w)) return alert('Fill name, in, out, window');
          const entry={name, inTarget:toMin(i), outTarget:toMin(o), win:Math.max(0,Math.min(60,w))};
          const prefs=loadPrefs(); const arr=Array.isArray(prefs.ocuCustoms)? prefs.ocuCustoms:[]; arr.push(entry); prefs.ocuCustoms=arr; savePrefs(prefs);
          renderOcuOptions(); $('#ocuMode').value=`custom:${arr.length-1}`; savePrefs({...loadPrefs(), ocuMode:$('#ocuMode').value}); recompute();
        };

        $('#clearSavedTime').onclick=()=>{ clearTab('time'); rowsEl.innerHTML=''; addRow(); recompute(); };

        function persist(){
          const rows = $$('input[data-in]').map(inp=>{
            const id=inp.getAttribute('data-in'); const out=$(`input[data-out="${id}"]`); const date=$(`input[data-date="${id}"]`);
            return {date: (date&&date.value)||todayStr, in: inp.value||'', out: (out&&out.value)||''};
          });
          saveTab('time', {goalH:$('#goalH').value||'8', paidL:$('#paidL').value||'0', totalGoal:$('#totalGoal').value||'40', totalSoFar:$('#totalSoFar').value||'0', nextIn:$('#nextIn').value||'', breakUnpaid:$('#breakUnpaid').value||'0', rows});
        }

        function addRow(initial){
          const id=Math.random().toString(36).slice(2,7);
          const row=document.createElement('div');
          row.className='row';
          row.innerHTML=`
            <label><div class="note">Date</div><input class="input" type="date" data-date="${id}"></label>
            <label><div class="note">In</div><input class="input" type="time" data-in="${id}"></label>
            <label><div class="note">Out</div><input class="input" type="time" data-out="${id}"></label>
            <div style="display:flex;align-items:end"><button class="btn" data-del="${id}">Delete</button></div>`;
          rowsEl.appendChild(row);
          const dEl=$(`[data-date="${id}"]`), ins=$(`[data-in="${id}"]`), outs=$(`[data-out="${id}"]`);
          dEl.value = (initial&&initial.date) || toLocalDate(new Date());
          if(initial){ ins.value=initial.in||''; outs.value=initial.out||''; }
        }

        function recompute(){
          const prefs = loadPrefs();
          const use12 = !!prefs.time12;
          const mode = (typeof prefs.ocuMode==='boolean') ? (prefs.ocuMode? '7a7p':'off') : (prefs.ocuMode||'off');
          const preset = getOcuPreset(mode);
          const paid = parseFloat($('#paidL').value)||0;

          const segs=[]; $$('input[data-in]').forEach(inp=>{
            const id=inp.getAttribute('data-in'); const o=$(`input[data-out="${id}"]`); const d=$(`input[data-date="${id}"]`);
            if(inp.value){ segs.push({date:(d&&d.value)||toLocalDate(new Date()), in:inp.value, out:o&&o.value||null}); }
          });

          const today = toLocalDate(new Date());
          let minutesClosed=0; let openIn=null; let openInRounded=null;
          segs.filter(s=>s.date===today).forEach(s=>{
            let i=toMin(s.in); if(preset) i = roundInToPreset(i, preset);
            if(s.out){ let o=toMin(s.out); if(preset) o = roundOutToPreset(o, preset); minutesClosed += Math.max(0,o-i); }
            else { openIn = toMin(s.in); openInRounded = preset? roundInToPreset(openIn, preset): openIn; }
          });

          const paidMin = paid*60;
          const goalH=parseFloat($('#goalH').value)||8; const goalMin=goalH*60;
          const workedMin = minutesClosed + paidMin + (openIn!==null ? 0 : 0);
          const remainingToGoal = clamp(goalMin - workedMin, 0, 24*60);

          let suggested='—';
          if(openIn!==null){
            const need = clamp(goalMin - (minutesClosed + paidMin), 0, 24*60);
            let outMin = (preset? openInRounded: openIn) + need;
            if(preset) outMin = roundOutToPreset(outMin, preset);
            suggested = formatClock(outMin, use12);
          }

          const inProgText = openIn!==null ? ` • In-progress from <b>${formatClock(preset?openInRounded:openIn, use12)}</b>` : '';
          $('#todayOut').innerHTML = `Worked: <b>${fmtH(minutesClosed + paidMin)}</b>${inProgText} • Remaining to goal: <b>${fmtH(remainingToGoal)}</b>`;
          $('#guide').innerHTML = openIn!==null
            ? `Clocked in since <b>${formatClock(preset?openInRounded:openIn, use12)}</b> — to hit <b>${goalH}h</b>, clock out at <b>${suggested}</b>${preset? ' <span class="note">(OCU rounding)</span>':''}.`
            : `Not currently clocked in for today.`;

           // Total goal helper (week/period)
           const totalGoalH = parseFloat($('#totalGoal').value)||0;
           const totalSoFarH = parseFloat($('#totalSoFar').value)||0;
           const needH = Math.max(0, totalGoalH - totalSoFarH);
           const needMin = Math.round(needH*60);
           const breakUnpaidMin = Math.max(0, Math.min(240, parseInt($('#breakUnpaid').value||'0',10)||0));
           let outStr = '—';
           const nextInVal = $('#nextIn').value;
           if(nextInVal){
             const inMin = toMin(nextInVal);
             const outMin = inMin + needMin + breakUnpaidMin;
             outStr = formatClock(outMin, use12);
           }
           const needTxt = needH>0 ? fmtH(needMin) : '0h 00m';
           const extra = breakUnpaidMin? ` (+${breakUnpaidMin}m unpaid break)` : '';
           $('#totalNeedOut').innerHTML =
             'Need <b>' + needTxt + '</b> to reach <b>' + totalGoalH + 'h</b> (currently ' + totalSoFarH + 'h)' + extra + '. ' +
             (nextInVal
               ? ('If you clock in at <b>' + formatClock(toMin(nextInVal), use12) + '</b>, work until <b>' + outStr + '</b>.')
               : '<span class="note">Set Next IN to get an end time.</span>');


          // Week summary
          const byDay=new Map();
          segs.forEach(s=>{
            let i=toMin(s.in); let o = s.out? toMin(s.out): null; if(preset){ i=roundInToPreset(i,preset); if(o!==null) o=roundOutToPreset(o,preset); }
            const mins = (o!==null? Math.max(0,o-i): 0);
            byDay.set(s.date, (byDay.get(s.date)||0)+mins);
          });
          const days = [...byDay.keys()].sort();
          const paidMinPerDay = paid*60;
          let weekHTML = `<table><thead><tr><th>Date</th><th>Worked</th><th>+ Paid Lunch</th><th>Total</th></tr></thead><tbody>`;
          let grand=0;
          days.forEach(d=>{ const w=byDay.get(d); const lunch = (w>0? paidMinPerDay:0); const tot=w+lunch; grand+=tot; weekHTML+=`<tr><td>${d}</td><td>${fmtH(w)}</td><td>${lunch?fmtH(lunch):'—'}</td><td><b>${fmtH(tot)}</b></td></tr>`; });
          weekHTML += `</tbody></table><div class="note">Grand total (listed days): <b>${fmtH(grand)}</b></div>`;
          $('#week').innerHTML = weekHTML;
        }

        function getOcuPreset(mode){
          const win=10;
          if(mode==='7a7p') return {inTarget:7*60, outTarget:19*60, win};
          if(mode==='6a4p') return {inTarget:6*60, outTarget:16*60, win};
          if(mode==='7a3p') return {inTarget:7*60, outTarget:15*60, win};
          if(mode && mode.startsWith('custom:')){
            const prefs=loadPrefs(); const customs=prefs.ocuCustoms||[]; const i=parseInt(mode.split(':')[1],10); const c=customs[i]; if(c) return c;
          }
          return null;
        }
        function withinWindow(min,target,win){ return Math.abs(min - target) <= win; }
        function roundInToPreset(min,p){ return withinWindow(min,p.inTarget,p.win)? p.inTarget : min; }
        function roundOutToPreset(min,p){ return withinWindow(min,p.outTarget,p.win)? p.outTarget : min; }

        function toMin(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
        function minutesToClock(min){ const m=((min%1440)+1440)%1440; const h=Math.floor(m/60); const mm=String(Math.round(m%60)).padStart(2,'0'); return `${h}:${mm}`; }
        function formatClock(min,use12){ const t=minutesToClock(min); if(!use12) return t; const [hh,mm]=t.split(':').map(Number); const ampm = hh>=12? 'PM':'AM'; const h12 = (hh%12)||12; return `${h12}:${String(mm).padStart(2,'0')} ${ampm}`; }
        function fmtH(min){ const h=Math.floor(min/60); const m=Math.round(min%60); return `${h}h ${String(m).padStart(2,'0')}m`; }

        $('#addRow').onclick=()=>{ addRow(); persist(); };
        $('#nowIn').onclick=()=>{ const now=new Date(); addRow({date:toLocalDate(now), in: toLocalTime(now)}); persist(); };
        $('#nowOut').onclick=()=>{ const inputs=$$('input[data-out]'); const open=[...inputs].find(i=>!i.value); if(open){ open.value=toLocalTime(new Date()); recompute(); persist(); } };
        $('#goalH').addEventListener('input',()=>{ recompute(); persist(); });
        $('#paidL').addEventListener('change',()=>{ recompute(); persist(); });
        $('#totalGoal').addEventListener('input',()=>{ recompute(); persist(); });
        $('#totalSoFar').addEventListener('input',()=>{ recompute(); persist(); });
        $('#nextIn').addEventListener('change',()=>{ recompute(); persist(); });
        $('#breakUnpaid').addEventListener('input',()=>{ recompute(); persist(); });

        if(saved.rows && saved.rows.length){ saved.rows.forEach(r=>addRow(r)); } else { addRow(); }
        recompute();

        function toLocalTime(d){ const hh=String(d.getHours()).padStart(2,'0'); const mm=String(d.getMinutes()).padStart(2,'0'); return `${hh}:${mm}`; }
        function toLocalDate(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
      }

      e()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
      }

      /* ---------- Self-tests ---------- */
      function runSelfTests(){
        const results=[];
        const pass=(name)=>{ results.push(`<div class='pass'>✔ ${name}</div>`); };
        const fail=(name,msg)=>{ results.push(`<div class='fail'>✖ ${name} — ${msg||''}</div>`); };

        try{ const v=math.evaluate('2+2'); (v===4)?pass('Calc: 2+2=4'):fail('Calc: 2+2','got '+v); }catch(e){ fail('Calc basic',e.message); }
        try{ const d=window.math.derivative('x^2','x').toString(); const f=window.math.parse(d).compile(); const val=f.evaluate({x:3}); (Math.abs(val-6)<1e-9)?pass('Calculus: d/dx x^2 at x=3 = 6'):fail('Calculus derivative at point','got '+val); }catch(e){ fail('Calculus derivative',e.message); }
        try{ const q=math.unit(1600,'m').to('km').toNumber('km'); (Math.abs(q-1.6)<1e-12)?pass('Units: 1600 m → 1.6 km'):fail('Units convert','got '+q); }catch(e){ fail('Units convert',e.message); }
        try{ const dimMi = JSON.stringify(math.unit(1,'mi').dimensions); const dimCup = JSON.stringify(math.unit(1,'cup').dimensions); (dimMi!==dimCup)?pass('Units: miles not compatible with cups'):fail('Units: miles vs cups dimension check'); }catch(e){ fail('Units incompatibility check',e.message); }
        try{ const f=window.math.parse('(sin(x))/x').compile(); const lim=(()=>{const eps=1e-6; return (f.evaluate({x:0+eps})+f.evaluate({x:0-eps}))/2;})(); (Math.abs(lim-1)<1e-3)?pass('Limit: sin(x)/x → 1 at 0'):fail('Limit numeric','got '+lim); }catch(e){ fail('Limit numeric',e.message); }
        try{ const tape = [{e:'1+1',v:2},{e:'2*3',v:6}]; const str = tape.map(t=>`${t.e} = ${t.v}`).reverse().join('\n'); (str.includes('\n') && str.split('\n').length===2)?pass('Tape: newline join works'):fail('Tape join','got '+str); }catch(e){ fail('Tape join test',e.message); }
        try{ const cToF = math.unit(100, 'degC').to('degF').toNumber('degF'); (Math.abs(cToF - 212) < 1e-9) ? pass('Temp: 100°C → 212°F') : fail('Temp conversion','got '+cToF); }catch(e){ fail('Temp conversion test', e.message); }
        try{ const t24 = (function(){ const m=13*60+5; const h=Math.floor(m/60); const mm=String(m%60).padStart(2,'0'); return `${h}:${mm}`; })(); const t12 = (function(){ const m=13*60+5; const h=Math.floor(m/60); const mm=String(m%60).padStart(2,'0'); const ampm=h>=12?'PM':'AM'; const h12=(h%12)||12; return `${h12}:${mm} ${ampm}`; })(); (t24==='13:05' && t12==='1:05 PM') ? pass('Time format: 24h/12h formatting') : fail('Time format','24='+t24+', 12='+t12); }catch(e){ fail('Time format test', e.message); }

        document.getElementById('selfTests').innerHTML = `<div class='section-title'>Self-Tests</div>${results.join('')}`;
      }

      armAudioUnlock();
      initDebugUI();
      initSettingsUI();
      applyBigUI();
      applyOneHand();
      syncSettingsUI();
      syncSoundUI();

      /* ---------- Sound ---------- */
      function renderSound(){
        const view=$('#view');
        const mode=getSoundMode();
        view.innerHTML = `
          <section class="surface">
            <div class="section-title">Sound</div>
            <div class="grid">
              <div class="panel">
                <div class="section-title">Mode</div>
                <div class="row" style="gap:12px;flex-wrap:wrap">
                  <label class="pill"><input type="radio" name="soundMode" value="off"> Off</label>
                  <label class="pill"><input type="radio" name="soundMode" value="clicks"> Clicks</label>
                  <label class="pill"><input type="radio" name="soundMode" value="fanfare"> Fanfare</label>
                </div>
                <div class="hint" style="margin-top:10px">Tip: On iPhone, audio needs the first tap to “wake up.”</div>
              </div>

              <div class="panel">
                <div class="section-title">Test</div>
                <div class="row btnbar">
                  <button class="btn" id="testClick">Test Click</button>
                  <button class="btn" id="testFanfare">Test Fanfare</button>
                </div>
                <div class="hint" style="margin-top:10px">These are original “fantasy chimes” (inspired vibe, not copied).</div>
              </div>
            </div>
          </section>
        `;

        // Wire UI
        syncSoundUI();
        $$('input[name="soundMode"]').forEach(r=>{
          r.addEventListener('change', ()=> setSoundMode(r.value));
        });
        $('#testClick').addEventListener('click', ()=>{ ensureAudio(); beep(220,0.05,'square',0.02,0); toast('Click'); });
        $('#testFanfare').addEventListener('click', ()=>{ ensureAudio(); fanfareSound(); toast('Fanfare'); });
      }

      render('calc');
      runSelfTests();
    }
  })();
  

/* ---------- Touch feedback helpers ---------- */
(function(){
  // Some platforms support Vibration API; iOS Safari generally does NOT.
  function tryVibrate(ms){
    try{
      if (navigator && typeof navigator.vibrate === "function") navigator.vibrate(ms);
    }catch(_){}
  }

  // Subtle click using WebAudio (works broadly). Respects reduced motion.
  let audioCtx = null;
  
  // Global pointer feedback for on-screen buttons
  document.addEventListener("pointerdown", (e)=>{
    const btn = e.target.closest("button, input[type=\"button\"], input[type=\"submit\"], .tab, .key, .btn");
    if(!btn) return;
    tryVibrate(8);
        try{ if(window.__LC_clickSound) window.__LC_clickSound(); }catch(_){ }
  }, {passive:true});
})();

</script>
</body>
</html>
