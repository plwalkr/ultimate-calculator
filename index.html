<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
      <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LegendCalc">
    <meta name="theme-color" content="#0b1a12" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#f6f5ef" media="(prefers-color-scheme: light)">
<title>LegendCalc Suite (Math + Time Clock) — Unzipped</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.cdnfonts.com/css/ringbearer" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1115;--card:#161a22;--screen:#0b0e13;--ink:#f3f6ff;--muted:#97a3b6;--accent:#5bd38e;--accent-2:#2b78e4;
      --key:#222836;--key-op:#2b3144;--key-fn:#1e2433;--key-eq:#2b78e4;--ring:#fbe62c;--error:#ff6b6b;--ok:#5bd38e;
      --radius:16px;--shadow:0 20px 60px #0005;
      --tab-bg:#1a2030; --tab-fg:#9db0d0; --tab-active-bg:#2b78e4; --tab-active-fg:#fff;
      --control-bg:#0e131c; --control-bd:#263046;
    
      --panel:var(--card);
      --border:var(--control-bd);
      --toast-bg:#0b1410;
      --toast-fg:#eafff3;
    }
    /* Light theme: higher contrast fixes */
    .theme-light{
      --bg:#f7f9ff; --card:#ffffff; --screen:#eef3ff; --ink:#0b1020; --muted:#49556c;
      --accent:#205fbe; --accent-2:#205fbe;

      --key:#f0f4ff;
      --key-op:#e8eefc;
      --key-fn:#e6f0ff;
      --key-eq:#205fbe;

      --tab-bg:#e7eefc; --tab-fg:#1a3358; --tab-active-bg:#205fbe; --tab-active-fg:#ffffff;
      --control-bg:#ffffff; --control-bd:#c9d7ef;
    
      --toast-bg:var(--card);
      --toast-fg:var(--ink);
    }
    /* TI-Nspire themed (tighter contrast + LCD vibe) */
    .theme-inspire{
      --bg:#14171b; --card:#0c0f12; --screen:#081017; --ink:#e8f2ff; --muted:#a7bad1;
      --accent:#00e38f; --accent-2:#00a2ff;
      --key:#0e141b; --key-op:#141b23; --key-fn:#0b1218; --key-eq:#00a2ff;
      --tab-bg:#0d1622; --tab-fg:#c1d2e6; --tab-active-bg:#00a2ff; --tab-active-fg:#ffffff;
      --control-bg:#0f141a; --control-bd:#2c3c4c;
    
      --toast-bg:var(--card);
      --toast-fg:var(--ink);
    }

    *{box-sizing:border-box}
    html,html,body{height:auto;min-height:100%;overflow-x:hidden}
    body{min-height:100vh}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#0e121a);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:14px;gap:12px;flex-wrap:wrap}
    h1{font-family:Ringbearer,Inter,serif;letter-spacing:1px;font-size:1.8rem;margin:0;color:var(--accent)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:0;background:var(--tab-bg);color:var(--tab-fg);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800}
    .tab.active{background:var(--tab-active-bg);color:var(--tab-active-fg)}
    .surface{background:var(--card);border-radius:18px;box-shadow:var(--shadow);padding:16px}

    .theme-picker{display:flex;align-items:center;gap:8px;margin-left:auto;padding-top:4px}
    .theme-select{background:var(--control-bg);border:1.5px solid var(--control-bd);border-radius:12px;color:var(--ink);padding:10px;font-size:0.95rem;min-height:44px}

    .calc-grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    @media (max-width:900px){.calc-grid{grid-template-columns:1fr}}
    .screen{background:linear-gradient(180deg,var(--screen),#0a0d12);border:1px solid #1e2533;border-radius:16px;padding:14px;min-height:130px;position:relative;overflow:hidden}
    .expr{color:#9db0d0;min-height:24px}
    .result{font-size:2.2rem;font-weight:800;word-break:break-all}
    .keys{display:grid;grid-template-columns:repeat(6,minmax(60px,1fr));gap:8px;margin-top:12px}
    .key{border:1px solid transparent;border-radius:14px;padding:14px 10px;background:var(--key);color:#eaf0ff;font-weight:800;cursor:pointer;box-shadow:inset 0 -2px 0 #0008}
    .key.op{background:var(--key-op)}
    .key.fn{background:var(--key-fn)}
    .key.eq{background:var(--key-eq)}
    .key:active{transform:translateY(1px)}
    .span2{grid-column:span 2}
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    .input, select, textarea{background:var(--control-bg);border:1.5px solid var(--control-bd);border-radius:12px;color:var(--ink);padding:10px;font-size:1rem}
    .btn{border:1px solid var(--control-bd);background:#22304a;color:#cfe0ff;font-weight:800;border-radius:12px;padding:10px 14px;cursor:pointer;min-height:44px}
    .btn.primary{background:var(--accent-2);color:#fff;border-color:#0b5fb8}

    /* Light theme button label contrast fix */
    .theme-light .key{ color:#0b1020; border-color:#d6e3fb; box-shadow:inset 0 -2px 0 #c9d7ef; }
    .theme-light .btn{ background:#eaf1ff; color:#0b1020; border-color:#c9d7ef; }
    .theme-light .result{ color:#0b1020; }
    .theme-light .expr{ color:#2f4466; }

    .tape{min-height:240px;max-height:60vh;overflow:auto;resize:vertical;padding-right:4px}
    .trow{display:flex;justify-content:space-between;gap:10px;padding:8px;border-bottom:1px dashed #25304a;font-size:.95rem}
    .theme-light .trow{ border-bottom-color:#d6e3fb; }
    .trow .l{color:#9db0d0}
    .theme-light .trow .l{ color:#5574a6; }

    .section-title{margin:8px 0 10px;color:#9bd3ff}
    .theme-light .section-title{ color:#205fbe; }
    .note{color:var(--muted);font-size:.9rem}

    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.two-col{grid-template-columns:1fr}}

    .chart{width:100%;height:380px;min-height:320px;height:380px;width:100%;}

    .ok{color:var(--ok)} .err{color:var(--error)}
    .tests{margin-top:12px;font-size:.9rem}
    .tests .pass{color:#5bd38e}
    .tests .fail{color:#ff6b6b}

    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #223046;text-align:left}
    th{color:#9bd3ff}
    .theme-light th{ color:#205fbe; }
    .theme-light td{ border-bottom-color:#d6e3fb; }

    
    #diag.ok{display:block;background:#0f2a1c;color:#c6ffdf;border:1px solid #31c27c}
    #diag.warn{display:block;background:#2a2a0f;color:#f8ffb3;border:1px solid #f5e160}
    #diag.err{display:block;background:#3b1116;color:#ffd5d5;border:1px solid #ff6b6b}

    /* TI-Nspire vibe: LCD grid and beveled keys (stronger contrast) */
    .theme-inspire .screen{
      background:linear-gradient(180deg,#0b1016,#090e14);
      border:1px solid #23303b;
      box-shadow:inset 0 1px 0 #2b3f50, inset 0 -1px 0 #070a0e;
    }
    .theme-inspire .screen::before{
      content:"";
      position:absolute; inset:0;
      background-image:
        linear-gradient(#1f2a34 1px, transparent 1px),
        linear-gradient(90deg,#1f2a34 1px, transparent 1px);
      background-size: 22px 22px, 22px 22px;
      opacity:.22; pointer-events:none;
    }
    .theme-inspire .key{
      background:#0f141a; border:1px solid #253342; border-radius:10px; color:#e7f5ff;
      box-shadow:inset 0 -2px 0 #0008, 0 1px 0 #0a0d10;
    }
    .theme-inspire .key.op{ background:#121923; }
    .theme-inspire .key.fn{ background:#0d141c; }
    .theme-inspire .key.eq{
      background:#00a2ff; border-color:#0b5fb8; color:#fff;
      box-shadow:inset 0 -2px 0 #064b91, 0 1px 0 #0a0d10;
    }
    .theme-inspire .key:active{ transform:none; box-shadow:inset 0 2px 0 #0006; }

    /* Focus rings per theme */
    .theme-light :is(.btn,.key,.input,select,textarea,.tab):focus-visible{ outline:2px solid #205fbe; outline-offset:2px; }
    .theme-inspire :is(.btn,.key,.input,select,textarea,.tab):focus-visible{ outline:2px solid #00e38f; outline-offset:2px; }
    :root :is(.btn,.key,.input,select,textarea,.tab):focus-visible{ outline:2px solid #5bd38e; outline-offset:2px; }
  
/* ---------- Mobile + touch improvements (safe for desktop) ---------- */
:root{
  --safe-top: env(safe-area-inset-top);
  --safe-right: env(safe-area-inset-right);
  --safe-bottom: env(safe-area-inset-bottom);
  --safe-left: env(safe-area-inset-left);
}

*{
  -webkit-tap-highlight-color: transparent;
}

button{
  touch-action: manipulation;
}

@media (max-width: 520px){
  /* keep content inside safe areas */
  body{
    padding: calc(10px + var(--safe-top)) calc(10px + var(--safe-right))
             calc(12px + var(--safe-bottom)) calc(10px + var(--safe-left));
    font-size: 16px;
  }

  /* header stacks cleanly */
  header{
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }

  /* tabs: big tap targets + horizontal scroll (prevents overlap) */
  .tabs{
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 2px;
    display: flex;
    flex-wrap: nowrap;
    gap: 10px;
  }
  .tab{
    flex: 0 0 auto;
    text-align: center;
    padding: 12px 14px;
    border-radius: 14px;
    min-height: 48px;
    font-size: 0.95rem;
    letter-spacing: 0.01em;
    white-space: nowrap;
  }

  .theme-picker{
    width: 100%;
    justify-content: space-between;
  }
  .theme-select{
    width: min(220px, 55vw);
  }

  /* general tap targets */
  button{
    min-height: 52px;
    font-size: 1.05rem;
    border-radius: 14px;
  }

  /* single-column forms (prevents squeezed/overlapping rows) */
  .row{
    grid-template-columns: 1fr;
  }

  /* button bars stack cleanly */
  .btnbar{
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .btnbar > button{
    flex: 1 1 calc(50% - 10px);
    min-width: 0;
  }
  @media (max-width: 360px){
    .btnbar > button{ flex-basis: 100%; }
  }

  /* graph canvas height fits phone */
  .chart{ height: 320px; }
}



@supports (height: 100dvh){
  body{ min-height: 100dvh; }
}



/* ---------- iPhone polish pack (safe for desktop) ---------- */
/* Auto light/dark */
@media (prefers-color-scheme: dark){
  :root{
    --bg: #0b1a12;
    --fg: #e9f0ea;
    --card: rgba(255,255,255,0.06);
    --card2: rgba(255,255,255,0.10);
    --shadow: rgba(0,0,0,0.35);
  }
  body{ background: var(--bg); color: var(--fg); }
  .panel, .card, .calc, #app, .container{
    background: var(--card);
    box-shadow: 0 10px 30px var(--shadow);
  }
}

@media (prefers-color-scheme: light){
  :root{
    --bg: #f6f5ef;
    --fg: #0b1a12;
    --card: rgba(0,0,0,0.05);
    --card2: rgba(0,0,0,0.08);
    --shadow: rgba(0,0,0,0.12);
  }
  body{ background: var(--bg); color: var(--fg); }
  .panel, .card, .calc, #app, .container{
    background: rgba(255,255,255,0.75);
    box-shadow: 0 10px 30px var(--shadow);
  }
}

/* Thumb-friendly spacing (right-hand bias) */
@media (max-width: 520px){
  /* If you're using a grid wrapper for keys, widen the right side slightly */
  .keys, .grid, .pad{
    padding-right: 10px;
    padding-left: 4px;
  }

  /* Make operator keys stand out slightly without forcing colors */
  .op, .operator, [data-op="true"]{
    font-weight: 700;
  }

  /* Prevent text selection while tapping */
  body, button{
    -webkit-user-select: none;
    user-select: none;
  }
}

/* Standalone (Add to Home Screen) better spacing */
@media (display-mode: standalone){
  body{ padding-top: calc(14px + var(--safe-top)); }
}


/* ---------- v1.3.5 Mobile layout upgrade (keeps desktop the same) ---------- */
.titleline{display:flex;align-items:baseline;gap:10px;flex-wrap:wrap}
.ver{font-size:.85rem;font-weight:800;opacity:1;color:var(--muted);white-space:nowrap}
@media (max-width: 900px){
  .wrap{margin:0 auto; padding: 0 12px}
}
@media (max-width: 520px){
  .wrap{max-width:100%; margin:0; padding:0 10px}
  header{flex-direction:column; align-items:stretch; gap:10px}
  .titleline{justify-content:center}
  h1{font-size:1.45rem; text-align:center}
  .ver{justify-self:center}

  /* Tabs become a horizontal scroll strip so they don't squash */
  .tabs{overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:2px; justify-content:flex-start; flex-wrap:nowrap}
  .tab{white-space:nowrap}

  /* Calculator card uses screen space better */
  .calc{grid-template-columns:1fr !important}
  .screen{min-height:120px}
  .result{font-size:clamp(1.6rem, 7vw, 2.4rem)}

  /* Keypad: 4 columns on phones (fits Pro Max nicely) */
  .keys{grid-template-columns:repeat(4, minmax(0,1fr)); gap:10px}
  .key{padding:16px 10px; border-radius:16px; min-height:54px}

  /* Reduce wasted vertical space */
  main{margin-top:8px}
}

/* Slightly wider phones (e.g., Pro Max landscape) */
@media (max-width: 820px) and (orientation: landscape){
  .wrap{padding:0 12px}
  .keys{grid-template-columns:repeat(6, minmax(0,1fr))}
}

/* v1.3.1: full-width equals on phones */
.span4{grid-column: span 4;}

    .dbg-mini{border:1px solid var(--border);background:transparent;color:var(--muted);padding:8px 10px;border-radius:12px;font-weight:900;cursor:pointer;min-height:44px}
    .dbg-mini:hover{background:rgba(255,255,255,.05)}
    .dbg-panel{position:fixed;inset:0;display:none;background:rgba(0,0,0,.55);z-index:9999}
    .dbg-panel .card{position:absolute;left:12px;right:12px;bottom:12px;max-height:60vh;background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:12px;box-shadow:0 20px 60px rgba(0,0,0,.5);display:flex;flex-direction:column;gap:10px}
    .gear-mini{border:0;background:transparent;color:var(--muted);font-weight:900;cursor:pointer;padding:8px 10px;border-radius:12px;min-height:44px}
    .gear-mini:hover{background:rgba(255,255,255,.06)}
    .dbg-mini{border:0;background:transparent;color:var(--muted);font-weight:900;cursor:pointer;padding:8px 10px;border-radius:12px}
    .dbg-mini:hover{background:rgba(255,255,255,.06)}

    /* Debug log readability */
    #dbgLog{background:var(--screen);border:1px solid var(--border);border-radius:14px;padding:10px;white-space:pre-wrap;overflow:auto;color:var(--ink);font-size:.9rem;line-height:1.25;max-height:48vh}

    /* Overlay hardening */
    .dbg-panel,.settings-drawer{pointer-events:none;}
    .dbg-panel.open,.settings-drawer.open{pointer-events:auto;}

    /* Settings drawer */
    .settings-drawer{position:fixed;inset:0;display:none;background:rgba(0,0,0,.55);z-index:9998}
    .settings-drawer .sheet{position:absolute;right:12px;top:12px;bottom:12px;width:min(420px, calc(100vw - 24px));background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:12px;box-shadow:0 20px 60px rgba(0,0,0,.5);display:flex;flex-direction:column;gap:12px}
    .sheet-top{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .sheet-title{font-weight:900;font-size:1.05rem}
    .set-row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.03)}
    .set-label{font-weight:900}
    .set-sub{font-size:.85rem;color:var(--muted);margin-top:2px}
    .switch{position:relative;display:inline-block;width:46px;height:26px}
    .switch input{display:none}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#2a3346;border-radius:999px;opacity:1;transition:background .18s ease}
    .slider:before{content:"";position:absolute;height:20px;width:20px;left:3px;top:3px;background:white;border-radius:999px;opacity:.8}
    .switch input:checked + .slider{background:var(--accent)}
    .switch input:checked + .slider:before{transform:translateX(20px)}


    /* Diagnostics pill */
    #diag{pointer-events:none;display:none;margin:10px 0;padding:8px 10px;border-radius:999px;font-weight:800;font-size:.9rem;line-height:1.1;align-items:center;gap:10px}
    #diag.ok{background:rgba(91,211,142,.14);border:1px solid rgba(91,211,142,.35);color:var(--ink)}
    #diag.err{background:rgba(255,107,107,.12);border:1px solid rgba(255,107,107,.35);color:var(--ink)}
    #diag .diag-msg{flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer}
    #diag .diag-x{border:0;background:transparent;color:var(--muted);font-size:1.1rem;font-weight:900;cursor:pointer;padding:2px 6px;border-radius:10px}
    #diag .diag-x:hover{background:rgba(255,255,255,.08)}
    #diag.expanded{border-radius:16px}
    #diag.expanded .diag-msg{white-space:normal;overflow:visible}

    /* Toast colors */
    
    @media (max-width:520px){
      #diag{pointer-events:none;position:fixed;left:10px;right:10px;bottom:64px;margin:0;z-index:2000}
      .settings-drawer .sheet{left:12px;right:12px;width:auto}
    }

    .dbg-panel .top{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .dbg-panel pre{margin:0;white-space:pre-wrap;word-break:break-word;overflow:auto;background:rgba(0,0,0,.18);border:1px solid var(--border);border-radius:14px;padding:10px;flex:1}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;z-index:9998;display:none;background:rgba(10,20,15,.92);border:1px solid var(--border);padding:10px 12px;border-radius:14px;color:var(--fg);font-weight:800;max-width:min(92vw,520px)}


    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);background:rgba(255,255,255,.03);padding:10px 12px;border-radius:999px;font-weight:900;cursor:pointer}
    .pill input{accent-color: var(--accent);}

    /* Big UI + One-hand mode (mobile-first only; desktop untouched) */
    @media (max-width:520px){
      .bigui .tab-btn{padding:14px 16px;font-size:1.02rem}
      .bigui .btn{padding:14px 16px;font-size:1.02rem}
      .bigui input,.bigui select,.bigui textarea{font-size:1.05rem}
      .bigui .key{padding:16px 12px}
      .onehand-left .keys{padding-right:24px}
      .onehand-right .keys{padding-left:24px}
    }

/* v1.4.36 mobile polish: keep tab strip fully visible */
@media (max-width: 520px){
  .tabs{gap:6px;padding-right:calc(12px + env(safe-area-inset-right));}
  .tab{padding:9px 10px;font-size:.86rem;min-width:unset}
  .titleline{gap:8px}
}


/* v1.4.36 mobile spacing system + tab scroll hint */
:root{ --m-pad:12px; --m-gap:10px; }
@media (max-width: 520px){
  /* tighten general vertical rhythm */
  .wrap{padding:var(--m-pad);}
  .card{padding:12px;}
  .grid{gap:var(--m-gap);}
  .row{gap:8px;}
  .btnbar{gap:8px;}
  /* keep sections from double-padding */
  .card .card{padding:10px;}
  /* tab strip hint */
  .tabswrap{position:relative;}
  .tabswrap::after{
    content:"";
    position:absolute; top:0; right:0; height:100%; width:26px;
    pointer-events:none;
    background:linear-gradient(to right, rgba(0,0,0,0), var(--bg, #0b0f12));
    opacity:.9;
  }
  .tabs{padding-right:calc(30px + env(safe-area-inset-right));}
}


@media (max-width: 520px){
  #historyBox, .historyBox, .tape{
    min-height: 180px;
    max-height: 60vh;
    height: auto;
    resize: vertical;
    overflow: auto;
  }
}


/* v1.4.36 mobile tap-target normalization */
@media (max-width: 520px){
  /* minimum Apple-friendly tap size */
  button, .btn, .key, .tab, a.btnlike,
  input[type="button"], input[type="submit"]{
    min-height:44px;
    padding:10px 12px;
    line-height:1.1;
  }
  /* form controls */
  input, select, textarea{
    min-height:44px;
    padding:10px 12px;
    font-size:16px; /* prevent iOS zoom */
  }
  /* small icon buttons (DBG, Gear, etc.) keep 44px hitbox but smaller visual */
  .iconbtn{
    min-width:44px;
    min-height:44px;
    padding:8px;
  }
  /* button rows wrap cleanly */
  .btnbar, .rowbtns{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .btnbar > *, .rowbtns > *{
    flex:1 1 auto;
  }
  /* tighter but readable small labels */
  .muted, .subtle, .hint{font-size:.9rem;}
}


/* v1.4.36 TI-Nspire theme readability tweak */
body.theme-ti, body.ti, .theme-ti{
  --muted: rgba(255,255,255,.78);
  --hint: rgba(255,255,255,.72);
}
body.theme-ti .muted, body.ti .muted, .theme-ti .muted{color:var(--muted) !important;}
body.theme-ti .note, body.ti .note, .theme-ti .note{color:rgba(255,255,255,.86);}
body.theme-ti .ver, body.ti .ver, .theme-ti .ver{color:rgba(255,255,255,.88) !important;}


/* v1.4.36 TI theme: make GraphLab overlay pills readable (ice-blue) */
body.theme-ti .pill, body.ti .pill, .theme-ti .pill{
  color: rgba(140,200,255,0.95) !important;
}
body.theme-ti .pill input, body.ti .pill input, .theme-ti .pill input{
  accent-color: rgba(140,200,255,0.95);
}


/* v1.4.36 TI-Nspire theme: make GraphLab overlay pills readable (ice-blue) */
.theme-inspire .pill, body.theme-inspire .pill{
  color: rgba(140,200,255,0.95) !important;
}
.theme-inspire .pill input, body.theme-inspire .pill input{
  accent-color: rgba(140,200,255,0.95);
}


/* v1.4.36 mobile scroll sanity */
main{padding-bottom:calc(18px + env(safe-area-inset-bottom));}
@media (max-width:520px){
  body{overscroll-behavior-y:none;}
}


.diag{pointer-events:none;position:fixed;left:12px;right:12px;bottom:12px;z-index:9999;max-height:42px;overflow:hidden;}

/* GraphLab Function List */
.fxlist{display:flex;flex-direction:column;gap:8px;margin:10px 0;}
.fxrow{display:grid;grid-template-columns:28px 1fr 34px;gap:8px;align-items:center;padding:8px;border:1px solid rgba(255,255,255,.12);border-radius:12px;}
.fxrow input[type="text"]{width:100%;padding:10px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.18);color:inherit;}
.fxswatch{width:18px;height:18px;border-radius:6px;box-shadow:0 0 0 1px rgba(255,255,255,.18) inset;}
.fxdel{width:34px;height:34px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.12);color:inherit;;min-height:44px}
.fxhdr{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:8px;}
.fxhdr .btn{padding:8px 10px;}


/* GraphLab layout grid */
.glgrid{
  display:grid;
  gap:14px;
  grid-template-columns:1fr;
  /* Mobile: stack inputs -> graph -> controls */
  grid-template-areas:
    'top'
    'right'
    'bottom';
}
@media (min-width: 980px){
  .glgrid{
    grid-template-columns:420px 1fr;
    grid-template-areas: 'top right' 'bottom right';
    align-items:start;
  }
}
.gllTop{grid-area:top;}
    .gllBottom{grid-area:bottom;}
    .glr{grid-area:right;}

    .gllines{display:flex;flex-direction:column;gap:8px;margin-top:8px;}
    .glline{display:flex;align-items:center;gap:8px;}
    .glline .expr{flex:1;min-width:160px;}
    .glline .chip{width:12px;height:12px;border-radius:999px;opacity:.9;flex:0 0 12px;}
    .glline .tiny{padding:8px 10px;}

    /* old gll */
    .gll{min-width:0;}
.glr{min-width:0;}
.glr .chart{height:520px;min-height:520px;}
@media (max-width: 520px){
  .glr .chart{height:340px;min-height:340px;}
}


/* GraphLab legend overlay */
.chartwrap{position:relative;}
.glegend{position:absolute;top:10px;left:10px;max-width:70%;
  padding:8px 10px;border-radius:12px;
  background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.14);
  backdrop-filter: blur(6px);
  font-size:12px;line-height:1.2;
  display:flex;flex-direction:column;gap:6px;
  pointer-events:none;
}
.glegend .li{display:flex;align-items:center;gap:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.glegend .dot{width:10px;height:10px;border-radius:4px;flex:0 0 auto;box-shadow:0 0 0 1px rgba(255,255,255,.25) inset;}


/* GraphLab eye toggle */
.eyeBtn{
  cursor:pointer;
  font-size:16px;
  padding:4px 6px;
  border-radius:8px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.12);
}
.eyeBtn.off{opacity:.35;}


/* Force-hide fxrow checkbox */
.fxrow input[type="checkbox"]{display:none !important;}


/* GraphLab controls drawer */
.graphlab-grid{display:grid;gap:14px;}
.graphlab-controls{min-width:0;}
.graphlab-plot{min-width:0;}
@media (min-width: 980px){
  .graphlab-grid{grid-template-columns: 360px 1fr; align-items:start;}
  body.gl-hide-controls .graphlab-grid{grid-template-columns: 0 1fr;}
  body.gl-hide-controls .graphlab-controls{display:none;}
}
.glCtlBtn{
  padding:8px 10px;border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.12);
  color:inherit;
}
.glCtlBtn:active{transform:scale(.98);}


.hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0;}
.cpick{width:34px;height:34px;padding:0;border:none;background:transparent;}
</style>
    <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22LegendCalc%22%2C%22short_name%22%3A%22LegendCalc%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230b1a12%22%2C%22theme_color%22%3A%22%230b1a12%22%2C%22icons%22%3A%5B%5D%7D">
</head>
<body>
  <div class="wrap">
    <header>
      <div class="titleline"><h1>LegendCalc Suite</h1><span class="ver" id="verTag">v1.4.71 • 2026-02-25</span></div>
      <div class="tabswrap"><div class="tabs">
        <button class="tab active" data-tab="calc">Calc</button>
        <button class="tab" data-tab="graphlab">GraphLab</button>
        <button class="tab" data-tab="units">Units</button>
        <button class="tab" data-tab="time">Time</button>
        <button class="tab" data-tab="sound">Sound</button>
        <button class="tab" data-tab="torque">Torque</button>
</div>
      <div class="theme-picker">
        <span class="note">Theme</span>
        <select id="themeSel" class="theme-select">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
          <option value="inspire">TI-Inspire</option>
        </select>
        <button class="dbg-mini" id="dbgBtn" title="Debug">DBG</button>
        <button class="gear-mini" id="gearBtn" title="Settings" aria-label="Settings">⚙</button>
      </div>
    </header>
    <div id="diag" class="ok">Loading…</div>
    <main id="view"></main>

    

    <div class="settings-drawer" id="settingsDrawer" aria-hidden="true">
      <div class="sheet" role="dialog" aria-label="Settings">
        <div class="sheet-top">
          <div class="sheet-title">Settings</div>
          <button class="btn" id="setClose">Close</button>
        </div>

        <div class="set-row">
          <div>
            <div class="set-label">Sound</div>
            <div class="set-sub">Applies across all tabs</div>
          </div>
          <select id="setSound" class="theme-select">
            <option value="off">Off</option>
            <option value="clicks">Clicks</option>
            <option value="fanfare">Fanfare</option>
          </select>
        </div>

        <div class="set-row">
          <div>
            <div class="set-label">Big UI</div>
            <div class="set-sub">Larger tap targets</div>
          </div>
          <label class="switch"><input type="checkbox" id="setBigUI"><span class="slider"></span></label>
        </div>

        <div class="set-row">
          <div>
            <div class="set-label">One-hand mode</div>
            <div class="set-sub">Left/right reach</div>
          </div>
          <select id="setOneHand" class="theme-select">
            <option value="right">Right</option>
            <option value="left">Left</option>
          </select>
        </div>

        <div class="set-row" style="justify-content:flex-end">
          <button class="btn" id="setTestClick">Test Click</button>
          <button class="btn" id="setTestFanfare">Test Fanfare</button>
        </div>
      </div>
    </div>

<div class="dbg-panel" id="dbgPanel" aria-hidden="true">
      <div class="card" role="dialog" aria-label="Debug panel">
        <div class="top">
          <div style="font-weight:900">Debug</div>
          <div style="display:flex;gap:8px">
            <button class="btn" id="dbgCopy">Copy</button>
            <button class="btn" id="dbgClose">Close</button>
          </div>
        </div>
        <pre id="dbgLog">(no errors yet)</pre>
      </div>
    </div>
    <div class="toast" id="toast"></div>

    <div id="selfTests" class="tests"></div>
  </div>

  <script>
  // Prefer local libs in ./libs, fallback to CDN, then start app
  (function(){
    const DI = document.getElementById('diag');
    const note=(cls,msg,full)=>{
        DI.className=cls;
        DI.dataset.full = full || msg;
        DI.classList.remove('expanded');
        DI.innerHTML = `<span class="diag-msg">${msg}</span><button class="diag-x" aria-label="Close">×</button>`;
        DI.style.display='flex';
        if(cls==='ok'){ clearTimeout(note._t); note._t=setTimeout(()=>{ if(!DI.classList.contains('expanded')) DI.style.display='none'; }, 2500); }
      };

    DI.addEventListener('click',(e)=>{
        if(e.target && e.target.classList.contains('diag-x')){ DI.style.display='none'; return; }
        if(e.target && e.target.classList.contains('diag-msg')){ DI.classList.toggle('expanded'); // expansion disabled
        if(false && DI.classList.contains('expanded')) DI.querySelector('.diag-msg').textContent = DI.dataset.full; else DI.querySelector('.diag-msg').textContent = DI.dataset.full.length>42 ? (DI.dataset.full.slice(0,42)+'…') : DI.dataset.full; }
      });

    const libs=[
      {global:'math', local:'./libs/math.min.js', cdn:'https://cdn.jsdelivr.net/npm/mathjs@12.4.2/lib/browser/math.js', name:'math.js'},
      {global:'Plotly', local:'./libs/plotly.min.js', cdn:'https://cdn.plot.ly/plotly-2.35.2.min.js', name:'Plotly'}
    ];
    function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=()=>rej(new Error('load failed: '+src)); document.head.appendChild(s); }); }

    (async function ensureLibs(){
      try{
        for(const L of libs){
          if(!(L.global in window)){
            try{ await loadScript(L.local); if(!(L.global in window)) throw new Error('local missing'); }
            catch(eLocal){ await loadScript(L.cdn); }
          }
        }
        // libs loaded — keep the loader banner hidden (show only on error)
        try{ DI.style.display='none'; }catch(_){ }

        startApp();
      }catch(e){
        console.error(e);
        note('err','Libs failed','Could not load libraries. If offline, put math.min.js and plotly.min.js in ./libs, or allow CDN.');
      }
    })();

      function forceHideOverlays(){
        // NOTE: This runs before startApp() defines the $ helper, so it must NOT use $().
        try{
          const d = document.getElementById('settingsDrawer');
          if(d){ d.style.display='none'; d.classList.remove('open'); d.setAttribute('aria-hidden','true'); }
          const p = document.getElementById('dbgPanel');
          if(p){ p.style.display='none'; p.classList.remove('open'); p.setAttribute('aria-hidden','true'); }
        }catch(_){}
      }


function startApp(){
        forceHideOverlays();
    window.window.GL_PALETTE = window.window.GL_PALETTE || ['#7fd6ff','#38d996','#ffd166','#ff5c5c','#b98bff'];

    window.onerror = function(msg, src, line, col, err){
      try{ dbgAdd('ERROR', String(msg||'Error') + (line?(' @'+line+':'+col):'')); }catch(_){ }
      return false;
    };

    try{
      const sd=document.getElementById('settingsDrawer'); if(sd){ sd.style.display='none'; sd.setAttribute('aria-hidden','true'); }
      const dp=document.getElementById('dbgPanel'); if(dp){ dp.style.display='none'; dp.setAttribute('aria-hidden','true'); }
    }catch(_){ }

      /* ---------- Utils & persistence ---------- */
      const $ = (s, r=document)=> r.querySelector(s);
      const $$ = (s, r=document)=> [...r.querySelectorAll(s)];


      // Utility: generate n points from a..b (used by GraphLab)
      function linspace(a,b,n){
        n = Math.max(2, (n|0)||2);
        const out = new Array(n);
        const step = (b-a)/(n-1);
        for(let i=0;i<n;i++) out[i]=a + step*i;
        return out;
      }
      window.linspace = linspace;

      // GraphLab deps helpers (scoped) — used by GraphLab event handlers
      function graphLibsReady(){
        return (window.math && typeof window.math.parse==='function' && window.Plotly && typeof window.Plotly.newPlot==='function');
      }
      let glPlotTimer=null;

function doPlot(){
  // GraphLab plotter (multi-line, Desmos-ish)
  const chartEl = document.getElementById('chart');
  const gxEl = document.getElementById('gx');
  const xminEl = document.getElementById('xmin');
  const xmaxEl = document.getElementById('xmax');
  const samplesEl = document.getElementById('samples');
  if(!chartEl || !gxEl || !xminEl || !xmaxEl || !samplesEl) return;

  if(!(window.math && window.Plotly)) { toast('GraphLab: loading libs...'); return; }

  // Prefer structured line state (colors + enabled), fallback to gx textarea
  const st = (typeof loadTab==='function') ? loadTab('graphlab', {}) : {};
  let lines = Array.isArray(st.glLines) ? st.glLines : null;
  if(!lines){
    const rawLines = String(gxEl.value||'').split(/\r?\n/).map(s=>String(s||'').trim()).filter(Boolean);
    lines = rawLines.map(s=>{
      let on=true, expr=s;
      if(expr.startsWith('#') || expr.startsWith('//')){ on=false; expr=expr.replace(/^(#+|\/\/+)\s*/,''); }
      return {on, expr, color:null};
    });
  }
  const enabled = lines.filter(l=>l && l.on && String(l.expr||'').trim()).map(l=>({
    expr: String(l.expr||'').trim(),
    color: l.color || null
  }));

  let xmin = parseFloat(xminEl.value); if(!isFinite(xmin)) xmin=-10;
  let xmax = parseFloat(xmaxEl.value); if(!isFinite(xmax)) xmax=10;
  if(xmax === xmin){ xmax = xmin + 1; }
  if(xmax < xmin){ const t=xmin; xmin=xmax; xmax=t; }

  let nRaw = parseInt(samplesEl.value,10);
  let n = isFinite(nRaw) ? nRaw : 600;
  const isMob = window.matchMedia && window.matchMedia('(max-width: 860px)').matches;
  const cap = isMob ? 1200 : 2500;
  n = Math.max(80, Math.min(cap, n));
  samplesEl.value = String(n);

  const xs = linspace(xmin, xmax, n);

  const palette = ['#5db0ff','#ffd166','#ef476f','#06d6a0','#8338ec','#ff7a00','#00c2ff','#ff4d6d'];
  const traces = [];

  // helper to compile once per expression
  enabled.forEach((item, idx)=>{
    const expr = item.expr;
    try{
      const node = window.math.parse(expr);
      const compiled = node.compile();
      const ys = xs.map(x=>{
        try{
          const v = compiled.evaluate({x});
          return (typeof v === 'number' && isFinite(v)) ? v : null;
        }catch(_){ return null; }
      });
      traces.push({
        x: xs,
        y: ys,
        mode: 'lines',
        name: expr,
        line: { width: 2, color: (item.color || palette[idx % palette.length]) }
      });
    }catch(e){
      try{ dbgAdd('ERROR', 'GraphLab parse: ' + expr + ' → ' + (e && e.message ? e.message : e)); }catch(_){}
    }
  });

  // Optional overlays
  const d1On = !!document.getElementById('d1')?.checked;
  const tanOn = !!document.getElementById('tanOn')?.checked;
  const intOn = !!document.getElementById('intOn')?.checked;
  const rootsOn = !!document.getElementById('rootsOn')?.checked;

  const x0El = document.getElementById('x0');
  const aEl = document.getElementById('a');
  const bEl = document.getElementById('b');
  const x0 = x0El ? parseFloat(x0El.value) : 0;
  const a = aEl ? parseFloat(aEl.value) : -1;
  const b = bEl ? parseFloat(bEl.value) : 1;

  // Use first enabled function for overlays
  if(enabled.length){
    try{
      const expr0 = enabled[0].expr;
      const fnode = window.math.parse(expr0);
      const f = fnode.compile();

      const safeEval = (x)=>{
        const v = f.evaluate({x});
        return (typeof v==='number' && isFinite(v)) ? v : null;
      };

      if(d1On){
        // numeric derivative
        const h = (xmax - xmin) / Math.max(800, n);
        const ys = xs.map(x=>{
          const y1 = safeEval(x-h), y2 = safeEval(x+h);
          if(y1===null || y2===null) return null;
          return (y2 - y1) / (2*h);
        });
        traces.push({x: xs, y: ys, mode:'lines', name:"f'(x)", line:{width:2, dash:'dot'}});
      }

      if(tanOn && isFinite(x0)){
        const h = (xmax - xmin) / 2000;
        const y0 = safeEval(x0);
        const y1 = safeEval(x0-h), y2 = safeEval(x0+h);
        if(y0!==null && y1!==null && y2!==null){
          const m = (y2 - y1) / (2*h);
          const yTan = xs.map(x=> y0 + m*(x - x0));
          traces.push({x: xs, y: yTan, mode:'lines', name:'tangent', line:{width:2, dash:'dash'}});
        }
      }

      if(intOn && isFinite(a) && isFinite(b)){
        const lo = Math.min(a,b), hi = Math.max(a,b);
        const xs2 = xs.filter(x=>x>=lo && x<=hi);
        const ys2 = xs2.map(x=> safeEval(x));
        traces.push({
          x: xs2,
          y: ys2,
          type: 'scatter',
          mode: 'lines',
          name: 'area',
          fill: 'tozeroy',
          line: {width: 0.5}
        });
      }

      if(rootsOn){
        // simple sign-change root markers
        const ys = xs.map(x=> safeEval(x));
        const rx=[], ry=[];
        for(let i=1;i<xs.length;i++){
          const yA=ys[i-1], yB=ys[i];
          if(yA===null || yB===null) continue;
          if(yA===0){ rx.push(xs[i-1]); ry.push(0); }
          if(yA*yB < 0){
            // linear interp
            const xA=xs[i-1], xB=xs[i];
            const r = xA + (0 - yA)*(xB-xA)/(yB-yA);
            rx.push(r); ry.push(0);
          }
        }
        if(rx.length){
          traces.push({x: rx, y: ry, mode:'markers', name:'roots', marker:{size:8}});
        }
      }
    }catch(e){
      try{ dbgAdd('ERROR', 'Overlay error: ' + (e && e.message ? e.message : e)); }catch(_){}
    }
  }

  const gridOn = document.getElementById('gridOn')?.checked !== false;

  const layout = {
    margin: {l: 40, r: 20, t: 20, b: 40},
    xaxis: {range:[xmin,xmax], showgrid: gridOn, zeroline: true},
    yaxis: {showgrid: gridOn, zeroline: true},
    showlegend: false,
    dragmode: 'pan',
  };

  const config = {displayModeBar:false, responsive:true, scrollZoom:true, doubleClick:'reset'};

  try{
    window.Plotly.newPlot(chartEl, traces.length? traces : [{x:[0],y:[0],mode:'lines',line:{width:0}}], layout, config);
  }catch(e){
    try{ dbgAdd('ERROR', 'Plotly: ' + (e && e.message ? e.message : e)); }catch(_){}
  }

  // small legend
  const leg = document.getElementById('glLegend');
  if(leg){
    if(traces.length){
      leg.style.display='flex';
      leg.innerHTML = traces.filter(t=>t.mode==='lines' && t.name).slice(0,8).map((tr,i)=>{
        const c = (tr.line && tr.line.color) ? tr.line.color : '#9ad';
        return `<span class="pill"><span class="dot" style="background:${c}"></span>${esc(tr.name)}</span>`;
      }).join(' ');
    }else{
      leg.style.display='none';
      leg.innerHTML='';
    }
  }
}

function schedulePlot(ms=140){
  try{ if(glPlotTimer) clearTimeout(glPlotTimer); }catch(_){ }
  glPlotTimer=setTimeout(()=>{ try{ doPlot(); }catch(e){ try{ logErr(e); }catch(_){ } } }, ms);
}

function waitForGraphLibs(cb, tries=40){
        if(graphLibsReady()) return cb();
        let n=0;
        const iv=setInterval(()=>{
          n++;
          if(graphLibsReady()){ clearInterval(iv); cb(); }
          else if(n>=tries){ clearInterval(iv); toast('GraphLab: libs not ready'); dbgAdd('ERROR','GraphLab libs not ready (math/Plotly)'); }
        }, 125);
      }
      window.waitForGraphLibs = waitForGraphLibs;
      window.graphLibsReady = graphLibsReady;


      const esc = s=>String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
      const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));

      function saveTab(name, obj){ try{ localStorage.setItem('legendcalc_'+name, JSON.stringify(obj)); }catch(e){} }
      function loadTab(name, def){ try{ const v=localStorage.getItem('legendcalc_'+name); return v? JSON.parse(v): def; }catch(e){ return def; } }
      function clearTab(name){ try{ localStorage.removeItem('legendcalc_'+name); }catch(e){} }

      const PREFS_KEY='legendcalc_prefs';
      function loadPrefs(){ try{ return JSON.parse(localStorage.getItem(PREFS_KEY)||'{}'); }catch(e){ return {}; } }
      function savePrefs(p){ localStorage.setItem(PREFS_KEY, JSON.stringify(p)); }

      /* ---------- Toast ---------- */
      function toast(msg){
        const el=$('#toast');
        if(!el) return;
        el.textContent=msg;
        el.style.display='block';
        clearTimeout(toast._t);
        toast._t=setTimeout(()=>{el.style.display='none';}, 1600);
      }

      /* ---------- Debug capture ---------- */
      const DBG=[];
      function dbgLine(level, msg){
        const t=new Date();
        const stamp=t.toLocaleTimeString();
        DBG.push(`[${stamp}] ${level}: ${msg}`);
        if(DBG.length>200) DBG.shift();
        const pre=$('#dbgLog');
        if(pre) pre.textContent = DBG.join('\n') || '(no errors yet)';
      }
      
      // v1.4.36: helper so plotting code can report errors without crashing
      function logErr(err){
        try{
          const msg = (err && (err.stack || err.message)) ? String(err.stack || err.message) : String(err);
          dbgLine('ERROR', msg);
        }catch(_){
          dbgLine('ERROR', 'Unknown error');
        }
      }

window.addEventListener('error', (e)=>{ dbgLine('ERROR', (e.message||'') + (e.filename?` @ ${e.filename}:${e.lineno}`:'')); });
      window.addEventListener('unhandledrejection', (e)=>{ dbgLine('PROMISE', (e.reason && (e.reason.message||String(e.reason))) || 'unhandled rejection'); });

      function initDebugUI(){
        const btn=$('#dbgBtn'), panel=$('#dbgPanel'), close=$('#dbgClose'), copy=$('#dbgCopy');
        if(!btn || !panel) return;
        const open=()=>{ panel.style.display='block';
          panel.classList.add('open'); panel.setAttribute('aria-hidden','false'); dbgLine('INFO','Debug opened'); };
        const shut=()=>{ panel.style.display='none';
          panel.classList.remove('open'); panel.setAttribute('aria-hidden','true'); };
        btn.addEventListener('click', open);
        panel.addEventListener('click', (e)=>{ if(e.target===panel) shut(); });
        close && close.addEventListener('click', shut);
        copy && copy.addEventListener('click', async ()=>{
          const text = (DBG && DBG.length) ? DBG.join('\n') : '(no errors yet)';
          try{ await navigator.clipboard.writeText(text); toast('Debug log copied'); }
          catch(_){
            try{
              const ta=document.createElement('textarea');
              ta.value=text; document.body.appendChild(ta);
              ta.select(); document.execCommand('copy');
              document.body.removeChild(ta);
              toast('Debug log copied');
            }catch(__){ toast('Copy failed'); }
          }
          // visually select the log so it feels like a real copy
          const pre=$('#dbgLog');
          if(pre){
            const r=document.createRange(); r.selectNodeContents(pre);
            const sel=window.getSelection(); sel.removeAllRanges(); sel.addRange(r);
            setTimeout(()=>{ try{ sel.removeAllRanges(); }catch(_){} }, 900);
          }
        });
      }

      
      function initSettingsUI(){
        const gear=$('#gearBtn'), drawer=$('#settingsDrawer'), close=$('#setClose');
        if(!gear || !drawer) return;
        const open=()=>{ drawer.style.display='block';
          drawer.classList.add('open'); drawer.setAttribute('aria-hidden','false'); syncSettingsUI(); };
        const shut=()=>{ drawer.style.display='none';
          drawer.classList.remove('open'); drawer.setAttribute('aria-hidden','true'); };
        gear.addEventListener('click', open);
        drawer.addEventListener('click',(e)=>{ if(e.target===drawer) shut(); });
        close && close.addEventListener('click', shut);

        const sel=$('#setSound');
        sel && sel.addEventListener('change', ()=>{ setSoundMode(sel.value); syncSettingsUI(); });

        const big=$('#setBigUI');
        big && big.addEventListener('change', ()=>{ setBigUI(big.checked); });

        const oh=$('#setOneHand');
        oh && oh.addEventListener('change', ()=>{ setOneHand(oh.value); });

        const tClick=$('#setTestClick');
        tClick && tClick.addEventListener('click', ()=>{
          try{ ensureAudio(); beep(220, 0.05, 'square', 0.02, 0); toast('Test: Click'); }catch(_){}
        });
        const tFan=$('#setTestFanfare');
        tFan && tFan.addEventListener('click', ()=>{
          try{ ensureAudio(); beep(392,0.12,'triangle',0.03,0.00); beep(494,0.12,'triangle',0.03,0.10); beep(587,0.16,'triangle',0.035,0.20); toast('Test: Fanfare'); }catch(_){}
        });
      }

      /* ---------- Sound engine (original chimes) ---------- */
      let audioCtx=null;
      function getSoundMode(){ return (loadPrefs().soundMode||'off'); }
      function setSoundMode(mode){
        const p=loadPrefs(); p.soundMode=mode; savePrefs(p);
        toast(`Sound: ${mode==='off'?'Off':(mode==='clicks'?'Clicks':'Fanfare')}`);
        syncSoundUI();
      }
      function ensureAudio(){
        try{
          audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
          if(audioCtx.state==='suspended') audioCtx.resume().catch(()=>{});
        }catch(_){}
      }
      // iOS/Safari: resume AudioContext on first user gesture
      function armAudioUnlock(){
        const once=()=>{ ensureAudio(); window.removeEventListener('pointerdown', once, true); window.removeEventListener('touchstart', once, true); };
        window.addEventListener('pointerdown', once, true);
        window.addEventListener('touchstart', once, true);
      }
      function beep(freq, dur, type='sine', gain=0.03, when=0){
        if(!audioCtx) return;
        const o=audioCtx.createOscillator();
        const g=audioCtx.createGain();
        o.type=type; o.frequency.value=freq;
        const t=audioCtx.currentTime + when;
        g.gain.setValueAtTime(0.0001, t);
        g.gain.exponentialRampToValueAtTime(gain, t+0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, t+dur);
        o.connect(g); g.connect(audioCtx.destination);
        o.start(t); o.stop(t+dur+0.02);
      }
      function clickSound(){
        const mode=getSoundMode();
        if(mode!=='clicks') return;
        try{
          const reduce = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;
          if (reduce) return;
          ensureAudio();
          beep(220, 0.05, 'square', 0.02, 0);
        }catch(_){}
      }
      // Expose for global pointer handlers
      window.__LC_clickSound = clickSound;

      function fanfareSound(){
        const mode=getSoundMode();
        if(mode!=='fanfare') return;
        try{
          ensureAudio();
          // a small “Zelda-ish” ascending triad (original)
          beep(392, 0.12, 'triangle', 0.03, 0.00); // G4
          beep(494, 0.12, 'triangle', 0.03, 0.10); // B4
          beep(587, 0.16, 'triangle', 0.035,0.20); // D5
        }catch(_){}
      }
      function syncSoundUI(){
        const mode=getSoundMode();
        const radios=$$('input[name="soundMode"]');
        radios.forEach(r=>{ r.checked = (r.value===mode); });
      }

      /* ---------- UI prefs (Big UI + One-hand) ---------- */
      function getBigUI(){ return !!loadPrefs().bigUI; }
      function setBigUI(on){
        const p=loadPrefs(); p.bigUI=!!on; savePrefs(p);
        applyBigUI();
        toast(`Big UI: ${on?'On':'Off'}`);
        syncSettingsUI();
      }
      function applyBigUI(){
        const on=getBigUI();
        document.documentElement.classList.toggle('bigui', on);
      }

      function getOneHand(){ return (loadPrefs().oneHand||'right'); }
      function setOneHand(mode){
        const p=loadPrefs(); p.oneHand=(mode==='left'?'left':'right'); savePrefs(p);
        applyOneHand();
        toast(`One-hand: ${p.oneHand==='left'?'Left':'Right'}`);
        syncSettingsUI();
      }
      function applyOneHand(){
        const mode=getOneHand();
        document.documentElement.classList.toggle('onehand-left', mode==='left');
        document.documentElement.classList.toggle('onehand-right', mode!=='left');
      }

      function syncSettingsUI(){
        const b=$('#setBigUI'); if(b) b.checked = getBigUI();
        const o=$('#setOneHand'); if(o) o.value = getOneHand();
        const s=$('#setSound'); if(s) s.value = getSoundMode();
      }
      function applyTheme(name){
        document.body.classList.remove('theme-light','theme-inspire');
        if(name==='light') document.body.classList.add('theme-light');
        if(name==='inspire') document.body.classList.add('theme-inspire');
      }

      /* ---------- Router & theme ---------- */
      const tabs=$$('.tab');
      tabs.forEach(t=>t.addEventListener('click',()=>{tabs.forEach(b=>b.classList.remove('active'));t.classList.add('active');render(t.dataset.tab);}));

      function render(which){
        if(which==='graphlab') return renderGraphLab();
                if(which==='units') return renderUnits();
        if(which==='time') return renderTime();
        if(which==='sound') return renderSound();
        if(which==='torque') return renderTorque();
        return renderCalc();
      }

      (function initTheme(){
        const prefs=loadPrefs();
        const theme=prefs.theme||'dark';
        applyTheme(theme);
        $('#themeSel').value=theme;
        $('#themeSel').addEventListener('change',()=>{
          const next=$('#themeSel').value; applyTheme(next); savePrefs({...loadPrefs(), theme:next});
          document.querySelector('h1').style.color = getComputedStyle(document.body).getPropertyValue('--accent').trim();
        });
        document.querySelector('h1').style.color = getComputedStyle(document.body).getPropertyValue('--accent').trim();
      })();

      /* ---------- Calculator ---------- */
      function renderCalc(){
        const view=$('#view');
        view.innerHTML=`
          <section class="surface calc-grid">
            <div>
              <div class="screen">
                <div class="expr" id="expr"></div>
                <div class="result" id="res">0</div>
              </div>
              <div class="keys" id="keys"></div>
            </div>
            <div>
              <div class="section-title">History</div>
              <div class="surface" style="padding:10px">
                <div class="tape" id="tape"></div>
                <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
                  <button class="btn" id="copyTape">Copy</button>
                  <button class="btn" id="clearTape">Clear</button>
                  <button class="btn" id="clearSavedCalc" title="Forget saved history">Clear Saved</button>
                </div>
              </div>
            </div>
              </div>
            </div>
          </section>`;

        function maybeLive(){ try{ if($('#liveTyping')?.checked || $('#autoPlot')?.checked) schedulePlot(); }catch(_){ } }


        const K = (window.matchMedia && window.matchMedia('(max-width: 520px)').matches)
          ? ['C','⌫','%','/','7','8','9','*','4','5','6','-','1','2','3','+','0','.','(',')','sin','cos','tan','^','√','π','e','ANS','=']
          : ['7','8','9','/','sin','cos','4','5','6','*','tan','√','1','2','3','-','^','π','0','.','(',')','e','ANS','C','⌫','%','+','='];
        const keysEl=$('#keys');
        K.forEach(k=>{ const b=document.createElement('button'); b.className='key'; b.textContent=k; if('/*-+^%'.includes(k)) b.classList.add('op'); if(['sin','cos','tan','√','π','e','ANS'].includes(k)) b.classList.add('fn'); if(k==='='){ b.classList.add('eq');
            if (window.matchMedia && window.matchMedia('(max-width: 520px)').matches) b.classList.add('span4');
            else b.classList.add('span2'); } b.onclick=()=>press(k); keysEl.appendChild(b); });

        const saved = loadTab('calc', {tape:[], ans:0});
        let expr=''; let ans=saved.ans||0; const tape=[...(saved.tape||[])]; const exprEl=$('#expr'); const resEl=$('#res');
        function persist(){ saveTab('calc', {tape, ans}); }

        function setRes(v){ resEl.textContent=v; }
        function renderExpr(){ exprEl.textContent=expr||'\u00A0'; }
        function renderTape(){ $('#tape').innerHTML=tape.map(t=>`<div class='trow'><div class='l'>${esc(t.e)}</div><div class='r'>${t.v}</div></div>`).join(''); }

        function evalExpr(){ if(!expr) return; try{ const sanitized=expr.replace(/√/g,'sqrt'); const scope={sin:Math.sin,cos:Math.cos,tan:Math.tan,sqrt:Math.sqrt}; let val=math.evaluate(sanitized,scope); if(typeof val==='number'&&!Number.isFinite(val)) throw 0; ans=round(val); setRes(ans); tape.unshift({e:expr,v:ans}); if(tape.length>300) tape.pop(); expr=''; renderExpr(); renderTape(); persist(); }catch(e){ setRes('Error'); } }
        function press(k){ switch(k){ case 'C': expr=''; setRes(0); break; case '⌫': expr=expr.slice(0,-1); break; case '=': evalExpr(); break; case '√': expr+='sqrt('; break; case 'π': expr+=Math.PI.toString(); break; case 'e': expr+=Math.E.toString(); break; case 'ANS': expr+=String(ans); break; case 'sin': case 'cos': case 'tan': expr+=k+'('; break; default: expr+=k; } renderExpr(); }
        window.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); evalExpr(); } else if(e.key==='Backspace'){ press('⌫'); } else if(e.key==='Escape'){ press('C'); } else if(/[0-9.()+\-/*^%]/.test(e.key)){ press(e.key); } });
        $('#copyTape').onclick=()=>navigator.clipboard.writeText(tape.map(t=>`${t.e} = ${t.v}`).reverse().join('\n'));
        $('#clearTape').onclick=()=>{ tape.length=0; renderTape(); persist(); };
        $('#clearSavedCalc').onclick=()=>{ clearTab('calc'); tape.length=0; ans=0; renderTape(); setRes(0); };

        function round(x){ return +(+x).toPrecision(12); }
        renderExpr(); renderTape(); setRes(ans||0);
      }

      /* ---------- Calculus ---------- */
      function renderCalculus(){
        const view=$('#view');
        view.innerHTML=`
          <section class="surface two-col">
            <div>
              <div class="section-title">Symbolic</div>
              <div class="row">
                <label><div class="note">f(x)</div><input id="fx" class="input" placeholder="e.g. x^3 - 4x + 1"></label>
                <label><div class="note">Point (x = …) for f'(x)</div><input id="x0" class="input" type="number" placeholder="optional"></label>
              </div>
              <div class="btnbar" style="display:flex;gap:8px;margin:10px 0">
                <button class="btn primary" id="diffBtn">Differentiate</button>
                <button class="btn" id="integrateBtn">Definite Integral</button>
                <button class="btn" id="clearSavedCalcus" title="Forget saved inputs">Clear Saved</button>
              </div>
              <div class="note">Integration supports numeric definite integrals (Simpson) — enter bounds below.</div>
              <div class="row" style="margin-top:8px">
                <label><div class="note">Lower bound a</div><input id="a" class="input" type="number" placeholder="e.g. 0"></label>
                <label><div class="note">Upper bound b</div><input id="b" class="input" type="number" placeholder="e.g. 2"></label>
                <label><div class="note">Subdivisions (even)</div><input id="n" class="input" type="number" value="200"></label>
              </div>
              <div id="calcOut" style="margin-top:12px"></div>
            </div>
            <div>
              <div class="section-title">Quick Checks</div>
              <div class="row">
                <label><div class="note">Limit x → a</div><input id="limExpr" class="input" placeholder="e.g. (sin(x))/x"></label>
                <label><div class="note">a</div><input id="limA" class="input" type="number" placeholder="0"></label>
              </div>
              <div class="btnbar" style="display:flex;gap:8px;margin:10px 0"><button class="btn" id="limitBtn">Compute Limit (numeric)</button></div>
              <div id="limitOut"></div>
            </div>
          </section>`;

        function maybeLive(){ try{ if($('#liveTyping')?.checked || $('#autoPlot')?.checked) schedulePlot(); }catch(_){ } }


        const saved = loadTab('calculus', {fx:'', x0:'', a:'', b:'', n:200, limExpr:'', limA:''});
        $('#fx').value = saved.fx||''; $('#x0').value = saved.x0||''; $('#a').value = saved.a||''; $('#b').value = saved.b||''; $('#n').value = saved.n||200; $('#limExpr').value = saved.limExpr||''; $('#limA').value = saved.limA||'';
        function persist(){ saveTab('calculus', {fx:$('#fx').value, x0:$('#x0').value, a:$('#a').value, b:$('#b').value, n:$('#n').value, limExpr:$('#limExpr').value, limA:$('#limA').value}); }
        $$('.input').forEach(el=> el.addEventListener('input', ()=>{ persist(); schedulePlot(); }));
        $('#clearSavedCalcus').onclick=()=>{ clearTab('calculus'); ['fx','x0','a','b','n','limExpr','limA'].forEach(id=>{ const e=$('#'+id); if(e) e.value=''; }); };

        $('#diffBtn').onclick=()=>{
          const fx=$('#fx').value.trim(); if(!fx){ return setCalcOut("<div class='err'>Enter f(x)</div>"); }
          try{
            const d = window.math.derivative(fx,'x').toString();
            const x0 = parseFloat($('#x0').value);
            let evalAt='';
            if(!Number.isNaN(x0)){
              const f = window.math.parse(d).compile();
              const val = f.evaluate({x:x0});
              evalAt = `<div>f'( ${x0} ) = <b>${round(val)}</b></div>`;
            }
            setCalcOut(`<div>f'(x) = <b>${esc(d)}</b></div>${evalAt}`);
          }catch(e){ setCalcOut("<div class='err'>Bad function</div>"); }
        };

        $('#integrateBtn').onclick=()=>{
          const fx=$('#fx').value.trim(); const a=parseFloat($('#a').value); const b=parseFloat($('#b').value); let n=parseInt($('#n').value||200,10);
          if(!fx||Number.isNaN(a)||Number.isNaN(b)) return setCalcOut("<div class='err'>Enter f(x), a, b</div>");
          if(n%2===1) n+=1; // Simpson needs even
          try{
            const f = window.math.parse(fx).compile();
            const F = x=>{ const v=f.evaluate({x}); if(!Number.isFinite(v)) throw 0; return v; };
            const h=(b-a)/n; let s=F(a)+F(b);
            for(let i=1;i<n;i++){ const x=a+i*h; s += (i%2? 4:2)*F(x); }
            const I = (h/3)*s;
            setCalcOut(`<div>∫<sub>${a}</sub><sup>${b}</sup> f(x) dx ≈ <b>${round(I)}</b> (n=${n})</div>`);
          }catch(e){ setCalcOut("<div class='err'>Numerical integration failed</div>"); }
        };

        $('#limitBtn').onclick=()=>{
          const ex=$('#limExpr').value.trim(); const a=parseFloat($('#limA').value);
          if(!ex||Number.isNaN(a)) return setLimitOut("<div class='err'>Enter expression and a</div>");
          try{
            const f = window.math.parse(ex).compile();
            const lim = numericLimit(x=>f.evaluate({x}), a);
            setLimitOut(`<div>lim<sub>x→${a}</sub> ${esc(ex)} = <b>${round(lim)}</b></div>`);
          }catch(e){ setLimitOut("<div class='err'>Limit failed</div>"); }
        };

        function numericLimit(F,a){ const eps=1e-6; const left=F(a-eps); const right=F(a+eps); return (left+right)/2; }
        function setCalcOut(html){ $('#calcOut').innerHTML=html; }
        function setLimitOut(html){ $('#limitOut').innerHTML=html; }
        function round(x){ return +(+x).toPrecision(12); }
      }

      /* ---------- Graphing (with hotkeys) ---------- */
      
      function renderGraphLab(){
        const view=$('#view');
        view.innerHTML=`
          <section class="surface">
            <div class="glgrid">
              <div class="gllTop">
                <div class="row" style="align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
                  <div class="note">Functions</div>
                  <div class="row" style="gap:8px;flex-wrap:wrap">
                    <button class="btn" id="glAddLine" type="button">+ Line</button>
                    <button class="btn" id="glClearLines" type="button">Clear</button>
                  </div>
                </div>
                <div id="glLines" class="gllines"></div>
                <textarea id="gx" class="input" rows="4" style="display:none" aria-hidden="true"></textarea>
              </div>

              <div class="glr">
                <div class="chartwrap">
                  <div id="glLegend" class="glegend" style="display:none"></div>
                  <div id="chart" class="chart"></div>
                </div>
                <div id="glReadout" class="note" style="margin-top:8px"></div>
              </div>

              <div class="gllBottom">
                <div class="row" style="gap:10px;flex-wrap:wrap;align-items:flex-end">
                  <label style="min-width:120px"><div class="note">x-min</div><input id="xmin" class="input" type="number" value="-10"></label>
                  <label style="min-width:120px"><div class="note">x-max</div><input id="xmax" class="input" type="number" value="10"></label>
                  <label style="min-width:120px"><div class="note">samples</div><input id="samples" class="input" type="number" value="600" min="80" max="2500"></label>

                  <div class="btnbar">
                    <button class="btn" id="plotBtn" type="button">Plot</button>
                    <label class="pill" style="margin-left:8px"><input type="checkbox" id="livePlot" checked> Live</label>
                    <label class="pill"><input type="checkbox" id="gridOn" checked> Grid</label>
                  </div>
                </div>

                <div class="row" style="gap:10px;flex-wrap:wrap;margin-top:10px;align-items:flex-end">
                  <label class="pill"><input type="checkbox" id="d1"> f'(x)</label>

                  <label class="pill"><input type="checkbox" id="tanOn"> Tangent</label>
                  <label style="min-width:110px"><div class="note">x0</div><input id="x0" class="input" type="number" value="0"></label>

                  <label class="pill"><input type="checkbox" id="intOn"> ∫ area</label>
                  <label style="min-width:110px"><div class="note">a</div><input id="a" class="input" type="number" value="-1"></label>
                  <label style="min-width:110px"><div class="note">b</div><input id="b" class="input" type="number" value="1"></label>

                  <label class="pill"><input type="checkbox" id="rootsOn"> roots</label>
                </div>

                <div class="note" style="margin-top:10px">
                  Tip: use lowercase functions: <b>sin(x)</b>, <b>cos(x)</b>, <b>tan(x)</b>. Toggle lines off with the checkbox.
                </div>
              </div>
            </div>
          </section>`;

        // Init after paint (prevents null element crashes)
        setTimeout(() => {
          if(!view.isConnected) return;

          const GL_PALETTE = ['#5db0ff','#ffd166','#ef476f','#06d6a0','#8338ec','#ff7a00','#00c2ff','#ff4d6d'];

          function normalizeExpr(s){
            let x=(s||'').trim();
            if(!x) return '';
            x = x.replace(/\b(Sin|Cos|Tan|Sec|Csc|Cot|Exp|Ln|Log|Sqrt)\b/g, m=>m.toLowerCase());
            return x;
          }
          function glSerialize(lines){
            return (lines||[]).map(l=>({on:!!l.on, expr:String(l.expr||''), color:(l.color||null)}));
          }
          function glSyncTextarea(lines){
            const gx=$('#gx');
            if(!gx) return;
            gx.value = (lines||[]).map(l=>{
              const e=normalizeExpr(l.expr);
              if(!e) return '';
              return l.on ? e : ('# ' + e);
            }).filter(Boolean).join('\n');
          }
          function glRenderLines(lines){
            const host=$('#glLines'); if(!host) return;
            host.innerHTML='';
            (lines||[]).forEach((l,idx)=>{
              const row=document.createElement('div');
              row.className='glline';

              const cb=document.createElement('input');
              cb.type='checkbox'; cb.checked=!!l.on; cb.title='Show/hide';

              const chip=document.createElement('span');
              chip.className='chip';
              const defaultColor = GL_PALETTE[idx % GL_PALETTE.length];
              chip.style.background = (l.color || defaultColor);

              const cPick=document.createElement('input');
              cPick.type='color';
              cPick.className='cpick';
              cPick.value = (l.color || defaultColor);
              cPick.title='Line color';

              const inp=document.createElement('input');
              inp.className='input expr';
              inp.placeholder = idx===0 ? 'f(x) e.g. sin(x)' : 'g(x) ...';
              inp.value = l.expr||'';

              const del=document.createElement('button');
              del.className='btn tiny'; del.type='button'; del.textContent='✕';
              del.title='Remove line';

              cb.addEventListener('change', ()=>{
                l.on=cb.checked;
                glSyncTextarea(lines);
                persist();
                if($('#livePlot')?.checked) schedulePlot();
              });
              cPick.addEventListener('input', ()=>{
                l.color = cPick.value;
                chip.style.background = cPick.value;
                glSyncTextarea(lines);
                persist();
                if($('#livePlot')?.checked) schedulePlot();
              });
              inp.addEventListener('input', ()=>{
                l.expr=inp.value;
                glSyncTextarea(lines);
                persist();
                if($('#livePlot')?.checked) schedulePlot();
              });
              del.addEventListener('click', ()=>{
                lines.splice(idx,1);
                if(lines.length===0) lines.push({on:true, expr:''});
                glSyncTextarea(lines);
                persist();
                glRenderLines(lines);
                if($('#livePlot')?.checked) schedulePlot();
              });

              row.appendChild(cb);
              row.appendChild(chip);
              row.appendChild(cPick);
              row.appendChild(inp);
              row.appendChild(del);
              host.appendChild(row);
            });
          }

          const saved = loadTab('graphlab', {gx:'', xmin:'-10', xmax:'10', samples:'600', d1:'0', tanOn:'0', x0:'0', intOn:'0', a:'-1', b:'1', rootsOn:'0', gridOn:'1', livePlot:'1', glLines:null});

          function parseLinesFromGx(gxText){
            const out=[];
            (String(gxText||'').split(/\r?\n/)).forEach(line=>{
              let s=String(line||'').trim();
              if(!s) return;
              let on=true;
              if(s.startsWith('#') || s.startsWith('//')){ on=false; s=s.replace(/^(#+|\/\/+)\s*/,''); }
              out.push({on, expr:s});
            });
            return out.length? out : [{on:true, expr:'sin(x)'}];
          }

          const lines = Array.isArray(saved.glLines) ? glSerialize(saved.glLines) : parseLinesFromGx(saved.gx);
          if(lines.length===0) lines.push({on:true, expr:'sin(x)'});
          glSyncTextarea(lines);
          glRenderLines(lines);

          // restore controls
          if($('#xmin')) $('#xmin').value = saved.xmin || '-10';
          if($('#xmax')) $('#xmax').value = saved.xmax || '10';
          if($('#samples')) $('#samples').value = saved.samples || '600';
          if($('#d1')) $('#d1').checked = (saved.d1==='1');
          if($('#tanOn')) $('#tanOn').checked = (saved.tanOn==='1');
          if($('#x0')) $('#x0').value = saved.x0 ?? '0';
          if($('#intOn')) $('#intOn').checked = (saved.intOn==='1');
          if($('#a')) $('#a').value = saved.a ?? '-1';
          if($('#b')) $('#b').value = saved.b ?? '1';
          if($('#rootsOn')) $('#rootsOn').checked = (saved.rootsOn==='1');
          if($('#gridOn')) $('#gridOn').checked = (saved.gridOn!=='0');
          if($('#livePlot')) $('#livePlot').checked = (saved.livePlot!=='0');

          function persist(){
            saveTab('graphlab', {
              gx: $('#gx')?.value || '',
              xmin: $('#xmin')?.value || '-10',
              xmax: $('#xmax')?.value || '10',
              samples: $('#samples')?.value || '600',
              d1: $('#d1')?.checked ? '1':'0',
              tanOn: $('#tanOn')?.checked ? '1':'0',
              x0: $('#x0')?.value || '0',
              intOn: $('#intOn')?.checked ? '1':'0',
              a: $('#a')?.value || '-1',
              b: $('#b')?.value || '1',
              rootsOn: $('#rootsOn')?.checked ? '1':'0',
              gridOn: $('#gridOn')?.checked ? '1':'0',
              livePlot: $('#livePlot')?.checked ? '1':'0',
              glLines: glSerialize(lines)
            });
          }

          $('#glAddLine')?.addEventListener('click', ()=>{
            lines.push({on:true, expr:''});
            glSyncTextarea(lines); persist(); glRenderLines(lines);
          });
          $('#glClearLines')?.addEventListener('click', ()=>{
            lines.splice(0, lines.length, {on:true, expr:''});
            glSyncTextarea(lines); persist(); glRenderLines(lines);
            toast('Lines cleared');
            if($('#livePlot')?.checked) schedulePlot();
          });

          $('#plotBtn')?.addEventListener('click', ()=>{ persist(); doPlot(); });

          // live plot triggers
          ['xmin','xmax','samples','x0','a','b'].forEach(id=>{
            const el=$('#'+id);
            if(el) el.addEventListener('input', ()=>{ persist(); if($('#livePlot')?.checked) schedulePlot(); });
          });
          ['d1','tanOn','intOn','rootsOn','gridOn','livePlot'].forEach(id=>{
            const el=$('#'+id);
            if(el) el.addEventListener('change', ()=>{ persist(); if($('#livePlot')?.checked) schedulePlot(); });
          });

          // First plot when libs ready
          waitForGraphLibs(()=>{ try{ doPlot(); }catch(e){ try{ logErr(e);}catch(_){ } } }, 40);

        }, 0);
      }
function renderTorque(){
        const view=$('#view');
        view.innerHTML = `
          <section class="surface">
            <div class="section-title">Torque Intelligence</div>
            <div class="note" style="margin-top:-6px">Fast conversions + “sanity-check” math helpers. <b>Specs live in the service manual</b>; this page helps you convert, plan stages, and avoid dry/lube mistakes.</div>

            <details open class="card" style="margin-top:12px;padding:12px">
              <summary style="font-weight:900;cursor:pointer">Converter</summary>
              <div class="note" style="margin-top:6px">Enter any unit and get all three. (1 ft·lb = 12 in·lb)</div>

              <div class="row" style="margin-top:10px">
                <label style="flex:1">
                  <div class="note">Input</div>
                  <input id="tInVal" class="input" type="number" inputmode="decimal" value="100">
                </label>
                <label style="min-width:140px">
                  <div class="note">Unit</div>
                  <select id="tInUnit" class="input">
                    <option value="nm">N·m</option>
                    <option value="ftlb">ft·lb</option>
                    <option value="inlb">in·lb</option>
                  </select>
                </label>
              </div>

              <div class="row" style="margin-top:10px">
                <div class="card" style="flex:1">
                  <div class="note">N·m</div>
                  <div class="big" id="tOutNm">—</div>
                </div>
                <div class="card" style="flex:1">
                  <div class="note">ft·lb</div>
                  <div class="big" id="tOutFt">—</div>
                </div>
                <div class="card" style="flex:1">
                  <div class="note">in·lb</div>
                  <div class="big" id="tOutIn">—</div>
                </div>
              </div>

              <div class="note" style="margin-top:10px">
                Tip: use decimals freely. Example: <span class="kbd">74</span> ft·lb → N·m.
              </div>
            </details>

            <details open class="card" style="margin-top:12px;padding:12px">
              <summary style="font-weight:900;cursor:pointer">Dry vs lubed guidance</summary>
              <div class="note" style="margin-top:6px">Why it matters: lubrication changes friction, which changes clamp load for the <i>same torque</i>.</div>

              <div class="row" style="gap:12px;flex-wrap:wrap;margin-top:10px">
                <label class="pill"><input type="radio" name="tCond" value="dry" checked> Dry</label>
                <label class="pill"><input type="radio" name="tCond" value="lube"> Lubed</label>
                <label class="pill"><input type="radio" name="tCond" value="tl"> Threadlocker</label>
              </div>

              <div class="card" style="margin-top:10px">
                <div class="note">Rule of thumb (not a spec)</div>
                <div id="tGuidance" style="margin-top:6px;line-height:1.35"></div>
              </div>

              <div class="note" style="margin-top:10px">
                Always follow the service manual torque spec when you have it. These notes help you avoid the classic “dry vs lubed” mistake.
              </div>
            </details>

            <details class="card" style="margin-top:12px;padding:12px">
              <summary style="font-weight:900;cursor:pointer">Spec note + copy plan</summary>
              <div class="note" style="margin-top:6px">Keep a quick note (saved) and copy a tightening plan to text/clipboard.</div>

              <div class="row" style="gap:10px;flex-wrap:wrap;margin-top:10px">
                <label style="flex:1;min-width:220px">
                  <div class="note">Spec note (saved)</div>
                  <input id="tSpecNote" class="input" type="text" placeholder="Example: wheel lugs, dry, per service manual">
                </label>
                <button class="btn" id="tCopyPlan" type="button">Copy plan</button>
              </div>
              <div class="note" style="margin-top:8px" id="tCopyMsg"></div>
            </details>

            <details class="card" style="margin-top:12px;padding:12px">
              <summary style="font-weight:900;cursor:pointer">Stage tracker (optional)</summary>
              <div class="note" style="margin-top:6px">Use for multi-step tightening: e.g., 30 → 60 → 90. Tap ○/✓ to mark a stage done.</div>

              <div class="row" style="justify-content:space-between;align-items:center;flex-wrap:wrap;margin-top:10px">
                <div class="note">Stages are for your process, not a spec.</div>
                <button class="btn" id="tAddStage" type="button">+ Stage</button>
              </div>

              <div id="tStages" class="stack" style="margin-top:10px"></div>
            </details>

            <details class="card" style="margin-top:12px;padding:12px">
              <summary style="font-weight:900;cursor:pointer">Clamp-load estimator (simple)</summary>
              <div class="note" style="margin-top:6px">
                Uses the shop formula <b>T = K · F · D</b> for estimates. Rearranged: <b>F = T / (K · D)</b>.
                <br><span class="note">T = torque, F = clamp load, D = nominal bolt diameter, K = “nut factor” (friction).</span>
              </div>

              <div class="note" style="margin-top:8px">
                Typical starting points (if you have no better guidance): Dry K≈0.20, Lubed K≈0.15, Threadlocker K≈0.17.
              </div>

              <div class="row" style="margin-top:10px">
                <label style="flex:1;min-width:240px">
                  <div class="note">Bolt size</div>
                  <select id="tBoltSize" class="input">
                    <option value="custom">Custom</option>
                    <optgroup label="Metric">
                      <option value="M6">M6</option>
                      <option value="M8">M8</option>
                      <option value="M10">M10</option>
                      <option value="M12">M12</option>
                      <option value="M14">M14</option>
                      <option value="M16">M16</option>
                    </optgroup>
                    <optgroup label="SAE">
                      <option value="1/4">1/4"</option>
                      <option value="5/16">5/16"</option>
                      <option value="3/8">3/8"</option>
                      <option value="7/16">7/16"</option>
                      <option value="1/2">1/2"</option>
                      <option value="9/16">9/16"</option>
                      <option value="5/8">5/8"</option>
                      <option value="3/4">3/4"</option>
                    </optgroup>
                  </select>
                </label>

                <label style="flex:1;min-width:180px">
                  <div class="note">Bolt diameter D</div>
                  <input id="tBoltDia" class="input" type="number" inputmode="decimal" value="12">
                </label>

                <label style="min-width:140px">
                  <div class="note">Dia unit</div>
                  <select id="tDiaUnit" class="input">
                    <option value="mm">mm</option>
                    <option value="in">in</option>
                  </select>
                </label>
              </div>

              <div class="row" style="margin-top:10px">
                <label style="flex:1;min-width:180px">
                  <div class="note">Nut factor K</div>
                  <input id="tK" class="input" type="number" inputmode="decimal" value="0.20" step="0.01">
                </label>

                <label style="flex:1;min-width:180px">
                  <div class="note">Clamp load F</div>
                  <input id="tF" class="input" type="number" inputmode="decimal" value="12000">
                </label>

                <label style="min-width:140px">
                  <div class="note">F unit</div>
                  <select id="tFUnit" class="input">
                    <option value="lbf">lbf</option>
                    <option value="N">N</option>
                  </select>
                </label>
              </div>

              <div class="row" style="margin-top:10px">
                <label style="flex:1;min-width:220px">
                  <div class="note">Torque T (output)</div>
                  <div class="card" id="tClampOut" style="padding:10px">—</div>
                </label>

                <label style="min-width:200px">
                  <div class="note">Mode</div>
                  <select id="tClampMode" class="input">
                    <option value="t_from_f">Torque from clamp load</option>
                    <option value="f_from_t">Clamp load from torque</option>
                  </select>
                </label>

                <label style="flex:1;min-width:180px">
                  <div class="note">Torque input (for F from T)</div>
                  <input id="tTIn" class="input" type="number" inputmode="decimal" value="100">
                </label>

                <label style="min-width:140px">
                  <div class="note">T unit</div>
                  <select id="tTUnit" class="input">
                    <option value="nm">N·m</option>
                    <option value="ftlb">ft·lb</option>
                    <option value="inlb">in·lb</option>
                  </select>
                </label>
              </div>

              <div class="note" style="margin-top:10px">This estimator is intentionally simple. If you want the “real” version later: we’ll add thread pitch + stress area + proof load presets.</div>
            </details>
          </section>`;

        const NM_PER_FTLB = 1.3558179483314004;
        const NM_PER_INLB = 0.1129848290276167;

        const TORQUE_STORE_KEY = 'legendcalc.torque.v1';
        function loadTorqueState(){
          try{ return JSON.parse(localStorage.getItem(TORQUE_STORE_KEY)||'{}') || {}; }catch(_){ return {}; }
        }
        function saveTorqueState(patch){
          const cur = loadTorqueState();
          const next = Object.assign({}, cur, patch);
          try{ localStorage.setItem(TORQUE_STORE_KEY, JSON.stringify(next)); }catch(_){}
          return next;
        }
        function setCopyMsg(msg){
          const el = $('#tCopyMsg');
          if(!el) return;
          el.textContent = msg || '';
          if(msg){
            setTimeout(()=>{ try{ if(el.textContent===msg) el.textContent=''; }catch(_){ } }, 1600);
          }
        }


        function toNm(val, unit){
          const v = Number(val);
          if(!Number.isFinite(v)) return NaN;
          if(unit==='nm') return v;
          if(unit==='ftlb') return v*NM_PER_FTLB;
          if(unit==='inlb') return v*NM_PER_INLB;
          return NaN;
        }
        function fmt(x){
          if(!Number.isFinite(x)) return '—';
          const a=Math.abs(x);
          const d = a>=100 ? 1 : (a>=10 ? 2 : 3);
          return x.toFixed(d);
        }
        function update(){
          const nm = toNm($('#tInVal').value, $('#tInUnit').value);
          $('#tOutNm').textContent = fmt(nm);
          $('#tOutFt').textContent = fmt(nm / NM_PER_FTLB);
          $('#tOutIn').textContent = fmt(nm / NM_PER_INLB);
        }

        function updateGuidance(){
          const cond = $$('input[name="tCond"]:checked')[0]?.value || 'dry';
          const box = $('#tGuidance');
          if(cond==='dry'){
            box.innerHTML = `Dry threads: use the published torque spec as-is. If you cleaned threads with brake-clean, you're likely in this category.`;
          }else if(cond==='lube'){
            box.innerHTML = `Lubed threads: torque can land higher clamp-load for the same torque. Many manuals call out a different spec when oiled. If no spec is given, be cautious — typical reductions can be ~10–25% depending on fastener and lube.`;
          }else{
            box.innerHTML = `Threadlocker: treat it like a lubricant during tightening (it reduces friction while wet). If a spec calls out threadlocker, follow it. If not, don't “add extra torque” as compensation.`;
          }
        }

        
        // restore saved spec note
        const savedT = loadTorqueState();
        const noteEl = $('#tSpecNote');
        if(noteEl){
          noteEl.value = savedT.specNote || '';
          noteEl.addEventListener('input', ()=> saveTorqueState({specNote: noteEl.value}));
        }


        // Clamp-load estimator (T = K * F * D)
        const LBF_TO_N = 4.4482216152605;
        const IN_TO_M = 0.0254;
        const MM_TO_M = 0.001;

        const K_BY_COND = { dry: 0.20, lube: 0.15, lock: 0.17 };
        function getCond(){
          return ($$('input[name="tCond"]:checked')[0]?.value) || 'dry';
        }
        function nmToUnit(nm, unit){
          const v = Number(nm);
          if(!Number.isFinite(v)) return NaN;
          if(unit==='nm') return v;
          if(unit==='ftlb') return v / NM_PER_FTLB;
          if(unit==='inlb') return v / NM_PER_INLB;
          return NaN;
        }
        function diaToM(val, unit){
          const v = Number(val);
          if(!Number.isFinite(v) || v<=0) return NaN;
          if(unit==='mm') return v * MM_TO_M;
          return v * IN_TO_M; // inches default
        }
        function forceToN(val, unit){
          const v = Number(val);
          if(!Number.isFinite(v) || v<=0) return NaN;
          if(unit==='n') return v;
          return v * LBF_TO_N; // lbf default
        }
        function nToUnit(n, unit){
          const v = Number(n);
          if(!Number.isFinite(v)) return NaN;
          if(unit==='n') return v;
          return v / LBF_TO_N;
        }

        function syncKFromCond(){
          const kEl = $('#tK');
          const auto = $('#tKAuto');
          if(!kEl || !auto || !auto.checked) return;
          const cond = getCond();
          const k = (cond==='lube') ? K_BY_COND.lube : (cond==='lock' ? K_BY_COND.lock : K_BY_COND.dry);
          // only overwrite if blank or previously auto-set
          if(!kEl.value || kEl.dataset.auto==='1'){
            kEl.value = String(k);
            kEl.dataset.auto = '1';
          }
        }

        function clampEstimatorUpdate(){
          const modeEl = $('#tEstMode');
          const kEl = $('#tK');
          const dEl = $('#tBoltDia');
          const duEl = $('#tBoltDiaUnit');
          const fEl = $('#tClampVal');
          const fuEl = $('#tClampUnit');
          const tEl = $('#tEstTVal');
          const tuEl = $('#tEstTUnit');

          const outT = $('#tEstTorqueOut');
          const outT2 = $('#tEstTorqueOut2');
          const outF = $('#tEstClampOut');
          const outF2 = $('#tEstClampOut2');

          if(!modeEl || !kEl || !dEl || !duEl || !fEl || !fuEl || !tEl || !tuEl || !outT || !outT2 || !outF || !outF2) return;

          // mode UI
          const mode = modeEl.value || 'torque';
          const torqueMode = (mode === 'torque');
          fEl.disabled = !torqueMode;
          fuEl.disabled = !torqueMode;
          tEl.disabled = torqueMode;
          tuEl.disabled = torqueMode;

          const K = Number(kEl.value);
          const Dm = diaToM(dEl.value, duEl.value);
          if(!Number.isFinite(K) || K<=0 || !Number.isFinite(Dm)){
            outT.textContent = '—';
            outT2.textContent = 'Enter diameter + K';
            outF.textContent = '—';
            outF2.textContent = '—';
            return;
          }

          let F_N = NaN;
          let T_Nm = NaN;

          if(torqueMode){
            F_N = forceToN(fEl.value, fuEl.value);
            if(Number.isFinite(F_N)) T_Nm = K * F_N * Dm;
          }else{
            T_Nm = toNm(tEl.value, tuEl.value);
            if(Number.isFinite(T_Nm)) F_N = T_Nm / (K * Dm);
          }

          if(Number.isFinite(T_Nm)){
            const ft = nmToUnit(T_Nm, 'ftlb');
            const inch = nmToUnit(T_Nm, 'inlb');
            outT.textContent = `${fmt(ft)} ft·lb`;
            outT2.textContent = `${fmt(T_Nm)} N·m  •  ${fmt(inch)} in·lb`;
          }else{
            outT.textContent = '—';
            outT2.textContent = torqueMode ? 'Enter clamp load' : 'Enter torque';
          }

          if(Number.isFinite(F_N)){
            const lbf = nToUnit(F_N, 'lbf');
            outF.textContent = `${(Number.isFinite(lbf)? lbf.toFixed(0) : '—')} lbf`;
            outF2.textContent = `${(Number.isFinite(F_N)? F_N.toFixed(0) : '—')} N`;
          }else{
            outF.textContent = '—';
            outF2.textContent = '—';
          }

          // persist estimator inputs
          saveTorqueState({
            boltSize: ($('#tBoltSize')?.value || 'custom'),
            boltDia: dEl.value,
            boltDiaUnit: duEl.value,
            k: kEl.value,
            kAuto: !!($('#tKAuto')?.checked),
            estMode: modeEl.value,
            clampVal: fEl.value,
            clampUnit: fuEl.value,
            estTVal: tEl.value,
            estTUnit: tuEl.value
          });
        }

function stageRow(nmValue='30', unit='nm'){
          const row=document.createElement('div');
          row.className='card';
          row.style.display='flex';
          row.style.gap='10px';
          row.style.alignItems='center';
          row.style.flexWrap='wrap';

          const done=document.createElement('button');
          done.type='button';
          done.className='btn';
          done.textContent='○';
          done.title='Toggle done';

          const name=document.createElement('input');
          name.className='input';
          name.placeholder='Stage name (optional)';
          name.style.flex='1';
          name.style.minWidth='160px';

          const val=document.createElement('input');
          val.className='input';
          val.type='number';
          val.inputMode='decimal';
          val.value=nmValue;
          val.style.width='120px';

          const sel=document.createElement('select');
          sel.className='input';
          sel.style.width='120px';
          sel.innerHTML = `<option value="nm">N·m</option><option value="ftlb">ft·lb</option><option value="inlb">in·lb</option>`;
          sel.value=unit;

          const out=document.createElement('div');
          out.className='note';
          out.style.flex='1';
          out.style.minWidth='180px';

          const del=document.createElement('button');
          del.type='button';
          del.className='fxdel';
          del.textContent='×';
          del.title='Remove stage';

          function recompute(){
            const nm = toNm(val.value, sel.value);
            if(!Number.isFinite(nm)) { out.textContent='—'; return; }
            out.textContent = `${fmt(nm)} N·m  •  ${fmt(nm/NM_PER_FTLB)} ft·lb  •  ${fmt(nm/NM_PER_INLB)} in·lb`;
          }

          done.addEventListener('click', ()=>{
            const on = row.dataset.done==='1';
            row.dataset.done = on ? '0' : '1';
            done.textContent = on ? '○' : '✓';
            row.style.opacity = on ? '1' : '.55';
          });
          del.addEventListener('click', ()=> row.remove());
          val.addEventListener('input', recompute);
          sel.addEventListener('change', recompute);

          row.appendChild(done);
          row.appendChild(name);
          row.appendChild(val);
          row.appendChild(sel);
          row.appendChild(out);
          row.appendChild(del);
          recompute();
          return row;
        }

        $('#tInVal').addEventListener('input', update);
        $('#tInUnit').addEventListener('change', update);
        $$('input[name="tCond"]').forEach(r=>r.addEventListener('change', updateGuidance));


        $('#tCopyPlan').addEventListener('click', async ()=>{
          try{
            const cond = $$('input[name="tCond"]:checked')[0]?.value || 'dry';
            const condLabel = (cond==='dry'?'Dry':(cond==='lube'?'Lubed':'Threadlocker'));
            const inVal = $('#tInVal').value;
            const inUnit = $('#tInUnit').value;
            const nm = toNm(inVal, inUnit);
            const line1 = `Torque plan (${condLabel})`;
            const line2 = `Input: ${inVal} ${inUnit==='nm'?'N·m':(inUnit==='ftlb'?'ft·lb':'in·lb')}  →  ${fmt(nm)} N·m`;
            const note = ($('#tSpecNote')?.value||'').trim();
            const stages = Array.from($('#tStages')?.children||[]).map((row,idx)=>{
              const done = row.dataset.done==='1';
              const btn = row.querySelector('button.btn');
              const mark = done ? '✓' : '○';
              const val = row.querySelector('input[type="number"]')?.value || '';
              const sel = row.querySelector('select')?.value || 'nm';
              const u = sel==='nm'?'N·m':(sel==='ftlb'?'ft·lb':'in·lb');
              const nmv = toNm(val, sel);
              return `${mark} Stage ${idx+1}: ${val} ${u}  (${fmt(nmv)} N·m)`;
            });
            const out = [line1, line2, '', 'Stages:', ...stages];
            if(note) out.push('', `Note: ${note}`);
            const text = out.join('\n');

            if(navigator.clipboard && navigator.clipboard.writeText){
              await navigator.clipboard.writeText(text);
              setCopyMsg('Copied.');
            }else{
              // fallback: prompt
              window.prompt('Copy this:', text);
            }
          }catch(e){
            setCopyMsg('Copy failed.');
            try{ logErr(e); }catch(_){}
          }
        });

        $('#tAddStage').addEventListener('click', ()=>{
          $('#tStages').appendChild(stageRow());
        });

        // seed with 3 common stages
        const stageBox = $('#tStages');
        stageBox.appendChild(stageRow('30','nm'));
        stageBox.appendChild(stageRow('60','nm'));
        stageBox.appendChild(stageRow('90','nm'));


        // restore estimator state
        (function initClampEstimator(){
          const st = loadTorqueState();

          const sizeEl = $('#tBoltSize');
          const dEl = $('#tBoltDia');
          const duEl = $('#tBoltDiaUnit');

          const BOLT_SIZES = {
            'M6':  {v: 6,   u:'mm'},
            'M8':  {v: 8,   u:'mm'},
            'M10': {v: 10,  u:'mm'},
            'M12': {v: 12,  u:'mm'},
            'M14': {v: 14,  u:'mm'},
            'M16': {v: 16,  u:'mm'},
            '1/4': {v: 0.25,   u:'in'},
            '5/16':{v: 0.3125, u:'in'},
            '3/8': {v: 0.375,  u:'in'},
            '7/16':{v: 0.4375, u:'in'},
            '1/2': {v: 0.5,    u:'in'},
            '9/16':{v: 0.5625, u:'in'},
            '5/8': {v: 0.625,  u:'in'},
            '3/4': {v: 0.75,   u:'in'}
          };

          function applyBoltSize(key, shouldPersist=true){
            if(!dEl || !duEl) return;
            const rec = BOLT_SIZES[key];
            if(!rec) return;
            duEl.value = rec.u;
            dEl.value = String(rec.v);
            if(shouldPersist){
              try{ saveTorqueState({ boltSize: key, boltDia: dEl.value, boltDiaUnit: duEl.value }); }catch(_){ }
            }
          }

          if(sizeEl){
            const savedSize = st.boltSize || 'custom';
            sizeEl.value = savedSize;
            if(savedSize !== 'custom') applyBoltSize(savedSize, false);
            sizeEl.addEventListener('change', ()=>{
              const key = sizeEl.value || 'custom';
              if(key === 'custom'){
                try{ saveTorqueState({ boltSize: 'custom' }); }catch(_){ }
              }else{
                applyBoltSize(key, true);
              }
              clampEstimatorUpdate();
            });
          }
          if(dEl && st.boltDia!=null && (!st.boltSize || st.boltSize==='custom')) dEl.value = st.boltDia;
          if(duEl && st.boltDiaUnit && (!st.boltSize || st.boltSize==='custom')) duEl.value = st.boltDiaUnit;
          const kEl = $('#tK'); if(kEl && st.k!=null) { kEl.value = st.k; kEl.dataset.auto = (st.kAuto ? '1':'0'); }
          const autoEl = $('#tKAuto'); if(autoEl && st.kAuto!=null) autoEl.checked = !!st.kAuto;
          const mEl = $('#tEstMode'); if(mEl && st.estMode) mEl.value = st.estMode;
          const fEl = $('#tClampVal'); if(fEl && st.clampVal!=null) fEl.value = st.clampVal;
          const fuEl = $('#tClampUnit'); if(fuEl && st.clampUnit) fuEl.value = st.clampUnit;
          const tEl = $('#tEstTVal'); if(tEl && st.estTVal!=null) tEl.value = st.estTVal;
          const tuEl = $('#tEstTUnit'); if(tuEl && st.estTUnit) tuEl.value = st.estTUnit;

          // default values if empty
          if(duEl && !duEl.value) duEl.value = 'in';
          if(fuEl && !fuEl.value) fuEl.value = 'lbf';
          if(tuEl && !tuEl.value) tuEl.value = 'ftlb';

          // wire listeners (guarded)
          const onAny = (el, evt)=>{ try{ el && el.addEventListener(evt, clampEstimatorUpdate); }catch(_){ } };
          ['input','change'].forEach(evt=>{
            onAny(dEl, evt); onAny(duEl, evt); onAny($('#tClampVal'), evt); onAny($('#tClampUnit'), evt);
            onAny($('#tEstTVal'), evt); onAny($('#tEstTUnit'), evt); onAny($('#tEstMode'), evt);
          });

          // K handling
          if(kEl){
            kEl.addEventListener('input', ()=>{ kEl.dataset.auto='0'; clampEstimatorUpdate(); });
          }
          if(autoEl){
            autoEl.addEventListener('change', ()=>{ if(autoEl.checked){ if(kEl) kEl.dataset.auto='1'; syncKFromCond(); } clampEstimatorUpdate(); });
          }

          // keep K synced to condition when auto is on
          $$('input[name="tCond"]').forEach(r=>r.addEventListener('change', ()=>{ syncKFromCond(); clampEstimatorUpdate(); }));

          // seed K from condition if auto and empty
          syncKFromCond();
          clampEstimatorUpdate();
        })();

        update();
        updateGuidance();
      }




      /* ---------- Unit Converter ---------- */
      function renderUnits(){
        const view=$('#view');
        view.innerHTML=`
          <section class="surface">
            <div class="row">
              <label><div class="note">Value</div><input id="uVal" class="input" type="number" value="1"></label>
              <label><div class="note">From</div>
                <select id="uFromSel" class="input"></select>
              </label>
              <label><div class="note">To</div>
                <select id="uTo" class="input"></select>
              </label>
            </div>
            <div class="row">
              <label><div class="note">Search units</div><input id="uSearch" class="input" placeholder="type to filter (e.g., psi, km, kWh)"></label>
              <div class="btnbar" style="display:flex;align-items:end;gap:8px">
                <button class="btn" id="uSwap">⇄ Swap</button>
                <button class="btn primary" id="uConvert">Convert</button>
                <button class="btn" id="uSmart">Smart Suggest</button>
                <button class="btn" id="clearSavedUnits" title="Forget saved inputs">Clear Saved</button>
              </div>
            </div>
            <div id="uOut" class="section-title"></div>
            <div class="note">Dropdown uses categories; only compatible targets are shown. Search filters both lists. "Smart Suggest" picks a human-friendly unit. No miles → cups.</div>
          </section>`;

        function maybeLive(){ try{ if($('#liveTyping')?.checked || $('#autoPlot')?.checked) schedulePlot(); }catch(_){ } }


        const toSel=$('#uTo');
        const fromSel=$('#uFromSel');
        const searchEl=$('#uSearch');
        const setOut = (html)=>{ $('#uOut').innerHTML = html; };

        const catalogByGroup = unitGroups();
        const catalogByDim = unitCatalogByDim(catalogByGroup);
        let currentFromList=[];

        function populateFrom(filter=''){
          const q=filter.trim().toLowerCase();
          fromSel.innerHTML = Object.entries(catalogByGroup)
            .map(([group, units])=>{
              const items=units.filter(u=>u.toLowerCase().includes(q));
              if(!items.length) return '';
              return `<optgroup label="${group}">${items.map(u=>`<option value="${u}">${u}</option>`).join('')}</optgroup>`;
            }).join('');
        }

        const saved = loadTab('units', {val:'1', from:'m', to:'km', out:'', search:''});
        populateFrom(saved.search||'');
        fromSel.value = saved.from || 'm';
        $('#uVal').value = saved.val || '1';
        searchEl.value = saved.search || '';

        function persist(){ const state={ val:$('#uVal').value, from:fromSel.value, to:$('#uTo').value, out:$('#uOut').innerHTML, search:searchEl.value }; saveTab('units', state); }

        function refreshTargets(){
          const from = fromSel.value.trim();
          try{
            const u = math.unit(1, from);
            const dimKey = JSON.stringify(u.dimensions);
            currentFromList = (catalogByDim[dimKey]||[]).sort();
            toSel.innerHTML = currentFromList.map(x=>`<option value="${x}">${x}</option>`).join('');
            if(!currentFromList.length){ toSel.innerHTML='<option>(no compatible units)</option>'; }
          }catch(e){ toSel.innerHTML='<option>(invalid unit)</option>'; currentFromList=[]; }
        }

        function smartSuggest(){
          const v = parseFloat($('#uVal').value); const from = fromSel.value.trim();
          try{
            const q=math.unit(v,from);
            const dimKey = JSON.stringify(q.dimensions);
            const list = (catalogByDim[dimKey]||[]);
            if(!list.length) return setOut('(no match)');
            let best = from; let bestDelta = 1e9;
            for(const cand of list){ const conv = q.to(cand).toNumber(cand); const d = score(conv); if(d<bestDelta){ best=cand; bestDelta=d; } }
            toSel.value = best; convert();
          }catch(e){ setOut('Invalid'); }
        }

        function convert(){
          const v=parseFloat($('#uVal').value); const from=fromSel.value.trim(); const to=toSel.value;
          try{ const out = math.unit(v,from).to(to); const num = out.toNumber(to); const txt = `${v} ${from} = <b>${format(num)}</b> ${to}`; setOut(txt); return txt; }
          catch(e){ setOut('<span class="err">Incompatible or invalid units</span>'); }
        }

        function score(x){ const ax=Math.abs(x); if(ax===0) return 0; const k=Math.log10(ax); return Math.abs(k-1.5); }
        function format(x){ const a=Math.abs(x); if(a>=1e6||a<1e-3) return x.toExponential(6); return (+x.toPrecision(12)).toString(); }

        function unitGroups(){
          return {
            Length:['mm','cm','m','km','in','ft','yd','mi','nmi'],
            Mass:['mg','g','kg','lb','oz'],
            Time:['ms','s','min','hour','day'],
            Area:['mm^2','cm^2','m^2','km^2','in^2','ft^2','yd^2','acre','ha'],
            Volume:['mL','L','cm^3','m^3','in^3','ft^3','gal','qt','pt','cup','tbsp','tsp'],
            Speed:['m/s','km/h','mph','ft/s','kt'],
            Acceleration:['m/s^2','ft/s^2','g'],
            Force:['N','lbf','kip'],
            Energy:['J','kJ','cal','kcal','Wh','kWh','BTU'],
            Power:['W','kW','hp','BTU/h'],
            Pressure:['Pa','kPa','bar','psi','inHg','mmHg','atm'],
            Temperature:['degC','degF','K','degR'],
            Density:['kg/m^3','g/cm^3','lb/ft^3'],
            Torque:['N m','lbf ft']
          };
        }
        function unitCatalogByDim(groups){ const map={}; for(const arr of Object.values(groups)){ for(const u of arr){ try{ const dim = JSON.stringify(math.unit(1,u).dimensions); if(!map[dim]) map[dim]=new Set(); arr.forEach(x=>map[dim].add(x)); }catch(e){} } } for(const d in map){ map[d]=[...map[d]]; } return map; }

        fromSel.addEventListener('change', ()=>{ refreshTargets(); smartSuggest(); persist(); });
        $('#uVal').addEventListener('input', ()=> { smartSuggest(); persist(); });
        $('#uSmart').onclick = ()=>{ smartSuggest(); persist(); };
        $('#uConvert').onclick = ()=>{ convert(); persist(); };
        $('#clearSavedUnits').onclick = ()=>{ clearTab('units'); $('#uVal').value='1'; searchEl.value=''; populateFrom(''); fromSel.value='m'; refreshTargets(); smartSuggest(); };
        $('#uSwap').onclick = ()=>{ const f=fromSel.value; const t=toSel.value;
          if(currentFromList.includes(f) && currentFromList.includes(t)) { fromSel.value=t; refreshTargets(); toSel.value=f; smartSuggest(); persist(); } else {
            const temp=f; fromSel.value=t; refreshTargets(); toSel.value=temp; smartSuggest(); persist(); }
        };
        searchEl.addEventListener('input', ()=>{ populateFrom(searchEl.value);
          if(![...fromSel.options].some(o=>o.value===saved.from)) fromSel.selectedIndex=0; refreshTargets(); smartSuggest(); persist(); });

        refreshTargets();
        if(saved.to){ try{ const u = math.unit(1, fromSel.value); const dimKey=JSON.stringify(u.dimensions); const list=(catalogByDim[dimKey]||[]); if(list.includes(saved.to)) $('#uTo').value=saved.to; }catch(e){} }
        if(saved.out){ setOut(saved.out); } else { smartSuggest(); }
      }

     function renderTime(){
        const view=$('#view');
        const PREFS = loadPrefs();
        const time12 = !!PREFS.time12;
        const ocuPref = (typeof PREFS.ocuMode === 'boolean') ? (PREFS.ocuMode ? '7a7p' : 'off') : (PREFS.ocuMode || 'off');

        view.innerHTML=`
          <section class="surface">
            <div class="row">
              <label><div class="note">Goal hours today</div><input id="goalH" class="input" type="number" step="0.25" value="8"></label>
              <label><div class="note">Paid lunch</div>
                <select id="paidL" class="input">
                  <option value="0">Unpaid</option>
                  <option value="0.3333333">20 min paid</option>
                  <option value="0.5">30 min paid</option>
                  <option value="1">1 hour paid</option>
                </select>
              </label>
              <label><div class="note">🕒 Time format</div>
                <select id="timeFmt" class="input">
                  <option value="24">24-hour</option>
                  <option value="12">12-hour (AM/PM)</option>
                </select>
              </label>
              <label><div class="note">🏷️ OCU rounding</div>
                <select id="ocuMode" class="input"></select>
              </label>
            </div>

            <div class="section-title">Custom OCU preset</div>
            <div class="row">
              <label><div class="note">Name</div><input id="ocuName" class="input" placeholder="e.g., My 5a–1p"></label>
              <label><div class="note">IN time</div><input id="ocuIn" class="input" type="time" value="07:00"></label>
              <label><div class="note">OUT time</div><input id="ocuOut" class="input" type="time" value="19:00"></label>
              <label><div class="note">Window ± (min)</div><input id="ocuWin" class="input" type="number" value="10"></label>
              <div style="display:flex;align-items:end"><button class="btn" id="saveOcu">Save preset</button></div>
            </div>

            <div class="section-title">Shifts</div>
            <div id="rows"></div>
            <div class="btnbar" style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap"><button class="btn primary" id="addRow">+ Add Interval</button><button class="btn" id="nowIn">Clock In Now</button><button class="btn" id="nowOut">Clock Out Now</button><button class="btn" id="clearSavedTime" title="Forget saved inputs">Clear Saved</button></div>

            <div class="two-col" style="margin-top:16px">
              <div class="surface">
                <div class="section-title">Today Summary</div>
                <div id="todayOut"></div>
                 <div class="hr"></div>
                 
                 <div class="hr"></div>
                 <div class="section-title">Shift planner</div>
                 <div class="note">Enter your times (manual). We’ll tell you how long you still need and what time to clock out.</div>

                 <div class="row" style="gap:10px;flex-wrap:wrap;margin-top:10px">
                   <label style="min-width:180px">
                     <div class="note">Target (h)</div>
                     <input id="spTarget" class="input" type="number" step="0.25" value="12">
                     <div class="row" style="gap:8px;margin-top:8px;flex-wrap:wrap">
                       <button class="btn" id="sp12" type="button">12h</button>
                       <button class="btn" id="sp36" type="button">36h</button>
                       <button class="btn" id="sp40" type="button">40h</button>
                     </div>
                   </label>

                   <label><div class="note">Clock IN</div><input id="spIn1" class="input" type="time"></label>
                   <label><div class="note">Break OUT (optional)</div><input id="spOut1" class="input" type="time"></label>
                   <label><div class="note">Back IN (optional)</div><input id="spIn2" class="input" type="time"></label>
                 </div>

                 <div id="spOut" class="note" style="margin-top:10px"></div>
          
          
              </div>
              <div class="surface">
                <div class="section-title">Guidance</div>
                <div id="guide"></div>
              </div>
            </div>

            <div class="surface" style="margin-top:16px">
              <div class="section-title">Week Summary (by date)</div>
              <div id="week"></div>
            </div>
          </section>`;

        function maybeLive(){ try{ if($('#liveTyping')?.checked || $('#autoPlot')?.checked) schedulePlot(); }catch(_){ } }


        const rowsEl=$('#rows');
        const fmtSel=$('#timeFmt');
        const ocuSel=$('#ocuMode');

        const builtIns=[
          {id:'off', label:'Off'},
          {id:'7a7p', label:'7a/7p ±10m', inTarget:7*60, outTarget:19*60, win:10},
          {id:'6a4p', label:'6a/4p ±10m', inTarget:6*60, outTarget:16*60, win:10},
          {id:'7a3p', label:'7a/3p ±10m', inTarget:7*60, outTarget:15*60, win:10},
        ];
        function renderOcuOptions(){
          const PREFS=loadPrefs();
          const customs = Array.isArray(PREFS.ocuCustoms)? PREFS.ocuCustoms : [];
          const customOpts = customs.map((c,i)=>`<option value="custom:${i}">${esc(c.name)} (${minutesToClock(c.inTarget)}–${minutesToClock(c.outTarget)} ±${c.win}m)</option>`).join('');
          ocuSel.innerHTML = builtIns.map(b=>`<option value="${b.id}">${b.label}</option>`).join('') + (customOpts? `<optgroup label="Custom">${customOpts}</optgroup>`:'');
          ocuSel.value = (PREFS.ocuMode ?? 'off');
        }
        renderOcuOptions();

        fmtSel.value = time12 ? '12' : '24';

        const todayStr = toLocalDate(new Date());
        const saved = loadTab('time', {goalH:'8', paidL:'0', spTarget:'12', spIn1:'', spOut1:'', spIn2:'', rows:[{date:todayStr,in:'',out:''}]});
        $('#goalH').value = saved.goalH || '8';
        $('#paidL').value = saved.paidL || '0';
        // Shift planner
        $('#spTarget').value = saved.spTarget || '12';
        $('#spIn1').value = saved.spIn1 || '';
        $('#spOut1').value = saved.spOut1 || '';
        $('#spIn2').value = saved.spIn2 || '';



        rowsEl.addEventListener('input', ()=>{ recompute(); persist(); });
        rowsEl.addEventListener('click', e=>{
          const id=e.target.getAttribute('data-del');
          if(id){ const row=e.target.closest('.row'); if(row) row.remove(); recompute(); persist(); }
        });

        fmtSel.addEventListener('change',()=>{ savePrefs({...loadPrefs(), time12: ($('#timeFmt').value==='12')}); recompute(); });
        ocuSel.addEventListener('change',()=>{ savePrefs({...loadPrefs(), ocuMode: ($('#ocuMode').value)}); recompute(); });

        $('#saveOcu').onclick=()=>{
          const name=$('#ocuName').value.trim()||'Custom'; const i=$('#ocuIn').value, o=$('#ocuOut').value, w=parseInt($('#ocuWin').value||'10',10);
          if(!i||!o||Number.isNaN(w)) return alert('Fill name, in, out, window');
          const entry={name, inTarget:toMin(i), outTarget:toMin(o), win:Math.max(0,Math.min(60,w))};
          const prefs=loadPrefs(); const arr=Array.isArray(prefs.ocuCustoms)? prefs.ocuCustoms:[]; arr.push(entry); prefs.ocuCustoms=arr; savePrefs(prefs);
          renderOcuOptions(); $('#ocuMode').value=`custom:${arr.length-1}`; savePrefs({...loadPrefs(), ocuMode:$('#ocuMode').value}); recompute();
        };

        $('#clearSavedTime').onclick=()=>{ clearTab('time'); rowsEl.innerHTML=''; addRow(); recompute(); };

        function persist(){
          const rows = $$('input[data-in]').map(inp=>{
            const id=inp.getAttribute('data-in'); const out=$(`input[data-out="${id}"]`); const date=$(`input[data-date="${id}"]`);
            return {date: (date&&date.value)||todayStr, in: inp.value||'', out: (out&&out.value)||''};
          });
          saveTab('time', {goalH:$('#goalH').value||'8', paidL:$('#paidL').value||'0', spTarget:$('#spTarget').value||'12', spIn1:$('#spIn1').value||'', spOut1:$('#spOut1').value||'', spIn2:$('#spIn2').value||'', rows});
        }

        function addRow(initial){
          const id=Math.random().toString(36).slice(2,7);
          const row=document.createElement('div');
          row.className='row';
          row.innerHTML=`
            <label><div class="note">Date</div><input class="input" type="date" data-date="${id}"></label>
            <label><div class="note">In</div><input class="input" type="time" data-in="${id}"></label>
            <label><div class="note">Out</div><input class="input" type="time" data-out="${id}"></label>
            <div style="display:flex;align-items:end"><button class="btn" data-del="${id}">Delete</button></div>`;
          rowsEl.appendChild(row);
          const dEl=$(`[data-date="${id}"]`), ins=$(`[data-in="${id}"]`), outs=$(`[data-out="${id}"]`);
          dEl.value = (initial&&initial.date) || toLocalDate(new Date());
          if(initial){ ins.value=initial.in||''; outs.value=initial.out||''; }
        }

        function recompute(){
          const prefs = loadPrefs();
          const use12 = !!prefs.time12;
          const mode = (typeof prefs.ocuMode==='boolean') ? (prefs.ocuMode? '7a7p':'off') : (prefs.ocuMode||'off');
          const preset = getOcuPreset(mode);
          const paid = parseFloat($('#paidL').value)||0;

          const segs=[]; $$('input[data-in]').forEach(inp=>{
            const id=inp.getAttribute('data-in'); const o=$(`input[data-out="${id}"]`); const d=$(`input[data-date="${id}"]`);
            if(inp.value){ segs.push({date:(d&&d.value)||toLocalDate(new Date()), in:inp.value, out:o&&o.value||null}); }
          });

          const today = toLocalDate(new Date());
          let minutesClosed=0; let openIn=null; let openInRounded=null;
          segs.filter(s=>s.date===today).forEach(s=>{
            let i=toMin(s.in); if(preset) i = roundInToPreset(i, preset);
            if(s.out){ let o=toMin(s.out); if(preset) o = roundOutToPreset(o, preset); minutesClosed += Math.max(0,o-i); }
            else { openIn = toMin(s.in); openInRounded = preset? roundInToPreset(openIn, preset): openIn; }
          });

          const paidMin = paid*60;
          const goalH=parseFloat($('#goalH').value)||8; const goalMin=goalH*60;
          const workedMin = minutesClosed + paidMin + (openIn!==null ? 0 : 0);
          const remainingToGoal = clamp(goalMin - workedMin, 0, 24*60);

          let suggested='—';
          if(openIn!==null){
            const need = clamp(goalMin - (minutesClosed + paidMin), 0, 24*60);
            let outMin = (preset? openInRounded: openIn) + need;
            if(preset) outMin = roundOutToPreset(outMin, preset);
            suggested = formatClock(outMin, use12);
          }

          const inProgText = openIn!==null ? ` • In-progress from <b>${formatClock(preset?openInRounded:openIn, use12)}</b>` : '';
          $('#todayOut').innerHTML = `Worked: <b>${fmtH(minutesClosed + paidMin)}</b>${inProgText} • Remaining to goal: <b>${fmtH(remainingToGoal)}</b>`;
          $('#guide').innerHTML = openIn!==null
            ? `Clocked in since <b>${formatClock(preset?openInRounded:openIn, use12)}</b> — to hit <b>${goalH}h</b>, clock out at <b>${suggested}</b>${preset? ' <span class="note">(OCU rounding)</span>':''}.`
            : `Not currently clocked in for today.`;


          // Week summary
          const byDay=new Map();
          segs.forEach(s=>{
            let i=toMin(s.in); let o = s.out? toMin(s.out): null; if(preset){ i=roundInToPreset(i,preset); if(o!==null) o=roundOutToPreset(o,preset); }
            const mins = (o!==null? Math.max(0,o-i): 0);
            byDay.set(s.date, (byDay.get(s.date)||0)+mins);
          });
          const days = [...byDay.keys()].sort();
          const paidMinPerDay = paid*60;
          let weekHTML = `<table><thead><tr><th>Date</th><th>Worked</th><th>+ Paid Lunch</th><th>Total</th></tr></thead><tbody>`;
          let grand=0;
          days.forEach(d=>{ const w=byDay.get(d); const lunch = (w>0? paidMinPerDay:0); const tot=w+lunch; grand+=tot; weekHTML+=`<tr><td>${d}</td><td>${fmtH(w)}</td><td>${lunch?fmtH(lunch):'—'}</td><td><b>${fmtH(tot)}</b></td></tr>`; });
          weekHTML += `</tbody></table><div class="note">Grand total (listed days): <b>${fmtH(grand)}</b></div>`;
          $('#week').innerHTML = weekHTML;
        }

        function getOcuPreset(mode){
          const win=10;
          if(mode==='7a7p') return {inTarget:7*60, outTarget:19*60, win};
          if(mode==='6a4p') return {inTarget:6*60, outTarget:16*60, win};
          if(mode==='7a3p') return {inTarget:7*60, outTarget:15*60, win};
          if(mode && mode.startsWith('custom:')){
            const prefs=loadPrefs(); const customs=prefs.ocuCustoms||[]; const i=parseInt(mode.split(':')[1],10); const c=customs[i]; if(c) return c;
          }
          return null;
        }
        function withinWindow(min,target,win){ return Math.abs(min - target) <= win; }
        function roundInToPreset(min,p){ return withinWindow(min,p.inTarget,p.win)? p.inTarget : min; }
        function roundOutToPreset(min,p){ return withinWindow(min,p.outTarget,p.win)? p.outTarget : min; }

        function toMin(t){ const [h,m]=t.split(':').map(Number); return h*60+m; }
        function minutesToClock(min){ const m=((min%1440)+1440)%1440; const h=Math.floor(m/60); const mm=String(Math.round(m%60)).padStart(2,'0'); return `${h}:${mm}`; }
        function formatClock(min,use12){ const t=minutesToClock(min); if(!use12) return t; const [hh,mm]=t.split(':').map(Number); const ampm = hh>=12? 'PM':'AM'; const h12 = (hh%12)||12; return `${h12}:${String(mm).padStart(2,'0')} ${ampm}`; }
        function fmtH(min){ const h=Math.floor(min/60); const m=Math.round(min%60); return `${h}h ${String(m).padStart(2,'0')}m`; }


        function calcRowMin(tIn, tOut){
          const a = toMin(tIn);
          const b = toMin(tOut);
          if(a===null || b===null) return 0;
          let d = b - a;
          if(d < 0) d += 1440;
          return Math.max(0, d);
        }

        $('#addRow').onclick=()=>{ addRow(); persist(); };
        $('#nowIn').onclick=()=>{ const now=new Date(); addRow({date:toLocalDate(now), in: toLocalTime(now)}); persist(); };
        $('#nowOut').onclick=()=>{ const inputs=$$('input[data-out]'); const open=[...inputs].find(i=>!i.value); if(open){ open.value=toLocalTime(new Date()); recompute(); persist(); } };
        $('#goalH').addEventListener('input',()=>{ recompute(); persist(); });
        $('#paidL').addEventListener('change',()=>{ recompute(); persist(); });
        // Shift planner listeners
        function setSP(h){ $('#spTarget').value=String(h); toast(`Target: ${h}h`); recompute(); persist(); }
        $('#sp12')?.addEventListener('click', ()=>setSP(12));
        $('#sp36')?.addEventListener('click', ()=>setSP(36));
        $('#sp40')?.addEventListener('click', ()=>setSP(40));
        ;['spTarget','spIn1','spOut1','spIn2'].forEach(id=>{ $('#'+id)?.addEventListener('input', ()=>{ recompute(); persist(); }); });

        function setGoal(h){
          toast(`Target total: ${h}h`);
          recompute(); persist();
        }

        if(saved.rows && saved.rows.length){ saved.rows.forEach(r=>addRow(r)); } else { addRow(); }
        recompute();

        function toLocalTime(d){ const hh=String(d.getHours()).padStart(2,'0'); const mm=String(d.getMinutes()).padStart(2,'0'); return `${hh}:${mm}`; }
        function toLocalDate(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
      }
      /* ---------- Self-tests ---------- */
      function runSelfTests(){
        const results=[];
        const pass=(name)=>{ results.push(`<div class='pass'>✔ ${name}</div>`); };
        const fail=(name,msg)=>{ results.push(`<div class='fail'>✖ ${name} — ${msg||''}</div>`); };

        try{ const v=math.evaluate('2+2'); (v===4)?pass('Calc: 2+2=4'):fail('Calc: 2+2','got '+v); }catch(e){ fail('Calc basic',e.message); }
        try{ const d=window.math.derivative('x^2','x').toString(); const f=window.math.parse(d).compile(); const val=f.evaluate({x:3}); (Math.abs(val-6)<1e-9)?pass('Calculus: d/dx x^2 at x=3 = 6'):fail('Calculus derivative at point','got '+val); }catch(e){ fail('Calculus derivative',e.message); }
        try{ const q=math.unit(1600,'m').to('km').toNumber('km'); (Math.abs(q-1.6)<1e-12)?pass('Units: 1600 m → 1.6 km'):fail('Units convert','got '+q); }catch(e){ fail('Units convert',e.message); }
        try{ const dimMi = JSON.stringify(math.unit(1,'mi').dimensions); const dimCup = JSON.stringify(math.unit(1,'cup').dimensions); (dimMi!==dimCup)?pass('Units: miles not compatible with cups'):fail('Units: miles vs cups dimension check'); }catch(e){ fail('Units incompatibility check',e.message); }
        try{ const f=window.math.parse('(sin(x))/x').compile(); const lim=(()=>{const eps=1e-6; return (f.evaluate({x:0+eps})+f.evaluate({x:0-eps}))/2;})(); (Math.abs(lim-1)<1e-3)?pass('Limit: sin(x)/x → 1 at 0'):fail('Limit numeric','got '+lim); }catch(e){ fail('Limit numeric',e.message); }
        try{ const tape = [{e:'1+1',v:2},{e:'2*3',v:6}]; const str = tape.map(t=>`${t.e} = ${t.v}`).reverse().join('\n'); (str.includes('\n') && str.split('\n').length===2)?pass('Tape: newline join works'):fail('Tape join','got '+str); }catch(e){ fail('Tape join test',e.message); }
        try{ const cToF = math.unit(100, 'degC').to('degF').toNumber('degF'); (Math.abs(cToF - 212) < 1e-9) ? pass('Temp: 100°C → 212°F') : fail('Temp conversion','got '+cToF); }catch(e){ fail('Temp conversion test', e.message); }
        try{ const t24 = (function(){ const m=13*60+5; const h=Math.floor(m/60); const mm=String(m%60).padStart(2,'0'); return `${h}:${mm}`; })(); const t12 = (function(){ const m=13*60+5; const h=Math.floor(m/60); const mm=String(m%60).padStart(2,'0'); const ampm=h>=12?'PM':'AM'; const h12=(h%12)||12; return `${h12}:${mm} ${ampm}`; })(); (t24==='13:05' && t12==='1:05 PM') ? pass('Time format: 24h/12h formatting') : fail('Time format','24='+t24+', 12='+t12); }catch(e){ fail('Time format test', e.message); }

        document.getElementById('selfTests').innerHTML = `<div class='section-title'>Self-Tests</div>${results.join('')}`;
      }

      armAudioUnlock();
      initDebugUI();
      initSettingsUI();
      applyBigUI();
      applyOneHand();
      syncSettingsUI();
      syncSoundUI();

      /* ---------- Sound ---------- */
      function renderSound(){
        const view=$('#view');
        const mode=getSoundMode();
        view.innerHTML = `
          <section class="surface">
            <div class="section-title">Sound</div>
            <div class="grid">
              <div class="panel">
                <div class="section-title">Mode</div>
                <div class="row" style="gap:12px;flex-wrap:wrap">
                  <label class="pill"><input type="radio" name="soundMode" value="off"> Off</label>
                  <label class="pill"><input type="radio" name="soundMode" value="clicks"> Clicks</label>
                  <label class="pill"><input type="radio" name="soundMode" value="fanfare"> Fanfare</label>
                </div>
                <div class="hint" style="margin-top:10px">Tip: On iPhone, audio needs the first tap to “wake up.”</div>
              </div>

              <div class="panel">
                <div class="section-title">Test</div>
                <div class="row btnbar">
                  <button class="btn" id="testClick">Test Click</button>
                  <button class="btn" id="testFanfare">Test Fanfare</button>
                </div>
                <div class="hint" style="margin-top:10px">These are original “fantasy chimes” (inspired vibe, not copied).</div>
              </div>
            </div>
          </section>
        `;

        // Wire UI
        syncSoundUI();
        $$('input[name="soundMode"]').forEach(r=>{
          r.addEventListener('change', ()=> setSoundMode(r.value));
        });
        $('#testClick').addEventListener('click', ()=>{ ensureAudio(); beep(220,0.05,'square',0.02,0); toast('Click'); });
        $('#testFanfare').addEventListener('click', ()=>{ ensureAudio(); fanfareSound(); toast('Fanfare'); });
      }

      render('calc');
      runSelfTests();
    }
  })();
  

/* ---------- Touch feedback helpers ---------- */
(function(){
  // Some platforms support Vibration API; iOS Safari generally does NOT.
  function tryVibrate(ms){
    try{
      if (navigator && typeof navigator.vibrate === "function") navigator.vibrate(ms);
    }catch(_){}
  }

  // Subtle click using WebAudio (works broadly). Respects reduced motion.
  let audioCtx = null;
  
  // Global pointer feedback for on-screen buttons
  document.addEventListener("pointerdown", (e)=>{
    const btn = e.target.closest("button, input[type=\"button\"], input[type=\"submit\"], .tab, .key, .btn");
    if(!btn) return;
    tryVibrate(8);
        try{ if(window.__LC_clickSound) window.__LC_clickSound(); }catch(_){ }
  }, {passive:true});
})();

</script>
</body>
</html>
